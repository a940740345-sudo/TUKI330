<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=5.0, user-scalable=yes" />
    <title>EPhone AI Pro</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      /* --- æ ¸å¿ƒé…è‰² --- */
      :root { --bg-color: #fdfbf7; --text-deep: #5d4037; --accent-gold: #e6ceac; --font-main: 'Courier New', Courier, monospace; }
      html, body { height: 100%; margin: 0; font-family: var(--font-main); font-weight: bold; overflow: hidden; background-color: var(--bg-color); background-image: linear-gradient(rgba(230, 206, 172, 0.2) 1px, transparent 1px), linear-gradient(90deg, rgba(230, 206, 172, 0.2) 1px, transparent 1px); background-size: 40px 40px; color: #8d6e63; }
      
      /* --- åŸºç¡€å¸ƒå±€ --- */
      #phone-screen { width: 100%; height: 100vh; display: flex; flex-direction: column; position: relative; overflow: hidden; }
      .screen { width: 100%; height: 100%; position: absolute; display: flex; flex-direction: column; transition: 0.3s; }
      #home-screen { padding-top: calc(30px + env(safe-area-inset-top)); padding-bottom: 20px; box-sizing: border-box; z-index: 10; }
      #home-screen-pages-container { flex-grow: 1; width: 100%; height: 100%; position: relative; }
      #home-screen-pages { width: 100%; height: 100%; display: flex; }
      .home-screen-page { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
      #main-content-area { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; }

      /* --- æ¡Œé¢ç»„ä»¶ --- */
      #desktop-app-container { background: linear-gradient(to bottom, #fdfbf7 0%, #f4eadd 100%); border: 1px solid #e0d0b8; border-radius: 20px; padding: 50px 35px 60px 35px; display: flex; gap: 35px; position: relative; box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8), 0 15px 35px rgba(141, 110, 99, 0.25); align-items: center; justify-content: center; min-width: 320px; }
      #desktop-app-container::before { content: 'EPHONE AI'; position: absolute; top: 15px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #a1887f; background: linear-gradient(to bottom, #fffcf5, #f1e9d2); padding: 4px 16px; border-radius: 4px; border: 1px solid #d7ccc8; font-weight: 900; box-shadow: 0 1px 0 #fff; z-index: 10; }
      
      .screw { position: absolute; width: 9px; height: 9px; background: linear-gradient(135deg, #e6ceac, #bf9e74); border-radius: 50%; box-shadow: inset 1px 1px 2px rgba(255,255,255,0.8), 0 1px 2px rgba(0,0,0,0.1); }
      .screw::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 5px; height: 1px; background: rgba(93, 64, 55, 0.3); }
      .screw.tl { top: 12px; left: 12px; } .screw.tr { top: 12px; right: 12px; } .screw.bl { bottom: 12px; left: 12px; } .screw.br { bottom: 12px; right: 12px; }
      
      .tape-window-bg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 240px; height: 90px; background: #fffdf5; border: 2px solid #e6ceac; border-radius: 35px; z-index: 0; background-image: repeating-linear-gradient(transparent, transparent 19px, #f2e6d9 20px); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
      .tape-bottom-deco { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 220px; height: 35px; background: #f0e6d2; clip-path: polygon(10% 0%, 90% 0%, 100% 100%, 0% 100%); border-top: 1px solid #e0d0b8; z-index: 5; }
      .tape-holes { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 120px; height: 12px; display: flex; justify-content: space-between; }
      .tape-holes::before, .tape-holes::after { content: ''; width: 12px; height: 12px; background: #5d4037; border-radius: 50%; box-shadow: inset 1px 1px 2px rgba(0,0,0,0.3); }

      .desktop-app-icon { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; gap: 12px; cursor: pointer; width: 85px; -webkit-tap-highlight-color: transparent; }
      .icon-bg-desktop { width: 76px; height: 76px; border-radius: 50%; background: #3e2723; border: 4px dashed #d7ccc8; box-shadow: inset 0 0 10px rgba(0,0,0,0.5), 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; overflow: hidden; transition: transform 0.3s; position: relative; }
      .icon-bg-desktop img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; animation: reel-spin 10s linear infinite; opacity: 0.95; }
      .icon-bg-desktop svg { width: 50%; height: 50%; fill: #eceff1; }
      .icon-bg-desktop span { font-size: 28px; }
      .desktop-app-icon:active .icon-bg-desktop { transform: scale(0.92); }
      .desktop-app-icon .label { font-size: 12px; color: var(--text-deep); background: #fffdf0; padding: 3px 8px; border: 1px solid #efe6d5; border-radius: 2px; box-shadow: 1px 1px 3px rgba(0,0,0,0.05); font-weight: bold; transform: rotate(-2deg); }
      @keyframes reel-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

      /* --- APP çª—å£ä¸æ ·å¼ --- */
      .app-window { width: 100%; height: 100%; position: absolute; top: 0; left: 0; background: #fff; z-index: 50; display: none; flex-direction: column; opacity: 0; transform: scale(0.95); transition: 0.3s; }
      .app-window.active { display: flex; opacity: 1; transform: scale(1); }
      .app-iframe { width: 100%; height: 100%; border: none; background: #fff; }

      /* --- AI ç»ˆç«¯ 5.0 æ ·å¼ --- */
      .schedule-container { padding: 60px 20px 120px 20px; height: 100%; overflow-y: auto; box-sizing: border-box; }
      .schedule-header { font-size: 20px; color: #5d4037; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px dashed #e6ceac; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
      
      /* æ‚¬æµ®çª— */
      #flow-widget { position: fixed; top: 120px; right: 20px; z-index: 9999; display: none; cursor: move; user-select: none; touch-action: none; }
      .flow-card-detail { background: rgba(60, 60, 60, 0.75); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 8px 32px rgba(0,0,0,0.3); border-radius: 12px; padding: 10px 14px; color: #fff; font-size: 13px; white-space: nowrap; overflow: hidden; display: flex; align-items: center; }
      .flow-scroll-text { display: inline-block; padding-left: 100%; animation: marquee 10s linear infinite; }
      @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }
      .flow-card-simple { background: rgba(60, 60, 60, 0.75); backdrop-filter: blur(10px); border-radius: 12px; padding: 8px 12px; color: #fff; font-size: 12px; font-weight: bold; border: 1px solid rgba(255,255,255,0.2); animation: breathing 3s ease-in-out infinite; }
      @keyframes breathing { 0%, 100% { opacity: 0.8; transform: scale(1); } 50% { opacity: 1; transform: scale(1.05); border-color: #fff; } }
      .flow-icon-img { display: block; border-radius: 0; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); transition: transform 0.2s; }
      .flow-icon-img:active { transform: scale(0.9); }

      /* è®¾ç½®ç»„ä»¶ */
      .settings-group { margin-bottom: 20px; background: rgba(255, 255, 255, 0.5); padding: 15px; border-radius: 12px; border: 1px solid #efe6d5; }
      .settings-title { font-size: 14px; color: #8d6e63; margin-bottom: 10px; font-weight: bold; border-left: 3px solid #e6ceac; padding-left: 8px; display: flex; justify-content: space-between; align-items: center; }
      .input-row { margin-bottom: 10px; }
      .input-label { font-size: 12px; color: #5d4037; margin-bottom: 4px; display: block; }
      .custom-input, .custom-textarea { width: 100%; padding: 8px; border: 1px solid #e0d0b8; border-radius: 6px; background: #fffdf5; font-size: 13px; color: #3e2723; box-sizing: border-box; outline: none; transition: 0.3s; }
      .custom-input:focus, .custom-textarea:focus { background: #fff; border-color: #8d6e63; }
      .custom-textarea { resize: vertical; min-height: 60px; font-family: monospace; }
      .btn-row { display: flex; gap: 10px; margin-top: 10px; }
      .btn-primary { flex: 1; background: #eecfa1; color: #5d4037; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
      .btn-secondary { flex: 1; background: #fff; border: 1px solid #d7ccc8; color: #8d6e63; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }
      .icon-btn { min-width: 30px; height: 30px; border: 1px solid #d7ccc8; background: #fff; border-radius: 4px; cursor: pointer; display: flex; justify-content: center; align-items: center; color: #8d6e63; font-size: 14px; padding:0; }
      .preset-bar { display: flex; gap: 8px; margin-bottom: 10px; background: #fffdf5; padding: 8px; border-radius: 8px; border: 1px dashed #d7ccc8; align-items: center; }
      .preset-select { flex: 1; padding: 6px; border: 1px solid #e0d0b8; border-radius: 4px; background: #fff; font-size: 12px; color: #5d4037; }
      .prompt-toolbar { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 8px; padding: 5px; background: #efe6d5; border-radius: 6px; }
      .var-btn { background: #fff; border: 1px solid #d7ccc8; border-radius: 4px; padding: 2px 6px; font-size: 10px; color: #5d4037; cursor: pointer; font-family: monospace; }

      /* è§’è‰²/é¡µç­¾/å¯¼å‡º */
      .role-bar { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; background: #efe6d5; padding: 8px; border-radius: 8px; }
      .mini-btn { width: 24px; height: 24px; border: 1px solid #d7ccc8; background: #fff; border-radius: 4px; display: flex; justify-content: center; align-items: center; cursor: pointer; color: #8d6e63; font-size: 12px; }
      .tabs-header { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; border-bottom: 1px solid #efe6d5; }
      .tab-item { padding: 6px 12px; background: #fff; border: 1px solid #e0d0b8; border-radius: 6px 6px 0 0; font-size: 12px; color: #8d6e63; cursor: pointer; white-space: nowrap; }
      .tab-item.active { background: #eecfa1; color: #5d4037; font-weight: bold; border-bottom: 1px solid #eecfa1; }
      .tab-add-btn { padding: 6px 10px; background: #efe6d5; border: 1px dashed #bbb; border-radius: 6px; cursor: pointer; color: #5d4037; }
      .export-control-panel { background: #fff3e0; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ffcc80; }
      .export-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; font-size: 12px; color: #e65100; }
      .toggle-switch { position: relative; display: inline-block; width: 34px; height: 20px; }
      .toggle-switch input { opacity: 0; width: 0; height: 0; }
      .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
      .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
      input:checked + .slider { background-color: #ff9800; }
      input:checked + .slider:before { transform: translateX(14px); }

      /* å®æ—¶é¢æ¿ & å¡ç‰‡ */
      #realtime-status-panel { background: #3e2723; color: #fff; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(62,39,35,0.4); border: 1px solid #5d4037; display: none; }
      .rt-content { font-size: 15px; font-weight: bold; color: #fff8e1; margin: 5px 0; line-height: 1.4; }
      .rt-divider { border: 0; border-top: 1px dashed #8d6e63; margin: 10px 0; }
      .timeline-card { background: #fff; border: 1px solid #efe6d5; border-radius: 12px; padding: 15px; margin-bottom: 15px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.03); transition: 0.3s; }
      .timeline-card.active-now { border: 2px solid #ffb74d; background: #fff3e0; transform: scale(1.02); z-index: 2; box-shadow: 0 8px 20px rgba(255, 183, 77, 0.3); }
      .t-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
      .t-time { font-family: monospace; font-weight: 900; font-size: 16px; color: #5d4037; background: #eecfa1; padding: 2px 8px; border-radius: 4px; }
      .t-desc { font-size: 14px; color: #4e342e; line-height: 1.5; white-space: pre-wrap; }
      .card-actions { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; display: flex; justify-content: flex-end; gap: 10px; }
      .card-btn { font-size: 11px; padding: 4px 8px; border-radius: 4px; cursor: pointer; border: 1px solid transparent; background: transparent; }
      .card-btn.edit { color: #8d6e63; border-color: #d7ccc8; }
      .card-btn.del { color: #e57373; border-color: #ffcdd2; }
      .card-btn.copy { color: #2196f3; border-color: #bbdefb; }
      
      /* æ‚¬æµ®çƒ & Toast */
      #fab-container { position: fixed; bottom: 50px; right: 25px; z-index: 1000; width: 64px; height: 64px; }
      #fab-main { width: 100%; height: 100%; border-radius: 50%; background-color: #eecfa1; background-image: repeating-radial-gradient(#eecfa1 0, #eecfa1 2px, #e0b878 3px, #eecfa1 4px); box-shadow: 0 0 0 3px #fff, 0 6px 15px rgba(161, 136, 127, 0.4); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.4s; position: relative; }
      #fab-main::before { content: ''; position: absolute; width: 26px; height: 26px; background: #fff8e1; border-radius: 50%; z-index: 1; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
      #fab-main::after { content: ''; position: absolute; width: 6px; height: 6px; background: #5d4037; border-radius: 50%; z-index: 2; }
      #fab-main svg { width: 18px; height: 18px; fill: #5d4037; z-index: 3; position: relative; transition: 0.3s; }
      #fab-main.expanded { transform: rotate(90deg); background: #fff; background-image: none; }
      #fab-main.expanded::before, #fab-main.expanded::after { opacity: 0; }
      .fab-actions { position: absolute; bottom: 80px; right: 0; display: flex; flex-direction: column; align-items: flex-end; gap: 12px; opacity: 0; visibility: hidden; transform: translateY(15px); transition: 0.3s; pointer-events: none; width: max-content; }
      #fab-container.menu-open .fab-actions { opacity: 1; visibility: visible; transform: translateY(0); pointer-events: auto; }
      .fab-mini-btn { width: 44px; height: 44px; background: #fff; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.08); display: flex; justify-content: center; align-items: center; font-weight: bold; color: #8d6e63; font-size: 14px; border: 1px solid #f0f0f0; overflow: hidden; }
      .fab-mini-btn img { width: 100%; height: 100%; object-fit: cover; }
      .fab-mini-btn svg { width: 20px; height: 20px; fill: #5d4037; }
      .fab-label { background: #fff; color: #5d4037; padding: 5px 10px; border-radius: 4px; font-size: 12px; margin-right: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: bold; }
      #fab-container.ghost-mode { opacity: 0; pointer-events: none; }
      #toast-msg { position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%) translateY(20px); background: #5d4037; color: #fff; padding: 10px 20px; border-radius: 6px; font-size: 13px; opacity: 0; visibility: hidden; transition: 0.3s; z-index: 2000; }
      #toast-msg.show { opacity: 1; transform: translateX(-50%) translateY(0); }
      .edge-sensor { position: fixed; z-index: 1500; background: transparent; }
      .edge-sensor.top { top: 0; left: 0; width: 100%; height: 30px; }
      .edge-sensor.bottom { bottom: 0; left: 0; width: 100%; height: 30px; }
    </style>
  </head>
  <body>
    <div id="phone-screen">
      <div id="flow-widget" onclick="copyFromFlowWindow()"></div>

      <div id="home-screen" class="screen">
        <div id="home-screen-pages-container">
          <div id="home-screen-pages">
            <div class="home-screen-page">
              <div id="main-content-area">
                <div id="desktop-layout">
                  <div id="desktop-app-container">
                    <div class="screw tl"></div><div class="screw tr"></div><div class="screw bl"></div><div class="screw br"></div>
                    <div class="tape-bottom-deco"><div class="tape-holes"></div></div>
                    <div class="tape-window-bg"></div>
                    
                    <div class="desktop-app-icon" onclick="openApp('app-a')">
                      <div class="icon-bg-desktop"><img src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg" alt="330"/></div>
                      <span class="label">330</span>
                    </div>
                    <div class="desktop-app-icon" onclick="openApp('app-b')">
                      <div class="icon-bg-desktop"><img src="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg" alt="å…”K"/></div>
                      <span class="label">å…”K</span>
                    </div>
                    <div class="desktop-app-icon" onclick="openApp('app-settings')">
                      <div class="icon-bg-desktop" style="background:#455a64;"><svg viewBox="0 0 24 24" style="width:50%;height:50%;fill:#eceff1;"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.04.24.24.41.48.41h3.84c.24 0 .43-.17.47-.41l.36-2.54c.59-.24 1.13-.57 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg></div>
                      <span class="label">é…ç½®</span>
                    </div>
                    <div class="desktop-app-icon" onclick="openApp('app-schedule')">
                      <div class="icon-bg-desktop" style="background:#e6ceac;"><span style="font-size:30px;">ğŸ“…</span></div>
                      <span class="label">è®¡æ—¶</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="app-a" class="app-window app-frame"><iframe data-src="https://kittykitty0v0.github.io/sfsfdf/" src="" class="app-iframe"></iframe></div>
      <div id="app-b" class="app-window app-frame"><iframe data-src="https://kittykitty0v0.github.io/-k-/" src="" class="app-iframe"></iframe></div>

      <div id="app-settings" class="app-window app-frame">
        <div class="schedule-container">
          <div class="schedule-header">
            <span>âš™ï¸ ç»ˆç«¯é…ç½®</span>
            <div>
              <button class="icon-btn" onclick="exportData()" title="å¯¼å‡º">ğŸ“¤</button>
              <button class="icon-btn" onclick="document.getElementById('import-file').click()" title="å¯¼å…¥" style="margin-left:5px;">ğŸ“¥</button>
              <input type="file" id="import-file" style="display:none" onchange="importData(this)">
            </div>
          </div>
          <div class="settings-group">
            <div class="settings-title" style="color:#d84315;">ğŸˆ æ™ºèƒ½æ‚¬æµ®çª—</div>
            <div class="input-row"><label class="input-label">æ¨¡å¼</label><select id="flow-mode" class="custom-input" onchange="saveGlobalSettings()"><option value="detail">è¯¦ç»†(å•è¡Œ)</option><option value="simple">ä¸å‰§é€</option><option value="icon">ä»…å›¾æ ‡</option></select></div>
            <div class="input-row"><label class="input-label">ç”Ÿæ•ˆèŒƒå›´(Â±åˆ†)</label><input type="number" id="flow-range" class="custom-input" value="15" onchange="saveGlobalSettings()"></div>
            <div class="input-row"><label class="input-label">å®½åº¦(px)</label><input type="number" id="flow-width" class="custom-input" value="200" onchange="saveGlobalSettings()"></div>
            <div class="input-row"><label class="input-label">å¸¸è§„å›¾æ ‡</label><input type="text" id="flow-icon-normal" class="custom-input" value="https://i.postimg.cc/B6FkXGCL/15.png" onchange="saveGlobalSettings()"></div>
            <div class="input-row"><label class="input-label">æ´»è·ƒå›¾æ ‡</label><input type="text" id="flow-icon-active" class="custom-input" value="https://i.postimg.cc/1tF2fZKF/16.png" onchange="saveGlobalSettings()"></div>
            <div class="input-row"><label class="input-label">å›¾æ ‡å¤§å°</label><input type="number" id="flow-icon-size" class="custom-input" value="50" onchange="saveGlobalSettings()"></div>
          </div>
          <div class="settings-group">
            <div class="settings-title">ğŸ“¡ API è¿æ¥</div>
            <div class="preset-bar">
              <select id="api-preset-select" class="preset-select" onchange="loadPreset('api', this.value)"><option value="">-- æ–°å»º --</option></select>
              <button class="icon-btn" onclick="savePreset('api')">ğŸ’¾</button> <button class="icon-btn delete" onclick="deletePreset('api')">ğŸ—‘ï¸</button>
            </div>
            <div class="input-row"><label class="input-label">Host</label><input type="text" id="api-host" class="custom-input" placeholder="https://api.openai.com"></div>
            <div class="input-row"><label class="input-label">Key</label><input type="password" id="api-key" class="custom-input"></div>
            <div class="input-row"><label class="input-label">Model</label><div style="display:flex;gap:5px;"><input type="text" id="model-name" class="custom-input" placeholder="gpt-3.5-turbo"><button class="icon-btn" onclick="fetchModels()">ğŸ”</button></div><select id="model-list-dropdown" class="custom-input" style="display:none;margin-top:5px;" onchange="document.getElementById('model-name').value=this.value"></select></div>
            <div class="input-row"><label class="input-label">åç§°(ä¿å­˜ç”¨)</label><input type="text" id="api-preset-name" class="custom-input"></div>
          </div>
          <div class="settings-group">
            <div class="settings-title" style="color:#d84315;">ğŸ“‹ æ–‡æ¡ˆé¢„è®¾
                <div class="preset-bar" style="margin:0;padding:2px;background:none;border:none;">
                  <select id="text-preset-select" class="preset-select" style="width:100px;" onchange="loadPreset('text', this.value)"></select>
                  <button class="icon-btn" onclick="savePreset('text')">ğŸ’¾</button> <button class="icon-btn delete" onclick="deletePreset('text')">ğŸ—‘ï¸</button>
                </div>
            </div>
            <div class="input-row"><label class="input-label">é¢„è®¾åç§°</label><input type="text" id="text-preset-name" class="custom-input"></div>
            <div class="input-row"><label class="input-label">å…¨å±€å¤åˆ¶æ¨¡æ¿ (\${timercontent})</label><textarea id="global-copy-template" class="custom-textarea" style="height:80px;"></textarea></div>
            <div class="input-row"><label class="input-label">è¿‡å»æ¨¡æ¿</label><input type="text" id="status-tpl-past" class="custom-input"></div>
            <div class="input-row"><label class="input-label">æœªæ¥æ¨¡æ¿</label><input type="text" id="status-tpl-future" class="custom-input"></div>
            <div style="text-align:right;"><button class="icon-btn" onclick="saveGlobalSettings()" style="width:auto; padding:0 10px;">âœ… åº”ç”¨é…ç½®</button></div>
          </div>
          <div class="settings-group">
            <div class="settings-title">ğŸ“ æç¤ºè¯å·¥åŠ</div>
            <div class="preset-bar">
              <select id="prompt-preset-select" class="preset-select" onchange="loadPreset('prompt', this.value)"><option value="">-- æ–°å»º --</option></select>
              <button class="icon-btn" onclick="savePreset('prompt')">ğŸ’¾</button> <button class="icon-btn delete" onclick="deletePreset('prompt')">ğŸ—‘ï¸</button>
            </div>
            <div class="input-row">
              <div class="prompt-toolbar"><button class="var-btn" onclick="insertVar('${chat.name}')">è§’è‰²å</button><button class="var-btn" onclick="insertVar('${user.name}')">ç”¨æˆ·å</button><button class="var-btn" onclick="insertVar('${chat.settings.aiPersona}')">äººè®¾</button><button class="var-btn" onclick="insertVar('${chat.settings.worldinfo}')">ä¸–ç•Œè§‚</button></div>
              <textarea id="prompt-content" class="custom-textarea" style="height:150px;"></textarea>
            </div>
            <div class="input-row"><label class="input-label">é¢„è®¾åç§°</label><input type="text" id="prompt-preset-name" class="custom-input"></div>
          </div>
          <div class="settings-group"><div class="settings-title">ğŸ­ è§’è‰²</div><div class="preset-bar"><select id="char-preset-select" class="preset-select" onchange="loadPreset('char', this.value)"><option value="">-- æ–°å»º --</option></select><button class="icon-btn" onclick="savePreset('char')">ğŸ’¾</button><button class="icon-btn delete" onclick="deletePreset('char')">ğŸ—‘ï¸</button></div><div class="input-row"><label class="input-label">åç§°</label><input type="text" id="char-preset-name" class="custom-input"></div><div class="input-row"><label class="input-label">å</label><input type="text" id="char-name" class="custom-input"></div><div class="input-row"><label class="input-label">äººè®¾</label><textarea id="char-persona" class="custom-textarea"></textarea></div><div class="input-row"><label class="input-label">ä¸–ç•Œ</label><textarea id="world-info" class="custom-textarea"></textarea></div><div class="input-row"><label class="input-label">å†å²</label><textarea id="chat-history" class="custom-textarea"></textarea></div></div>
          <div class="settings-group"><div class="settings-title">ğŸ‘¤ ç”¨æˆ·</div><div class="preset-bar"><select id="user-preset-select" class="preset-select" onchange="loadPreset('user', this.value)"><option value="">-- æ–°å»º --</option></select><button class="icon-btn" onclick="savePreset('user')">ğŸ’¾</button><button class="icon-btn delete" onclick="deletePreset('user')">ğŸ—‘ï¸</button></div><div class="input-row"><label class="input-label">åç§°</label><input type="text" id="user-preset-name" class="custom-input"></div><div class="input-row"><label class="input-label">å</label><input type="text" id="user-name" class="custom-input"></div><div class="input-row"><label class="input-label">äººè®¾</label><textarea id="user-persona" class="custom-textarea"></textarea></div></div>
          <div style="height:100px;"></div>
        </div>
      </div>

      <div id="app-schedule" class="app-window app-frame">
        <div class="schedule-container">
          <div class="role-bar"><span>ğŸ­</span><select id="role-select" class="custom-input" style="padding:4px;font-weight:bold;" onchange="switchRole(this.value)"></select><button class="mini-btn" onclick="addNewRole()">+</button><button class="mini-btn" onclick="renameRole()">âœ</button><button class="mini-btn" onclick="deleteRole()" style="color:#e57373;">ğŸ—‘ï¸</button></div>
          <div class="tabs-header" id="timer-tabs"></div>
          <div style="text-align:right; margin-bottom:10px;"><button class="card-btn del" onclick="deleteCurrentPage()">ğŸ—‘ï¸ åˆ é¡µ</button><button class="card-btn del" onclick="clearCurrentPage()">ğŸ§¹ æ¸…ç©º</button></div>
          <div class="export-control-panel">
            <div class="export-row"><span style="font-weight:bold;color:#bf360c;">å¤åˆ¶å¼€å…³</span><label class="toggle-switch"><input type="checkbox" id="page-export-toggle" onchange="updatePageExportSettings()"><span class="slider"></span></label></div>
            <div class="export-row"><span>èŒƒå›´</span><select id="page-export-mode" class="custom-input" style="width:100px;padding:2px;" onchange="updatePageExportSettings()"><option value="both">å…¨éƒ¨</option><option value="past">è¿‡å»</option><option value="future">æœªæ¥</option></select></div>
          </div>
          <div id="realtime-status-panel"><div class="rt-content" id="rt-past">--</div><div class="rt-divider"></div><div class="rt-content" id="rt-future">--</div></div>
          <div style="background:#fff3e0; padding:10px; border-radius:8px; margin-bottom:15px; font-size:12px; display:flex; align-items:center; gap:5px;"><span>ğŸ“š è§„åˆ™ï¼š</span><select id="page-prompt-select" class="custom-input" style="padding:4px;" onchange="bindPromptToPage(this.value)"></select></div>
          <div style="margin-bottom:20px;"><div class="btn-row"><button class="btn-primary" id="btn-gen-schedule" onclick="generateSchedule(false)">ğŸ”„ é‡ç®—</button><button class="btn-secondary" id="btn-append-schedule" onclick="generateSchedule(true)">â• è¿½åŠ </button></div><div id="schedule-loading" style="display:none;padding:10px;text-align:center;font-size:12px;color:#8d6e63;">ğŸ§  æ€è€ƒä¸­...</div></div>
          <div id="schedule-result-area"></div>
          <div style="height:100px;"></div>
        </div>
      </div>

      <div id="fab-container">
        <div class="fab-actions">
          <div class="fab-action-btn" onclick="openApp('app-a')"><span class="fab-label">330</span><div class="fab-mini-btn"><img src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg"/></div></div>
          <div class="fab-action-btn" onclick="openApp('app-b')"><span class="fab-label">å…”K</span><div class="fab-mini-btn"><img src="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg"/></div></div>
          <div class="fab-action-btn" onclick="toggleFlowWindow()"><span class="fab-label">æ‚¬æµ®çª—</span><div class="fab-mini-btn" style="background:#b3e5fc;"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg></div></div>
          <div class="fab-action-btn" onclick="hideFab()"><span class="fab-label">éšè—</span><div class="fab-mini-btn"><svg viewBox="0 0 24 24"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46A11.804 11.804 0 0 0 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg></div></div>
          <div class="fab-action-btn" onclick="goHome()"><span class="fab-label">ä¸»é¡µ</span><div class="fab-mini-btn"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></div></div>
        </div>
        <div id="fab-main"></div>
      </div>

      <div class="edge-sensor top"></div><div class="edge-sensor bottom"></div><div class="edge-sensor left"></div><div class="edge-sensor right"></div>
      <div id="toast-msg"></div>
    </div>

    <script>
      const fabContainer=document.getElementById('fab-container'), fabMain=document.getElementById('fab-main'), launcher=document.getElementById('home-screen'), frames=document.querySelectorAll('.app-frame'), toast=document.getElementById('toast-msg');
      const menuIconSvg='<svg viewBox="0 0 24 24"><path d="M4 18h16c.55 0 1-.45 1-1s-.45-1-1-1H4c-.55 0-1 .45-1 1s.45 1 1 1zm0-5h16c.55 0 1-.45 1-1s-.45-1-1-1H4c-.55 0-1 .45-1 1s.45 1 1 1zM3 7c0 .55.45 1 1 1h16c.55 0 1-.45 1-1s-.45-1-1-1H4c-.55 0-1 .45-1 1z"/></svg>';
      const closeIconSvg='<svg viewBox="0 0 24 24"><path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7a.996.996 0 1 0-1.41 1.41L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/></svg>';
      fabMain.innerHTML=menuIconSvg;

      function openApp(id){ document.body.classList.add('app-open'); launcher.style.opacity='0'; launcher.style.transform='scale(0.95)'; frames.forEach(f=>{ if(f.id===id){f.style.display='flex';setTimeout(()=>f.classList.add('active'),10); const i=f.querySelector('iframe');if(i&&i.dataset.src)i.src=i.dataset.src;}else{f.classList.remove('active');f.style.display='none';const i=f.querySelector('iframe');if(i)i.src='';}}); closeMenu(); }
      function goHome(){ document.body.classList.remove('app-open'); launcher.style.opacity='1'; launcher.style.transform='scale(1)'; setTimeout(()=>{frames.forEach(f=>{f.classList.remove('active');f.style.display='none';const i=f.querySelector('iframe');if(i)i.src='';})},300); closeMenu(); }
      function hideFab(){ closeMenu(); const r=fabMain.getBoundingClientRect(); fabContainer.style.left=r.left+'px'; fabContainer.style.top=r.top+'px'; fabContainer.style.bottom='auto'; fabContainer.style.right='auto'; fabContainer.classList.add('ghost-mode'); showToast('å·²éšè—'); }
      function showFab(){ fabContainer.classList.remove('ghost-mode'); }
      function showToast(t){ toast.innerText=t; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),3000); }
      function toggleMenu(){ if(fabContainer.classList.contains('ghost-mode')){ showFab(); setTimeout(()=>{ fabContainer.classList.add('menu-open'); fabMain.classList.add('expanded'); fabMain.innerHTML=closeIconSvg; },50); return; } fabContainer.classList.toggle('menu-open'); fabMain.classList.toggle('expanded'); fabMain.innerHTML=fabMain.classList.contains('expanded')?closeIconSvg:menuIconSvg; }
      function closeMenu(){ fabContainer.classList.remove('menu-open'); fabMain.classList.remove('expanded'); fabMain.innerHTML=menuIconSvg; }
      document.addEventListener('click',e=>{if(!fabContainer.contains(e.target)&&fabContainer.classList.contains('menu-open'))closeMenu();});
      
      let isDragging=false, hasMoved=false, startX, startY, iLeft, iTop;
      fabMain.addEventListener('mousedown',sD); fabMain.addEventListener('touchstart',sD,{passive:false});
      function sD(e){ if(fabContainer.classList.contains('ghost-mode'))return; if(fabContainer.classList.contains('menu-open'))closeMenu(); isDragging=true; hasMoved=false; if(e.type==='touchstart'){startX=e.touches[0].clientX;startY=e.touches[0].clientY;}else{startX=e.clientX;startY=e.clientY;} const r=fabContainer.getBoundingClientRect(); iLeft=r.left; iTop=r.top; fabContainer.style.bottom='auto'; fabContainer.style.right='auto'; fabContainer.style.left=iLeft+'px'; fabContainer.style.top=iTop+'px'; document.addEventListener('mousemove',oD); document.addEventListener('touchmove',oD,{passive:false}); document.addEventListener('mouseup',eD); document.addEventListener('touchend',eD); }
      function oD(e){ if(!isDragging)return; e.preventDefault(); let cx,cy; if(e.type==='touchmove'){cx=e.touches[0].clientX;cy=e.touches[0].clientY;}else{cx=e.clientX;cy=e.clientY;} if(Math.abs(cx-startX)>5||Math.abs(cy-startY)>5)hasMoved=true; fabContainer.style.left=(iLeft+cx-startX)+'px'; fabContainer.style.top=(iTop+cy-startY)+'px'; }
      function eD(){ isDragging=false; document.removeEventListener('mousemove',oD); document.removeEventListener('touchmove',oD); document.removeEventListener('mouseup',eD); document.removeEventListener('touchend',eD); }
      fabMain.addEventListener('click',e=>{e.stopPropagation();if(!hasMoved)toggleMenu();});
      if('serviceWorker' in navigator){window.addEventListener('load',()=>{document.addEventListener('dblclick',()=>{if(fabContainer.classList.contains('ghost-mode')){showFab();showToast('å”¤å‡º');}});let lt=0;document.addEventListener('touchend',()=>{const t=new Date().getTime();if(t-lt<300&&t-lt>0&&fabContainer.classList.contains('ghost-mode')){showFab();showToast('å”¤å‡º');}lt=t;});navigator.serviceWorker.register('sw.js');});}

      /* === é€»è¾‘æ ¸å¿ƒ V5.2 === */
      let timerPages=[], activeRoleId=0, activePageIndex=0, roles=[];
      const DEFAULT_GLOBAL = {
        copyTemplate: "æ­¤æ¡å†…å®¹æ˜¯aiå†™ä½œæŒ‡å¯¼ï¼Œè§’è‰²ä¸å¯è§ã€‚ä»¥ä¸‹æ˜¯è§’è‰²åŸæœ¬çš„æ—¥ç¨‹è®¡åˆ’ï¼Œæ³¨æ„è§’è‰²å¯èƒ½ä¹‹å‰ä¹‹åéƒ½ä¸æŒ‰ç…§åŸè®¡åˆ’è¿›è¡Œï¼Œè¯·ä½ æ ¹æ®ä¸Šä¸‹æ–‡è¯­å¢ƒè¿›è¡Œåˆ¤æ–­å‰§æƒ…å‘å±•ï¼š\nå½“å‰çš„ä¸–ç•Œæ˜¯${currTime}ï¼Œ${timercontent}\nå¿…é¡»æ ¹æ®ä¸Šä¸‹æ–‡åˆ¤æ–­è§’è‰²æ˜¯å¦ä¹‹å‰æˆ–ä¹‹åè¿›è¡ŒåŸè®¡åˆ’ï¼Œä»¥åŠæ ¹æ®å½“å‰å¯¹è¯åœºæ™¯è§’è‰²æ˜¯å¦ä¼šæåŠæ­¤äº‹ï¼Œè§’è‰²ä¹Ÿå¯èƒ½å·²ç»å¿˜è®°æ­¤äº‹æˆ–ç›´æ¥æ ¹æœ¬ä¸æã€‚ä½ ä½œä¸ºaiå¿…é¡»è‡ªè¡Œåˆ¤æ–­åšå‡ºæœ‰æ´»äººæ„Ÿçš„ååº”ä¸ç»“æœã€‚",
        tplPast: "${min}åˆ†é’Ÿå‰ï¼Œ${char}åŸè®¡åˆ’æ˜¯åœ¨${time}${act}",
        tplFuture: "${min}åˆ†é’Ÿåï¼Œ${char}åŸè®¡åˆ’æ˜¯åœ¨${time}${act}",
        flowMode: 'simple', flowRange: 15, flowVisible: false, flowWidth: 200, iconNormal: "https://i.postimg.cc/B6FkXGCL/15.png", iconActive: "https://i.postimg.cc/1tF2fZKF/16.png", iconSize: 50
      };
      let globalSettings = {...DEFAULT_GLOBAL};
      const STORAGE_KEYS={api:'tuki_presets_api',char:'tuki_presets_char',user:'tuki_presets_user',prompt:'tuki_presets_prompt',text:'tuki_presets_text',roles:'tuki_roles_v2',global:'tuki_global_settings'};
      const FIELD_MAP={api:['api-preset-name','api-host','api-key','model-name'],char:['char-preset-name','char-name','char-persona','world-info','chat-history'],user:['user-preset-name','user-name','user-persona'],prompt:['prompt-preset-name','prompt-content'],text:['text-preset-name','global-copy-template','status-tpl-past','status-tpl-future']};
      const DEFAULT_PROMPT = `# è§’è‰²æ‰®æ¼”ä»»åŠ¡\nè¯·æ ¹æ®"\${chat.name}"çš„äººè®¾ï¼Œæ¨æ¼”æ¥ä¸‹æ¥24å°æ—¶çš„è¡Œä¸ºè½¨è¿¹ã€‚\n# å‚æ•°\nè§’è‰²ï¼š\${chat.name}\näººè®¾ï¼š\${chat.settings.aiPersona}\n# è¾“å‡ºè§„åˆ™\n1. è¿”å›JSONæ•°ç»„ã€‚2. æ—¶é—´æ ¼å¼ "HH:mm"ã€‚3. åŒ…å« 'html_snippet' (å¯é€‰)ã€‚\n[{"time":"08:00","description":"...","icon":"â°"}]`;

      window.addEventListener('load', () => {
        ['api','char','user','prompt','text'].forEach(refreshDropdown);
        const sg = localStorage.getItem(STORAGE_KEYS.global);
        if(sg) globalSettings = {...globalSettings, ...JSON.parse(sg)};
        // å›å¡«è®¾ç½®
        ['copyTemplate','tplPast','tplFuture','flowMode','flowRange','flowWidth','iconNormal','iconActive','iconSize'].forEach(k=>{
           const id = k==='copyTemplate'?'global-copy-template':(k.startsWith('tpl')?'status-'+k.replace(/([A-Z])/g,'-$1').toLowerCase():'flow-'+k.replace(/([A-Z])/g,'-$1').toLowerCase());
           const el = document.getElementById(id); if(el) el.value = globalSettings[k];
        });
        const sr = localStorage.getItem(STORAGE_KEYS.roles);
        if(sr) roles = JSON.parse(sr);
        else roles = [{ id: Date.now(), name: "é»˜è®¤è§’è‰²", pages: [{ id: Date.now(), name: "ä¸»æ—¥ç¨‹", promptPreset: "", data: [], exportEnabled: true, exportMode: 'both' }] }];
        activeRoleId = roles[0].id;
        initDefaultPreset('prompt','é»˜è®¤æ—¥ç¨‹',{'prompt-content':DEFAULT_PROMPT});
        initDefaultPreset('text','é»˜è®¤æ–‡æ¡ˆ',{'global-copy-template':DEFAULT_GLOBAL.copyTemplate,'status-tpl-past':DEFAULT_GLOBAL.tplPast,'status-tpl-future':DEFAULT_GLOBAL.tplFuture});
        renderRoleUI(); updateFlowWindowVisibility(); makeDraggable(document.getElementById('flow-widget'));
        setInterval(() => { updateRealTimeStatus(); renderFlowWindow(); }, 1000);
      });

      function initDefaultPreset(t,n,c){const p=getPresets(t);if(Object.keys(p).length===0){p[n]={[t+'-preset-name']:n,...c};localStorage.setItem(STORAGE_KEYS[t],JSON.stringify(p));refreshDropdown(t);}}
      function makeDraggable(e){let p1=0,p2=0,p3=0,p4=0;e.onmousedown=dm;e.ontouchstart=dm;function dm(ev){ev=ev||window.event;e.dataset.isDragging="false";p3=ev.clientX||ev.touches[0].clientX;p4=ev.clientY||ev.touches[0].clientY;document.onmouseup=ce;document.onmousemove=ed;document.ontouchend=ce;document.ontouchmove=ed;}function ed(ev){ev=ev||window.event;e.dataset.isDragging="true";let cx=ev.clientX||ev.touches[0].clientX,cy=ev.clientY||ev.touches[0].clientY;p1=p3-cx;p2=p4-cy;p3=cx;p4=cy;e.style.top=(e.offsetTop-p2)+"px";e.style.left=(e.offsetLeft-p1)+"px";e.style.right="auto";}function ce(){document.onmouseup=null;document.onmousemove=null;document.ontouchend=null;document.ontouchmove=null;}}
      
      function toggleFlowWindow(){globalSettings.flowVisible=!globalSettings.flowVisible;saveGlobalSettings();updateFlowWindowVisibility();}
      function updateFlowWindowVisibility(){const w=document.getElementById('flow-widget');w.style.display=globalSettings.flowVisible?'block':'none';renderFlowWindow();}
      function getActiveEventsForFlow(){
        const now=new Date(), curM=now.getHours()*60+now.getMinutes(), role=roles.find(r=>r.id===activeRoleId);
        if(!role) return {active:[],next:null};
        let act=[], nxt=[];
        role.pages.forEach(p=>{if(!p.exportEnabled)return;p.data.forEach(i=>{const[h,m]=i.time.split(':').map(Number),t=h*60+m,d=Math.abs(t-curM);if(d<=globalSettings.flowRange)act.push({...i,pageName:p.name});else if(t>curM)nxt.push({...i,t:t});});});
        nxt.sort((a,b)=>a.t-b.t); return {active:act,next:nxt[0]};
      }
      function renderFlowWindow(){
        if(!globalSettings.flowVisible)return;
        const w=document.getElementById('flow-widget'), {active,next}=getActiveEventsForFlow(), cn=document.getElementById('char-name').value||"TA", sz=globalSettings.iconSize;
        if(globalSettings.flowMode==='icon'){w.innerHTML=`<img src="${active.length>0?globalSettings.iconActive:globalSettings.iconNormal}" class="flow-icon-img" style="width:${sz}px;height:${sz}px;">`;}
        else{
          let h=''; const width = globalSettings.flowWidth || 200;
          if(active.length>0){
            const idx=Math.floor(Date.now()/3000)%active.length, it=active[idx], [hr,mn]=it.time.split(':').map(Number), nm=new Date().getHours()*60+new Date().getMinutes(), df=Math.abs(nm-(hr*60+mn));
            if(globalSettings.flowMode==='detail'){
               const tpl=(nm>hr*60+mn)?globalSettings.tplPast:globalSettings.tplFuture;
               const txt=tpl.replace(/\${min}/g,df).replace(/\${char}/g,cn).replace(/\${act}/g,it.description).replace(/\${time}/g,it.time);
               h=`<div class="flow-card-detail" style="width:${width}px"><span class="flow-scroll-text">${txt}</span></div>`;
            }else{ h=`<div class="flow-card-simple" style="width:${width}px">${cn} ${df}min<br>${it.description.substring(0,10)}</div>`; }
          }else{
            if(next){const[hr,mn]=next.time.split(':').map(Number),df=(hr*60+mn)-(new Date().getHours()*60+new Date().getMinutes());h=`<div class="flow-card-simple" style="width:${width}px;opacity:0.7">Next: ${df}min<br>${next.description.substring(0,8)}...</div>`;}
            else{h=`<div class="flow-card-simple" style="width:${width}px;opacity:0.5">ğŸ’¤</div>`;}
          }
          w.innerHTML=h;
        }
      }
      function copyFromFlowWindow(){
        const w=document.getElementById('flow-widget'); if(w.dataset.isDragging==="true")return;
        const {active}=getActiveEventsForFlow(), nm=new Date().getHours()*60+new Date().getMinutes(), cn=document.getElementById('char-name').value||"TA";
        if(active.length>0){
           let ls=[]; active.forEach(i=>{const[h,m]=i.time.split(':').map(Number),df=Math.abs(nm-(h*60+m)),tpl=(nm>h*60+m)?globalSettings.tplPast:globalSettings.tplFuture;ls.push(tpl.replace(/\${min}/g,df).replace(/\${char}/g,cn).replace(/\${act}/g,i.description).replace(/\${time}/g,i.time));});
           const txt=globalSettings.copyTemplate.replace("${currTime}",new Date().toLocaleString()).replace("${timercontent}",ls.join("ï¼›"));
           navigator.clipboard.writeText(txt).then(()=>showToast("å·²å¤åˆ¶")).catch(()=>showToast("å¤±è´¥"));
        }else showToast("æ— æ´»è·ƒäº‹ä»¶");
      }

      function getPresets(t){return JSON.parse(localStorage.getItem(STORAGE_KEYS[t]))||{};}
      function refreshDropdown(t){
        const p=getPresets(t), s=document.getElementById(`${t}-preset-select`), c=s.value; s.innerHTML='<option value="">-- æ–°å»º/é€‰æ‹© --</option>';
        Object.keys(p).forEach(n=>{const o=document.createElement('option');o.value=n;o.innerText=n;s.appendChild(o)}); if(p[c])s.value=c;
        if(t==='prompt'){const ps=document.getElementById('page-prompt-select');if(ps&&getActivePage()){ps.innerHTML='<option value="">-- è§„åˆ™ --</option>';Object.keys(p).forEach(n=>{const o=document.createElement('option');o.value=n;o.innerText=n;ps.appendChild(o)});ps.value=getActivePage().promptPreset||"";}}
      }
      function loadPreset(t,n){const f=FIELD_MAP[t];if(!n){f.forEach(i=>document.getElementById(i).value='');return;}const d=getPresets(t)[n];if(d)f.forEach(i=>{const e=document.getElementById(i);if(e)e.value=d[i]||''});}
      function savePreset(t){const n=document.getElementById(`${t}-preset-name`).value.trim();if(!n)return showToast('æ— åç§°');const p=getPresets(t),d={};FIELD_MAP[t].forEach(i=>d[i]=document.getElementById(i).value);p[n]=d;localStorage.setItem(STORAGE_KEYS[t],JSON.stringify(p));refreshDropdown(t);document.getElementById(`${t}-preset-select`).value=n;showToast('å·²ä¿å­˜');}
      function deletePreset(t){const n=document.getElementById(`${t}-preset-select`).value;if(n&&confirm('åˆ é™¤?')){const p=getPresets(t);delete p[n];localStorage.setItem(STORAGE_KEYS[t],JSON.stringify(p));loadPreset(t,'');refreshDropdown(t);showToast('å·²åˆ é™¤');}}
      function saveGlobalSettings(){
        ['copyTemplate','tplPast','tplFuture','flowMode','flowRange','flowWidth','iconNormal','iconActive','iconSize'].forEach(k=>{
           const id=k==='copyTemplate'?'global-copy-template':(k.startsWith('tpl')?'status-'+k.replace(/([A-Z])/g,'-$1').toLowerCase():'flow-'+k.replace(/([A-Z])/g,'-$1').toLowerCase());
           const v=document.getElementById(id).value; globalSettings[k]=(k==='flowRange'||k.includes('Size')||k.includes('Width'))?parseInt(v):v;
        });
        localStorage.setItem(STORAGE_KEYS.global,JSON.stringify(globalSettings)); showToast("è®¾ç½®å·²ä¿å­˜"); updateFlowWindowVisibility();
      }

      function renderRoleUI(){const s=document.getElementById('role-select');s.innerHTML='';roles.forEach(r=>{const o=document.createElement('option');o.value=r.id;o.innerText=r.name;s.appendChild(o)});s.value=activeRoleId;renderTabs();}
      function getActiveRole(){return roles.find(r=>r.id==activeRoleId);} function getActivePage(){return getActiveRole().pages[activePageIndex];}
      function switchRole(i){activeRoleId=parseInt(i);activePageIndex=0;renderTabs();}
      function addNewRole(){const n=prompt("è§’è‰²å:");if(n){roles.push({id:Date.now(),name:n,pages:[{id:Date.now(),name:"æ—¥ç¨‹",promptPreset:"",data:[],exportEnabled:true,exportMode:'both'}]});activeRoleId=roles[roles.length-1].id;activePageIndex=0;saveRoles();renderRoleUI();}}
      function renameRole(){const r=getActiveRole(),n=prompt("é‡å‘½å:",r.name);if(n){r.name=n;saveRoles();renderRoleUI();}}
      function deleteRole(){if(roles.length<=1)return;if(confirm("åˆ é™¤è§’è‰²?")){roles=roles.filter(r=>r.id!=activeRoleId);activeRoleId=roles[0].id;activePageIndex=0;saveRoles();renderRoleUI();}}
      function saveRoles(){localStorage.setItem(STORAGE_KEYS.roles,JSON.stringify(roles));}
      function renderTabs(){
        const c=document.getElementById('timer-tabs');c.innerHTML='';
        getActiveRole().pages.forEach((p,i)=>{const t=document.createElement('div');t.className=`tab-item ${i===activePageIndex?'active':''}`;t.innerText=p.name;t.onclick=()=>{activePageIndex=i;renderTabs()};c.appendChild(t)});
        const b=document.createElement('div');b.className='tab-add-btn';b.innerText='+';b.onclick=addNewPage;c.appendChild(b);
        const cp=getActivePage();if(cp){refreshDropdown('prompt');document.getElementById('page-export-toggle').checked=cp.exportEnabled!==false;document.getElementById('page-export-mode').value=cp.exportMode||'both';renderTimeline();}
      }
      function addNewPage(){const n=prompt("é¡µç­¾åç§°:");if(n){getActiveRole().pages.push({id:Date.now(),name:n,promptPreset:"",data:[],exportEnabled:true,exportMode:'both'});activePageIndex=getActiveRole().pages.length-1;saveRoles();renderTabs();}}
      function deleteCurrentPage(){if(getActiveRole().pages.length<=1)return;if(confirm("åˆ é™¤é¡µç­¾?")){getActiveRole().pages.splice(activePageIndex,1);activePageIndex=0;saveRoles();renderTabs();}}
      function clearCurrentPage(){if(confirm("æ¸…ç©º?")){getActivePage().data=[];saveRoles();renderTimeline();}}
      function bindPromptToPage(v){getActivePage().promptPreset=v;saveRoles();}
      function updatePageExportSettings(){const p=getActivePage();p.exportEnabled=document.getElementById('page-export-toggle').checked;p.exportMode=document.getElementById('page-export-mode').value;saveRoles();}

      async function fetchModels(){const h=document.getElementById('api-host').value.replace(/\/$/,''),k=document.getElementById('api-key').value;if(!h||!k)return showToast('ç¼ºHost/Key');try{const r=await fetch(`${h}/v1/models`,{headers:{'Authorization':`Bearer ${k}`}});const d=await r.json();const l=document.getElementById('model-list-dropdown');l.innerHTML='<option>--é€‰æ¨¡å‹--</option>';d.data.forEach(m=>{const o=document.createElement('option');o.value=m.id;o.innerText=m.id;l.appendChild(o)});l.style.display='block';showToast(`OK: ${d.data.length}`);}catch(e){alert(e.message);}}
      function insertVar(t){const e=document.getElementById('prompt-content'),s=e.selectionStart;e.value=e.value.substring(0,s)+t+e.value.substring(e.selectionEnd);e.focus();}
      async function generateSchedule(ap){
        const h=document.getElementById('api-host').value.replace(/\/$/,''),k=document.getElementById('api-key').value,m=document.getElementById('model-name').value;
        if(!h||!k)return showToast('è¯·é…ç½®API');
        const p=getActivePage(),pr=getPresets('prompt')[p.promptPreset]?.['prompt-content'];
        if(!pr)return showToast('ç¼ºæç¤ºè¯');
        const v=id=>document.getElementById(id).value||'', f=pr.replace(/\${chat.name}/g,v('char-name')).replace(/\${chat.settings.aiPersona}/g,v('char-persona')).replace(/\${chat.settings.worldinfo}/g,v('world-info')).replace(/\${chat.settings.history}/g,v('chat-history')).replace(/\${user.name}/g,v('user-name')).replace(/\${user.settings.aiPersona}/g,v('user-persona'));
        const l=document.getElementById('schedule-loading'),b1=document.getElementById('btn-gen-schedule'),b2=document.getElementById('btn-append-schedule');l.style.display='block';b1.disabled=b2.disabled=true;
        try{const r=await fetch(`${h}/v1/chat/completions`,{method:'POST',headers:{'Authorization':`Bearer ${k}`,'Content-Type':'application/json'},body:JSON.stringify({model:m,messages:[{role:"system",content:"JSON Array Only"},{role:"user",content:f}],temperature:0.7})});const d=await r.json(),txt=d.choices[0].message.content.replace(/```json|```/g,'').trim(),nd=JSON.parse(txt);p.data=ap?[...p.data,...nd]:nd;p.data.sort((a,b)=>a.time.localeCompare(b.time));saveRoles();renderTimeline();showToast('å®Œæˆ');}catch(e){alert(e.message);}finally{l.style.display='none';b1.disabled=b2.disabled=false;}
      }

      function renderTimeline(){
        const b=document.getElementById('schedule-result-area'),d=getActivePage()?.data||[];
        b.innerHTML=d.length?'':'<div style="text-align:center;color:#aaa;padding:20px">æš‚æ— æ•°æ®</div>';
        d.forEach((i,x)=>{const c=document.createElement('div');c.className='timeline-card';c.id=`card-${x}`;c.innerHTML=`<div class="t-header"><div class="t-time">${i.time}</div><div style="font-size:20px">${i.icon||'ğŸ“±'}</div></div><div class="t-desc">${i.description}</div>${i.html_snippet||''}<div class="card-actions"><button class="card-btn copy" onclick="copySingleItem(${x})">å¤åˆ¶</button><button class="card-btn edit" onclick="editItem(${x})">âœï¸</button><button class="card-btn del" onclick="delItem(${x})">ğŸ—‘ï¸</button></div>`;b.appendChild(c);});
        updateRealTimeStatus();
      }
      function copySingleItem(i){const it=getActivePage().data[i],txt=`${it.time} ${it.description}`;navigator.clipboard.writeText(txt).then(()=>showToast("å·²å¤åˆ¶"));}
      function editItem(i){const d=getActivePage().data,v=prompt("ä¿®æ”¹:",d[i].description);if(v){d[i].description=v;saveRoles();renderTimeline();}}
      function delItem(i){if(confirm("åˆ é™¤?")){getActivePage().data.splice(i,1);saveRoles();renderTimeline();}}
      
      function updateRealTimeStatus(){
        const d=getActivePage()?.data||[];if(!d.length)return;const now=new Date(),curM=now.getHours()*60+now.getMinutes();let aidx=-1;
        document.querySelectorAll('.timeline-card').forEach(c=>c.classList.remove('active-now'));
        for(let i=0;i<d.length;i++){const[h,m]=d[i].time.split(':').map(Number);if(curM>=h*60+m)aidx=i;else break;}
        if(aidx!==-1)document.getElementById(`card-${aidx}`)?.classList.add('active-now');
        const p=getActivePage(),tp={...p,exportMode:'past'},tf={...p,exportMode:'future'};
        document.getElementById('rt-past').innerText=getStatusStringForPage(tp,curM,true).join('')||"ï¼ˆæ— ï¼‰";
        document.getElementById('rt-future').innerText=getStatusStringForPage(tf,curM,true).join('')||"ï¼ˆæ— ï¼‰";
      }
      function getStatusStringForPage(p,curM,isE){
        if(!p.data||!p.data.length)return[];let idx=-1;
        for(let i=0;i<p.data.length;i++){const[h,m]=p.data[i].time.split(':').map(Number);if(curM>=h*60+m)idx=i;else break;}
        const cn=document.getElementById('char-name').value||"TA", res=[], fmt=(t,min,act,tm)=>t.replace(/\${min}/g,min).replace(/\${char}/g,cn).replace(/\${act}/g,act).replace(/\${time}/g,tm);
        if(idx!==-1&&(!isE||p.exportMode!=='future')){const it=p.data[idx],[h,m]=it.time.split(':').map(Number);res.push(fmt(globalSettings.tplPast,curM-(h*60+m),it.description,it.time));}
        if((!isE||p.exportMode!=='past')){let ni=idx===-1?0:idx+1;if(ni<p.data.length){const it=p.data[ni],[h,m]=it.time.split(':').map(Number);res.push(fmt(globalSettings.tplFuture,(h*60+m)-curM,it.description,it.time));}}
        return res;
      }
      function copyGlobalContext(){
        const now=new Date(),curM=now.getHours()*60+now.getMinutes(),r=getActiveRole(),all=[];
        r.pages.forEach(p=>{if(p.exportEnabled!==false){const s=getStatusStringForPage(p,curM,true);if(s.length)all.push(s.join("ï¼›"));}});
        const txt=globalSettings.copyTemplate.replace("${currTime}",now.toLocaleString()).replace("${timercontent}",all.join("\n"));
        navigator.clipboard.writeText(txt).then(()=>showToast("å·²å¤åˆ¶")).catch(()=>showToast("å¤±è´¥"));
      }
      function exportData(){const d={};Object.keys(STORAGE_KEYS).forEach(k=>d[k]=localStorage.getItem(STORAGE_KEYS[k]));const b=new Blob([JSON.stringify(d)],{type:'application/json'}),a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`backup_${new Date().toISOString().slice(0,10)}.json`;a.click();}
      function importData(i){const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{try{const d=JSON.parse(e.target.result);Object.keys(d).forEach(k=>localStorage.setItem(k,d[k]));alert("å¯¼å…¥æˆåŠŸ");location.reload();}catch(x){alert("é”™è¯¯")}};r.readAsText(f);}
    </script>
  </body>
</html>

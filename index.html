<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=5.0, user-scalable=yes"
    />
    <title>EPhone PWA</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="apple-touch-icon"
      href="https://i.postimg.cc/Fz25WLbr/7D99384EE38C42D2BA98F53E4582FEA8.jpg"
    />
    <link rel="manifest" href="manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="EPhone" />
    <meta name="mobile-web-app-capable" content="yes" />
    <link
      rel="icon"
      type="image/png"
      href="https://i.postimg.cc/Fz25WLbr/7D99384EE38C42D2BA98F53E4582FEA8.jpg"
    />
    <meta name="theme-color" content="#f0f2f5" />

    <style>
      /* --- æ ¸å¿ƒé…è‰²ï¼šèœ‚èœœé»„æ²¹ & ç„¦ç³–å¤å¤ --- */
      :root {
        --bg-color: #fdfbf7; /* æš–ç±³ç™½ */
        --glass-base: rgba(255, 253, 240, 0.65); /* å¥¶æ²¹åº•è‰²ç»ç’ƒ */
        --border-color: #efe6d5; /* æŸ”å’Œçš„è¾¹æ¡†è‰² */
        --accent-gold: #e6ceac; /* å¤å¤é‡‘ */
        --text-brown: #8d6e63; /* ç„¦ç³–æ£•è‰²å­— */
        --text-deep: #5d4037; /* æ·±å’–å•¡è‰²å­— */
        --shadow-warm: 0 15px 30px rgba(210, 180, 140, 0.25); /* æš–æ£•è‰²æŠ•å½± */
        --font-main: 'Courier New', Courier, monospace; /* å¤å¤æ‰“å­—æœºå­—ä½“ */
      }

      html {
        height: 100%;
        -webkit-text-size-adjust: 100%;
      }
      body {
        margin: 0;
        font-family: var(--font-main);
        font-weight: bold;
        height: 100%;
        overflow: hidden;
        background-color: var(--bg-color);
        /* èƒŒæ™¯ï¼šææ·¡çš„å¤å¤æ ¼å­ */
        background-image: linear-gradient(rgba(230, 206, 172, 0.2) 1px, transparent 1px),
          linear-gradient(90deg, rgba(230, 206, 172, 0.2) 1px, transparent 1px);
        background-size: 40px 40px;
        color: var(--text-brown);
      }

      #phone-screen {
        width: 100%;
        height: 100vh;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
      }
      .screen {
        width: 100%;
        height: 100%;
        position: absolute;
        display: flex;
        flex-direction: column;
        transition: 0.3s;
      }
      #home-screen {
        padding-top: calc(30px + env(safe-area-inset-top));
        padding-bottom: 20px;
        box-sizing: border-box;
        z-index: 10;
      }
      #home-screen-pages-container {
        flex-grow: 1;
        width: 100%;
        height: 100%;
        position: relative;
      }
      #home-screen-pages {
        width: 100%;
        height: 100%;
        display: flex;
      }
      .home-screen-page {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      #main-content-area {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      /* --- æ’­æ”¾å™¨ä¸»ä½“ï¼šç²¾è‡´çš„å¥¶æ²¹æ–¹ç³– --- */
      #desktop-layout {
        width: 100%;
        display: flex;
        justify-content: center;
        padding: 0 15px;
        box-sizing: border-box;
      }

      #desktop-app-container {
        /* å®ä½“å¥¶æ²¹å¡‘æ–™è´¨æ„Ÿ */
        background: linear-gradient(to bottom, #fdfbf7 0%, #f4eadd 100%);
        /* å¡‘æ–™çš„åšå®è¾¹æ¡† */
        border: 1px solid #e0d0b8;
        /* æ¨¡æ‹Ÿå¡‘æ–™æ³¨å¡‘çš„åœ†æ¶¦æ„Ÿ */
        border-radius: 20px;
        /* ç¨å¾®å®½ä¸€ç‚¹ï¼Œç»™ç£å¸¦ç•™ç©ºé—´ */
        padding: 50px 35px 60px 35px;
        display: flex;
        gap: 35px; /* æ‹‰å¤§ä¸¤ä¸ªå·è½´çš„è·ç¦» */
        position: relative;
        /* ç«‹ä½“æŠ•å½±ï¼šåƒæ”¾åœ¨æ¡Œé¢ä¸Šä¸€æ · */
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8), /* é¡¶éƒ¨é«˜å…‰ */ inset 0 -3px 5px rgba(0, 0, 0, 0.05),
          /* åº•éƒ¨é˜´å½± */ 0 15px 35px rgba(141, 110, 99, 0.25), /* æ¡Œé¢æŠ•å½± */ 0 5px 10px rgba(0, 0, 0, 0.05);
        align-items: center;
        justify-content: center;
        min-width: 320px;
      }

      /* é¡¶éƒ¨é“­ç‰Œï¼šEPHONE MIX (å¤å¤é‡‘å±ç‰Œé£æ ¼) */
      #desktop-app-container::before {
        content: 'EPHONE MIX';
        position: absolute;
        top: 15px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 11px;
        font-family: Helvetica, Arial, sans-serif; /* é“­ç‰Œç”¨æ— è¡¬çº¿ä½“æ˜¾å¾—æ›´å·¥ä¸šå¤å¤ */
        color: #a1887f; /* æµ…å’–è‰²å­— */

        /* é“­ç‰ŒèƒŒæ™¯ï¼šåšæˆå‡¹è¿›å»çš„æµ…é‡‘è‰² */
        background: linear-gradient(to bottom, #fffcf5, #f1e9d2);
        padding: 4px 16px;
        border-radius: 4px;
        letter-spacing: 2px;
        font-weight: 900;

        /* é“­ç‰Œçš„ç«‹ä½“æ„Ÿ */
        border: 1px solid #d7ccc8;
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05), 0 1px 0 #fff;
        z-index: 10;
      }

      /* èºä¸é’‰ï¼šå¤å¤é»„é“œè‰² */
      .screw {
        position: absolute;
        width: 9px;
        height: 9px;
        background: linear-gradient(135deg, #e6ceac, #bf9e74); /* é‡‘å±å…‰æ³½ */
        border-radius: 50%;
        box-shadow: inset 1px 1px 2px rgba(255, 255, 255, 0.8), 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      /* ç»™èºä¸åŠ ä¸ªå°ä¸€å­—æ§½ï¼Œå¢åŠ ç²¾è‡´åº¦ */
      .screw::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 5px;
        height: 1px;
        background: rgba(93, 64, 55, 0.3);
      }

      .screw.tl {
        top: 12px;
        left: 12px;
      }
      .screw.tr {
        top: 12px;
        right: 12px;
      }
      .screw.bl {
        bottom: 12px;
        left: 12px;
      }
      .screw.br {
        bottom: 12px;
        right: 12px;
      }
      .tape-window-bg {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 240px; /* å˜å®½ï¼Œè¿æ¥ä¸¤ä¸ªå·è½´ */
        height: 90px;
        /* è´´çº¸è´¨æ„Ÿï¼šç±³é»„è‰² */
        background: #fffdf5;
        /* è´´çº¸è¾¹æ¡† */
        border: 2px solid #e6ceac;
        border-radius: 35px; /* å˜æˆèƒ¶å›Šå½¢çŠ¶ */
        z-index: 0;
        /* å†…éƒ¨çº¹ç†ï¼šæ¨ªçº¿ï¼Œåƒå¯ä»¥å†™å­—çš„åœ°æ–¹ */
        background-image: repeating-linear-gradient(transparent, transparent 19px, #f2e6d9 20px);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }

      /* --- å›¾æ ‡éƒ¨åˆ† --- */
      .desktop-app-icon {
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        width: 85px;
        -webkit-tap-highlight-color: transparent;
      }

      /* --- 1. ç£å¸¦å·è½´åŠ¨ç”»ä¸è´¨æ„Ÿ --- */

      /* å®šä¹‰æ—‹è½¬åŠ¨ç”» */
      @keyframes reel-spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .icon-bg-desktop {
        width: 76px;
        height: 76px;
        border-radius: 50%;
        /* å·è½´èƒŒæ™¯ï¼šæ·±è‰² */
        background: #3e2723;
        /* å…³é”®ï¼šé½¿è½®è¾¹æ¡†æ•ˆæœ */
        border: 4px dashed #d7ccc8;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5), /* å†…éƒ¨æ·±é‚ƒæ„Ÿ */ 0 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        transition: transform 0.3s;
        position: relative;
      }
      /* ç»™å›¾ç‰‡ä¸€ç‚¹å†…ç¼©ï¼Œéœ²å‡ºé½¿è½® */
      .icon-bg-desktop img {
        width: 86%;
        height: 86%;
        object-fit: cover;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.2);
        animation: reel-spin 10s linear infinite;
        opacity: 0.95;
      }
      /* ç£å¸¦åº•éƒ¨çš„æ¢¯å½¢åŒºåŸŸ */
      .tape-bottom-deco {
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 220px;
        height: 35px;
        /* é¢œè‰²ç¨å¾®æ·±ä¸€ç‚¹ï¼Œæ¨¡æ‹Ÿç£å¸¦ä¸‹åŠéƒ¨åˆ† */
        background: #f0e6d2;
        /* åšæˆæ¢¯å½¢æ•ˆæœ */
        clip-path: polygon(10% 0%, 90% 0%, 100% 100%, 0% 100%);
        border-top: 1px solid #e0d0b8;
        z-index: 5;
      }

      /* è£…é¥°æ€§çš„å°å­” */
      .tape-holes {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 120px;
        height: 12px;
        display: flex;
        justify-content: space-between;
      }
      .tape-holes::before,
      .tape-holes::after {
        content: '';
        width: 12px;
        height: 12px;
        background: #5d4037; /* æ·±å­”é¢œè‰² */
        border-radius: 50%;
        box-shadow: inset 1px 1px 2px rgba(0, 0, 0, 0.3);
      }

      /* å›¾ç‰‡åº”ç”¨æ—‹è½¬åŠ¨ç”» */
      .icon-bg-desktop img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
        /* è¿™é‡Œæ·»åŠ åŠ¨ç”»ï¼š10ç§’è½¬ä¸€åœˆï¼Œçº¿æ€§æ— é™å¾ªç¯ */
        animation: reel-spin 10s linear infinite;
        opacity: 0.9; /* ç¨å¾®é€æ˜ä¸€ç‚¹æ›´æœ‰å¤å¤æ„Ÿ */
      }

      /* ç»™å·è½´åŠ ä¸€ä¸ªä¸­å¿ƒè½´è£…é¥°ï¼Œçœ‹èµ·æ¥æ›´åƒç£å¸¦ */
      .icon-bg-desktop::after {
        content: '';
        position: absolute;
        width: 12px;
        height: 12px;
        background: #fff;
        border-radius: 50%;
        z-index: 5;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      }
      .icon-bg-desktop img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
      }

      /* æ ‡ç­¾ï¼šå¤å¤æ‰“å­—æœºçº¸æ¡ */
      .desktop-app-icon .label {
        font-size: 12px;
        color: var(--text-deep);
        /* ç±³é»„è‰²çº¸å¼ æ„Ÿ */
        background: #fffdf0;
        padding: 3px 8px;
        border: 1px solid #efe6d5;
        border-radius: 2px; /* å‡ ä¹ç›´è§’ */
        box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.05);
        font-weight: bold;
        transform: rotate(-2deg); /* å¾®å¾®æ­ª */
      }
      .desktop-app-icon:last-child .label {
        transform: rotate(1deg);
      }

      .desktop-app-icon:active .icon-bg-desktop {
        transform: scale(0.92);
      }

      /* App çª—å£ */
      .app-window {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background: #fff;
        z-index: 50;
        display: none;
        flex-direction: column;
        opacity: 0;
        transform: scale(0.95);
        transition: 0.3s;
      }
      .app-window.active {
        display: flex;
        opacity: 1;
        transform: scale(1);
      }
      .app-iframe {
        width: 100%;
        height: 100%;
        border: none;
        background: #fff;
      }

      /* --- å³ä¸‹è§’å”±ç‰‡æŒ‰é’®ï¼šèœ‚èœœé»„èƒ¶ --- */
      #fab-container {
        position: fixed;
        bottom: 50px;
        right: 25px;
        z-index: 1000;
        width: 64px;
        height: 64px;
      }

      #fab-main {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        /* ä¿®æ”¹é¢œè‰²ï¼šä½¿ç”¨æ›´æŸ”å’Œçš„å¤å¤é‡‘è‰² */
        background-color: #eecfa1;

        /* ä¿®æ”¹çº¹ç†ï¼šè®©çº¹ç†å¯¹æ¯”åº¦ä½ä¸€ç‚¹ï¼Œæ›´ç²¾è‡´ */
        background-image: repeating-radial-gradient(
          #eecfa1 0,
          #eecfa1 2px,
          #e0b878 3px,
          /* ç¨å¾®æ·±ä¸€ç‚¹çš„é‡‘ */ #eecfa1 4px
        );

        /* é˜´å½±ç¨å¾®åŠ æ·±ä¸€ç‚¹ */
        box-shadow: 0 0 0 3px #fff, 0 6px 15px rgba(161, 136, 127, 0.4);
        box-shadow: 0 0 0 3px #fff, 0 6px 15px rgba(251, 192, 45, 0.3);
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: 0.4s;
        position: relative;
      }

      /* ä¸­é—´æ ‡ç­¾ */
      #fab-main::before {
        content: '';
        position: absolute;
        width: 26px;
        height: 26px;
        background: #fff8e1; /* å¥¶ç™½è‰²æ ‡ç­¾ */
        border-radius: 50%;
        z-index: 1;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      /* ä¸­é—´å­” */
      #fab-main::after {
        content: '';
        position: absolute;
        width: 6px;
        height: 6px;
        background: var(--text-deep);
        border-radius: 50%;
        z-index: 2;
      }
      #fab-main svg {
        width: 18px;
        height: 18px;
        fill: var(--text-deep);
        z-index: 3;
        position: relative;
        transition: 0.3s;
      }

      #fab-main:active {
        transform: rotate(15deg) scale(0.95);
      }
      #fab-main.expanded {
        transform: rotate(90deg);
        background: #fff;
        background-image: none;
      }
      #fab-main.expanded::before,
      #fab-main.expanded::after {
        opacity: 0;
      }

      /* èœå• */
      .fab-actions {
        position: absolute;
        bottom: 80px;
        right: 0;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 12px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(15px);
        transition: 0.3s;
        pointer-events: none;
        width: max-content;
      }
      #fab-container.menu-open .fab-actions {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
        pointer-events: auto;
      }

      .fab-mini-btn {
        width: 44px;
        height: 44px;
        background: #fff;
        border-radius: 50%;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        color: var(--text-brown);
        font-size: 14px;
        border: 1px solid #f0f0f0;
        padding: 0; /* å»æ‰å†…è¾¹è· */
        overflow: hidden; /* ç¡®ä¿å›¾ç‰‡ä¸æº¢å‡º */
        background: #fff;
      }
      /* å›¾ç‰‡å¡«æ»¡æŒ‰é’® */
      .fab-mini-btn img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* SVG å›¾æ ‡å¤§å°é€‚é… */
      .fab-mini-btn svg {
        width: 20px;
        height: 20px;
        fill: var(--text-deep); /* ä½¿ç”¨æ·±æ£•è‰²å¡«å…… */
      }
      .fab-label {
        background: #fff;
        color: var(--text-deep);
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        margin-right: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        font-weight: bold;
      }

      /* éšèº«æ¨¡å¼ */
      #fab-container.ghost-mode {
        opacity: 0; /* å®Œå…¨é€æ˜ï¼Œçœ‹ä¸è§ */
        pointer-events: none; /* é¼ æ ‡ç©¿é€ï¼Œç‚¹ä¸åˆ°åŸä½ç½® */
      }

      #fab-container.ghost-mode .fab-actions {
        display: none;
      }

      /* Toast */
      #toast-msg {
        position: fixed;
        bottom: 50px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: var(--text-deep);
        color: #fff;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 13px;
        opacity: 0;
        visibility: hidden;
        transition: 0.3s;
        z-index: 2000;
      }
      #toast-msg.show {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0);
      }

      /* â˜…â˜…â˜…â˜…â˜… è¿™é‡Œæ˜¯ä½ è¦å¤åˆ¶è¿›å»çš„ä»£ç  å¼€å§‹ â˜…â˜…â˜…â˜…â˜… */
      /* è¾¹ç¼˜æ„Ÿåº”å±‚æ ·å¼ */
      .edge-sensor {
        position: fixed;
        z-index: 1500; /* å¿…é¡»æ¯”Appé«˜ */
        background: transparent; /* é€æ˜çœ‹ä¸è§ */
      }
      /* é¡¶éƒ¨æ„Ÿåº”æ¡ */
      .edge-sensor.top { top: 0; left: 0; width: 100%; height: 30px; }
      /* åº•éƒ¨æ„Ÿåº”æ¡ */
      .edge-sensor.bottom { bottom: 0; left: 0; width: 100%; height: 30px; }
      /* å·¦ä¾§æ„Ÿåº”æ¡ */
      .edge-sensor.left { top: 30px; bottom: 30px; left: 0; width: 15px; }
      /* å³ä¾§æ„Ÿåº”æ¡ */
      .edge-sensor.right { top: 30px; bottom: 30px; right: 0; width: 15px; }
      /* â˜…â˜…â˜…â˜…â˜… è¿™é‡Œæ˜¯ä½ è¦å¤åˆ¶è¿›å»çš„ä»£ç  ç»“æŸ â˜…â˜…â˜…â˜…â˜… */


    </style>
  </head>
  <body>
    <div id="phone-screen">
      <!-- çŠ¶æ€æ  HTML å·²ç§»é™¤ -->

      <!-- ä¸»å±å¹• (Home Screen) -->
      <div id="home-screen" class="screen">
        <div id="home-screen-pages-container">
          <div id="home-screen-pages">
            <div class="home-screen-page">
              <div id="main-content-area">
                <div id="desktop-layout">
                  <div id="desktop-app-container">
                    <!-- è£…é¥°ï¼šå››ä¸ªè§’çš„èºä¸é’‰ -->
                    <div class="screw tl"></div>
                    <div class="screw tr"></div>
                    <div class="screw bl"></div>
                    <div class="screw br"></div>

                    <!-- ã€æ–°å¢ã€‘ç£å¸¦åº•éƒ¨çš„æ¢¯å½¢è£…é¥°ï¼Œæ›´æœ‰ç£å¸¦å‘³ -->
                    <div class="tape-bottom-deco">
                      <div class="tape-holes"></div>
                    </div>

                    <!-- è£…é¥°ï¼šä¸­é—´çš„ç£å¸¦è§†çª—èƒŒæ™¯ -->
                    <div class="tape-window-bg"></div>

                    <!-- å·¦å·è½´ï¼š330 -->
                    <div class="desktop-app-icon" onclick="openApp('app-a')">
                      <div class="icon-bg-desktop">
                        <img
                          src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg"
                          alt="330"
                        />
                      </div>
                      <span class="label">330</span>
                    </div>

                    <!-- å³å·è½´ï¼šå…”K -->
                    <div class="desktop-app-icon" onclick="openApp('app-b')">
                      <div class="icon-bg-desktop">
                        <img
                          src="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg"
                          alt="å…”K"
                        />
                      </div>
                      <span class="label">å…”K</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="app-a" class="app-window app-frame">
        <iframe data-src="https://kittykitty0v0.github.io/sfsfdf/" src="" class="app-iframe"></iframe>
      </div>

      <div id="app-b" class="app-window app-frame">
        <iframe data-src="https://kittykitty0v0.github.io/-k-/" src="" class="app-iframe"></iframe>
      </div>

      <!-- æ‚¬æµ®æŒ‰é’® -->
      <div id="fab-container">
        <div class="fab-actions">
          <!-- 330 æŒ‰é’®ï¼šæ¢æˆå›¾ç‰‡ -->
          <div class="fab-action-btn" onclick="openApp('app-a')">
            <span class="fab-label">330</span>
            <div class="fab-mini-btn">
              <img
                src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg"
                alt="330"
              />
            </div>
          </div>

          <!-- å…”K æŒ‰é’®ï¼šæ¢æˆå›¾ç‰‡ -->
          <div class="fab-action-btn" onclick="openApp('app-b')">
            <span class="fab-label">å…”K</span>
            <div class="fab-mini-btn">
              <img src="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg" alt="å…”K" />
            </div>
          </div>

          <!-- éšè—æŒ‰é’®ï¼šæ¢æˆ SVG (çœ¼ç›å…³é—­å›¾æ ‡) -->
          <div class="fab-action-btn" onclick="hideFab()">
            <span class="fab-label">éšè—</span>
            <div class="fab-mini-btn">
              <svg viewBox="0 0 24 24">
                <path
                  d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46A11.804 11.804 0 0 0 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"
                />
              </svg>
            </div>
          </div>

          <!-- ä¸»é¡µæŒ‰é’®ï¼šæ¢æˆ SVG (æˆ¿å­å›¾æ ‡) -->
          <div class="fab-action-btn" onclick="goHome()">
            <span class="fab-label">ä¸»é¡µ</span>
            <div class="fab-mini-btn">
              <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" /></svg>
            </div>
          </div>
        </div>

        <div id="fab-main"></div>
      </div>

    <!-- â˜…â˜…â˜…â˜…â˜… è¿™é‡Œæ˜¯ä½ è¦å¤åˆ¶è¿›å»çš„ä»£ç  å¼€å§‹ â˜…â˜…â˜…â˜…â˜… -->
    <!-- å…¨å±è¾¹ç¼˜æ„Ÿåº”å±‚ (ç”¨äºåœ¨Appå†…åŒå‡»å”¤é†’) -->
    <div class="edge-sensor top"></div>
    <div class="edge-sensor bottom"></div>
    <div class="edge-sensor left"></div>
    <div class="edge-sensor right"></div>
    <!-- â˜…â˜…â˜…â˜…â˜… è¿™é‡Œæ˜¯ä½ è¦å¤åˆ¶è¿›å»çš„ä»£ç  ç»“æŸ â˜…â˜…â˜…â˜…â˜… -->

      <div id="toast-msg"></div>
    </div>

    <script>
      const fabContainer = document.getElementById('fab-container');
      const fabMain = document.getElementById('fab-main');

      // è¿™é‡ŒæŠŠåŸæ¥çš„ id="home-screen" å¯¹åº”ç»™ launcherScreen
      const launcherScreen = document.getElementById('home-screen');

      // è·å–æ‰€æœ‰çš„ App çª—å£
      const frames = document.querySelectorAll('.app-frame');
      const toastMsg = document.getElementById('toast-msg');

      // å›¾æ ‡å®šä¹‰
      const menuIconSvg =
        '<svg viewBox="0 0 24 24"><path d="M4 18h16c.55 0 1-.45 1-1s-.45-1-1-1H4c-.55 0-1 .45-1 1s.45 1 1 1zm0-5h16c.55 0 1-.45 1-1s-.45-1-1-1H4c-.55 0-1 .45-1 1s.45 1 1 1zM3 7c0 .55.45 1 1 1h16c.55 0 1-.45 1-1s-.45-1-1-1H4c-.55 0-1 .45-1 1z"/></svg>';
      const closeIconSvg =
        '<svg viewBox="0 0 24 24"><path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7a.996.996 0 1 0-1.41 1.41L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/></svg>';

      // åˆå§‹åŒ–å›¾æ ‡
      fabMain.innerHTML = menuIconSvg;

      // --- 2. æ ¸å¿ƒåŠŸèƒ½é€»è¾‘ ---

      function openApp(frameId) {
        document.body.classList.add('app-open');

        // éšè—ä¸»å±å¹• (æ¨¡æ‹Ÿ)
        launcherScreen.style.opacity = '0';
        launcherScreen.style.transform = 'scale(0.95)';

        frames.forEach(frame => {
          if (frame.id === frameId) {
            // æ¿€æ´»å½“å‰ App
            frame.style.display = 'flex';
            setTimeout(() => frame.classList.add('active'), 10);

            // æ ¸å¿ƒçœæµé€»è¾‘ï¼šå¦‚æœ src ç©ºæ‰èµ‹å€¼
            const iframe = frame.querySelector('iframe');
            if (iframe && iframe.dataset.src) {
              iframe.src = iframe.dataset.src;
            }
          } else {
            // å…³é—­å…¶ä»– App
            frame.classList.remove('active');
            frame.style.display = 'none';
            const iframe = frame.querySelector('iframe');
            if (iframe) iframe.src = ''; // æ¸…ç†å†…å­˜
          }
        });
        closeMenu();
      }

      function goHome() {
        document.body.classList.remove('app-open');

        // æ¢å¤ä¸»å±å¹•
        launcherScreen.style.opacity = '1';
        launcherScreen.style.transform = 'scale(1)';

        // å…³é—­æ‰€æœ‰ App
        setTimeout(() => {
          frames.forEach(frame => {
            frame.classList.remove('active');
            frame.style.display = 'none';
            // æ¸…ç† iframe
            const iframe = frame.querySelector('iframe');
            if (iframe) iframe.src = '';
          });
        }, 300);
        closeMenu();

        // å›åˆ°ä¸»é¡µæ—¶ï¼Œå¦‚æœå¤„äºéšèº«æ¨¡å¼ï¼Œè‡ªåŠ¨æ¢å¤æ˜¾ç¤ºï¼ˆå¯é€‰ï¼Œå·²æ³¨é‡Šï¼‰
        // showFab();
      }

      // --- [ä¿®æ”¹] éšè—åŠŸèƒ½ ---
      function hideFab() {
        closeMenu();

        // 1. è·å–å½“å‰ä½ç½®å¹¶å›ºå®šï¼ˆä¿æŒä¸å˜ï¼Œé˜²æ­¢ä¹±è·‘ï¼‰
        const mainRect = fabMain.getBoundingClientRect();
        fabContainer.style.left = mainRect.left + 'px';
        fabContainer.style.top = mainRect.top + 'px';
        fabContainer.style.bottom = 'auto';
        fabContainer.style.right = 'auto';

        // 2. å¼€å¯éšèº«æ¨¡å¼
        fabContainer.classList.add('ghost-mode');

        // ä¿®æ”¹è¿™é‡Œçš„æç¤ºæ–‡å­—
        showToast('å·²éšè—ã€‚åŒå‡»å±å¹•é¡¶éƒ¨æˆ–è€…åº•éƒ¨å”¤å‡ºã€‚');
      }

      // æ¢å¤æ˜¾ç¤º
      function showFab() {
        fabContainer.classList.remove('ghost-mode');
      }

      function showToast(text) {
        toastMsg.innerText = text;
        toastMsg.classList.add('show');
        setTimeout(() => {
          toastMsg.classList.remove('show');
        }, 3000);
      }

      function toggleMenu() {
        // å¦‚æœå¤„äºéšèº«æ¨¡å¼ï¼Œç‚¹å‡»ä¸»æŒ‰é’®å°±æ˜¯â€œç°èº«â€
        if (fabContainer.classList.contains('ghost-mode')) {
          showFab();
          // ç°èº«çš„åŒæ—¶ç›´æ¥å±•å¼€èœå•ï¼Œä½“éªŒæ›´æµç•…
          setTimeout(() => {
            fabContainer.classList.add('menu-open');
            fabMain.classList.add('expanded');
            fabMain.innerHTML = closeIconSvg;
          }, 50);
          return;
        }

        fabContainer.classList.toggle('menu-open');
        fabMain.classList.toggle('expanded');

        if (fabMain.classList.contains('expanded')) {
          fabMain.innerHTML = closeIconSvg;
        } else {
          fabMain.innerHTML = menuIconSvg;
        }
      }

      function closeMenu() {
        fabContainer.classList.remove('menu-open');
        fabMain.classList.remove('expanded');
        fabMain.innerHTML = menuIconSvg;
      }

      document.addEventListener('click', e => {
        // åªæœ‰åœ¨èœå•æ‰“å¼€ä¸”ç‚¹å‡»å¤–éƒ¨æ—¶æ‰å…³é—­
        // å¦‚æœæ˜¯éšèº«æ¨¡å¼ç‚¹å‡»äº†ç©ºç™½å¤„ï¼Œä¸éœ€è¦åšä»»ä½•äº‹
        if (!fabContainer.contains(e.target) && fabContainer.classList.contains('menu-open')) {
          closeMenu();
        }
      });

      // --- æ‹–æ‹½åŠŸèƒ½ (ä¿æŒä¸å˜ï¼ŒåŠ äº†éšèº«åˆ¤æ–­) ---
      let isDragging = false;
      let hasMoved = false;
      let startX, startY, initialLeft, initialTop;
      const dragThreshold = 5;

      fabMain.addEventListener('mousedown', startDrag);
      fabMain.addEventListener('touchstart', startDrag, { passive: false });

      function startDrag(e) {
        // å¦‚æœæ˜¯éšèº«æ¨¡å¼ï¼Œç¦æ­¢æ‹–æ‹½ï¼Œåªå…è®¸ç‚¹å‡»
        if (fabContainer.classList.contains('ghost-mode')) {
          return;
        }

        if (fabContainer.classList.contains('menu-open')) {
          closeMenu();
        }

        isDragging = true;
        hasMoved = false;

        if (e.type === 'touchstart') {
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
        } else {
          startX = e.clientX;
          startY = e.clientY;
        }

        const rect = fabContainer.getBoundingClientRect();
        initialLeft = rect.left;
        initialTop = rect.top;

        // å…³é”®ï¼šæ‹–æ‹½å¼€å§‹æ—¶ï¼Œå°†å®šä½åˆ‡æ¢ä¸º left/topï¼Œé˜²æ­¢ CSS bottom/right å¹²æ‰°
        fabContainer.style.bottom = 'auto';
        fabContainer.style.right = 'auto';
        fabContainer.style.left = initialLeft + 'px';
        fabContainer.style.top = initialTop + 'px';

        document.addEventListener('mousemove', onDrag);
        document.addEventListener('touchmove', onDrag, { passive: false });
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);
      }

      function onDrag(e) {
        if (!isDragging) return;
        e.preventDefault();

        let clientX, clientY;
        if (e.type === 'touchmove') {
          clientX = e.touches[0].clientX;
          clientY = e.touches[0].clientY;
        } else {
          clientX = e.clientX;
          clientY = e.clientY;
        }

        const deltaX = clientX - startX;
        const deltaY = clientY - startY;

        if (Math.abs(deltaX) > dragThreshold || Math.abs(deltaY) > dragThreshold) {
          hasMoved = true;
        }

        fabContainer.style.left = initialLeft + deltaX + 'px';
        fabContainer.style.top = initialTop + deltaY + 'px';
      }

      function stopDrag() {
        isDragging = false;
        document.removeEventListener('mousemove', onDrag);
        document.removeEventListener('touchmove', onDrag);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchend', stopDrag);
      }

      fabMain.addEventListener('click', e => {
        e.stopPropagation();
        // æ— è®ºæ˜¯æ‹–æ‹½ç»“æŸè¿˜æ˜¯æ™®é€šç‚¹å‡»ï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿä½ç§»ï¼Œéƒ½è§†ä¸ºç‚¹å‡»
        if (!hasMoved) {
          toggleMenu();
        }
      });

      // SW æ³¨å†Œ
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          // --- [æ–°å¢] åŒå‡»å±å¹•é¡¶éƒ¨æˆ–è€…åº•éƒ¨å”¤å‡º ---

          // 1. ç”µè„‘ç«¯åŒå‡» (dblclick)
          document.addEventListener('dblclick', () => {
            if (fabContainer.classList.contains('ghost-mode')) {
              showFab();
              showToast('å·²å”¤å‡ºèœå•');
            }
          });

          // 2. æ‰‹æœºç«¯åŒå‡» (é€šè¿‡ç›‘å¬ä¸¤æ¬¡è§¦æ‘¸çš„æ—¶é—´é—´éš”)
          let lastTapTime = 0;
          document.addEventListener('touchend', e => {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTapTime;

            // å¦‚æœä¸¤æ¬¡ç‚¹å‡»é—´éš”å°äº 300ms ä¸”å¤§äº 0ï¼Œè§†ä¸ºåŒå‡»
            if (tapLength < 300 && tapLength > 0) {
              if (fabContainer.classList.contains('ghost-mode')) {
                showFab();
                showToast('å·²å”¤å‡ºèœå•');
                e.preventDefault(); // é˜²æ­¢åŒå‡»è§¦å‘ç¼©æ”¾ç­‰é»˜è®¤è¡Œä¸º
              }
            }
            lastTapTime = currentTime;
          });
          navigator.serviceWorker.register('sw.js');
        });
      }
    </script>
    <style>
  /* å¤åˆ» index(2) é£æ ¼çš„æ·±è‰²æ‚¬æµ®çª— */
  #tuki-ultimate-panel {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 350px;
    height: 85vh;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 10px;
    color: #eee;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    box-shadow: -5px 0 15px rgba(0,0,0,0.5);
    font-family: "Segoe UI", sans-serif;
    transition: transform 0.3s ease;
  }
  
  /* æœ€å°åŒ–/ä¿é™©æ “æ¨¡å¼ */
  #tuki-ultimate-panel.minimized {
    height: 50px;
    width: 50px;
    border-radius: 50%;
    overflow: hidden;
    cursor: pointer;
    background: #d32f2f; /* çº¢è‰²è¡¨ç¤ºå…³é—­/ä¿é™©ä¸Šé” */
    box-shadow: 0 0 10px #ff0000;
  }
  #tuki-ultimate-panel.minimized .panel-body,
  #tuki-ultimate-panel.minimized .panel-footer { display: none; }
  #tuki-ultimate-panel.minimized::after {
    content: "ğŸ”’";
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
  }

  /* æ ‡é¢˜æ  */
  .panel-header {
    padding: 10px 15px;
    background: #000;
    border-bottom: 1px solid #333;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 10px 10px 0 0;
  }
  .panel-title { font-weight: bold; font-size: 14px; color: #00e676; }
  .panel-controls span { cursor: pointer; margin-left: 10px; opacity: 0.7; }
  .panel-controls span:hover { opacity: 1; }

  /* å†…å®¹æ»šåŠ¨åŒº */
  .panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    font-size: 12px;
  }
  
  /* æ¿å—æ ·å¼ */
  .section-block {
    margin-bottom: 15px;
    background: #222;
    padding: 8px;
    border-radius: 5px;
    border: 1px solid #444;
  }
  .section-title {
    color: #888;
    margin-bottom: 5px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
  }
  
  /* è¾“å…¥æ¡†å’Œæ–‡æœ¬åŸŸ */
  .tuki-input, .tuki-textarea {
    width: 100%;
    background: #111;
    border: 1px solid #555;
    color: #ccc;
    padding: 5px;
    border-radius: 3px;
    font-size: 11px;
    font-family: monospace;
  }
  .tuki-textarea { height: 60px; resize: vertical; }
  .tuki-select { width: 100%; background: #111; color: #fff; padding: 5px; border: 1px solid #555; }

  /* åº•éƒ¨æ§åˆ¶åŒº */
  .panel-footer {
    padding: 10px;
    background: #111;
    border-top: 1px solid #333;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  /* æŒ‰é’® */
  .btn {
    border: none;
    padding: 8px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    color: white;
    text-align: center;
    transition: 0.2s;
  }
  .btn-sync { background: #1976d2; }
  .btn-timer { background: #e65100; }
  .btn-timer.armed { background: #2e7d32; animation: pulse 1s infinite; }
  
  @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

  /* çŠ¶æ€æ¡ */
  .status-bar { font-size: 10px; color: #666; text-align: right; margin-top: 2px; }
</style>

<div id="tuki-ultimate-panel" class="minimized">
  <div class="panel-header">
    <span class="panel-title">TUKI 330 å…¨å±€é…ç½®</span>
    <div class="panel-controls">
      <span onclick="TUKI_syncAll()" title="å¼ºåˆ¶ä»æ‰‹æœºåŒæ­¥æ•°æ®">ğŸ”„</span>
      <span onclick="TUKI_toggle()" title="å…³é—­å¹¶å¸è½½å­å¼¹">âœ–</span>
    </div>
  </div>

  <div class="panel-body">
    <div class="section-block">
      <div class="section-title">ğŸ“¡ API é¢„è®¾ (è‡ªåŠ¨è¯»å–)</div>
      <input type="text" id="sec-api-url" class="tuki-input" placeholder="APIåœ°å€" readonly>
      <input type="text" id="sec-api-model" class="tuki-input" placeholder="æ¨¡å‹åç§°" style="margin-top:5px;" readonly>
    </div>

    <div class="section-block">
      <div class="section-title">ğŸ‘¤ è§’è‰²ä¿¡æ¯ (å½“å‰å¯¹è¯)</div>
      <input type="text" id="sec-char-name" class="tuki-input" placeholder="è§’è‰²å">
      <div style="margin-top:5px;">è§’è‰²äººè®¾:</div>
      <textarea id="sec-char-persona" class="tuki-textarea"></textarea>
    </div>

    <div class="section-block">
      <div class="section-title">ğŸ§‘ ç”¨æˆ·äººè®¾</div>
      <textarea id="sec-user-persona" class="tuki-textarea"></textarea>
    </div>

    <div class="section-block">
      <div class="section-title">ğŸŒ ä¸–ç•Œä¹¦ (Worldbook)</div>
      <textarea id="sec-worldbook" class="tuki-textarea" placeholder="åŒæ­¥åæ˜¾ç¤ºç”Ÿæ•ˆçš„ä¸–ç•Œä¹¦æ¡ç›®"></textarea>
    </div>

    <div class="section-block">
      <div class="section-title">ğŸ’¬ å†å²å¯¹è¯ (Context)</div>
      <textarea id="sec-history" class="tuki-textarea" placeholder="æœ€è¿‘çš„å¯¹è¯è®°å½•..."></textarea>
    </div>

    <div class="section-block">
      <div class="section-title">ğŸ§  è§’è‰²è®°å¿† (Memory)</div>
      <textarea id="sec-memory" class="tuki-textarea"></textarea>
    </div>
    
    <div class="section-block">
      <div class="section-title">ğŸ”Š è¯­éŸ³è®¾ç½®</div>
      <input type="text" id="sec-voice" class="tuki-input" placeholder="è¯­éŸ³ID / é…ç½®">
    </div>
  </div>

  <div class="panel-footer">
    <div style="display:flex; gap:10px; align-items:center;">
      <span style="font-size:12px; color:#aaa;">â±ï¸ å€’è®¡æ—¶(ç§’):</span>
      <input type="number" id="timer-val" value="10" style="width:50px; background:#222; border:1px solid #444; color:#fff; padding:4px;">
      <span id="timer-display" style="font-family:monospace; color:#ff9800; font-size:16px; font-weight:bold;">00:00</span>
    </div>
    
    <button id="btn-timer-action" class="btn btn-timer" onclick="TUKI_startTimer()">ğŸš€ å¯åŠ¨è®¡æ—¶ (ç»“æŸåè‡ªåŠ¨è£…å¡«)</button>
    <div class="status-bar" id="tuki-status">ç­‰å¾…æ“ä½œ...</div>
  </div>
</div>

<script>
// ================== TUKI æ ¸å¿ƒé€»è¾‘ ==================

const TUKI = {
  iframe: null,
  timerId: null,
  isArmed: false, // æ˜¯å¦å·²è£…å¡«å­å¼¹
  bulletContent: null, // å­å¼¹å†…å®¹ (F)
  
  // åˆå§‹åŒ–ï¼šå¯»æ‰¾å°æ‰‹æœº iframe
  init: function() {
    setInterval(() => {
      const iframe = document.querySelector('iframe');
      if (iframe && iframe.contentWindow && !iframe.contentWindow._tukiHooked) {
        try {
          this.iframe = iframe;
          this.injectHook(iframe.contentWindow);
          iframe.contentWindow._tukiHooked = true;
          this.status("å·²è¿æ¥åˆ°å°æ‰‹æœºï¼Œå‡†å¤‡åŒæ­¥");
          // è¿æ¥æˆåŠŸåè‡ªåŠ¨åŒæ­¥ä¸€æ¬¡
          setTimeout(() => this.syncAll(), 1500);
        } catch (e) { console.error("è¿æ¥ç­‰å¾…ä¸­...", e); }
      }
    }, 2000);
  },

  // 1. æ³¨å…¥æ‹¦æˆªå™¨ (Hooks)
  injectHook: function(win) {
    const originalFetch = win.fetch;
    const _this = this;

    win.fetch = async function(url, options) {
      // æ£€æŸ¥æ˜¯å¦æ˜¯èŠå¤©è¯·æ±‚
      const isChat = url.includes('chat/completions') || url.includes('generate') || url.includes('v1/chat');

      // åªæœ‰åœ¨ã€å·²è£…å¡«ã€‘ä¸”æ˜¯èŠå¤©è¯·æ±‚æ—¶è§¦å‘
      if (_this.isArmed && _this.bulletContent && isChat && options && options.body) {
        try {
          console.log("[TUKI] æ‹¦æˆªæˆåŠŸï¼Œæ­£åœ¨æ’å…¥å­å¼¹...");
          let body = JSON.parse(options.body);

          // é’ˆå¯¹ OpenAI æ ¼å¼ (å¤§å¤šæ•°æƒ…å†µ)
          if (body.messages && Array.isArray(body.messages)) {
            const lastMsg = body.messages[body.messages.length - 1];
            if (lastMsg.role === 'user') {
              // ======================================
              // åŠ¨ä½œï¼šå°†é¢æ¿é‡Œçš„æ‰€æœ‰å†…å®¹ä½œä¸ºâ€œå­å¼¹â€æ’å…¥
              // ======================================
              // ä½ å¯ä»¥åœ¨è¿™é‡Œå†³å®šæ˜¯â€œè¿½åŠ â€è¿˜æ˜¯â€œå®Œå…¨æ›¿æ¢â€
              // æ ¹æ®ä½ çš„æè¿°â€œæ’å…¥Fâ€ï¼Œé€šå¸¸æŒ‡è¿½åŠ 
              lastMsg.content += "\n\n" + _this.bulletContent;
              
              options.body = JSON.stringify(body);
              
              if(win.showToast) win.showToast("âš¡ TUKI: é…ç½®å†…å®¹å·²æ³¨å…¥å‘é€ï¼");
              
              // å‘é€åè‡ªåŠ¨é€€è†› (ä¿é™©é‡ç½®)
              _this.disarm();
            }
          }
        } catch (e) {
          console.error("æ³¨å…¥å¤±è´¥:", e);
        }
      }
      return originalFetch.apply(this, arguments);
    };
  },

  // 2. æ•°æ®åŒæ­¥ï¼šä» Dexie DB æŠ“å–æ•°æ®å¡«å…¥é¢æ¿
  syncAll: async function() {
    if (!this.iframe) return;
    const db = this.iframe.contentWindow.db;
    if (!db) return this.status("æ— æ³•è¯»å–æ•°æ®åº“");

    this.status("æ­£åœ¨åŒæ­¥æ•°æ®...");
    
    try {
      // A. è¯»å– API
      const apis = await db.apiConfig.toArray();
      if(apis.length) {
        document.getElementById('sec-api-url').value = apis[0].proxyUrl || apis[0].host || '';
        document.getElementById('sec-api-model').value = apis[0].model || '';
      }

      // B. è¯»å–å½“å‰å¯¹è¯è§’è‰² (æŸ¥æ‰¾ lastTime æœ€å¤§çš„)
      const chats = await db.chats.orderBy('lastTime').reverse().limit(1).toArray();
      if (chats.length > 0) {
        const curChat = chats[0];
        document.getElementById('sec-char-name').value = curChat.name;
        
        // è¯»å–å…·ä½“äººè®¾ (npcs è¡¨)
        // å‡å¦‚ chats é‡Œå­˜äº† persona æœ€å¥½ï¼Œå¦‚æœæ²¡æœ‰å¯èƒ½éœ€è¦å» npcs è¡¨æŸ¥
        // è¿™é‡Œå‡è®¾ chats å­˜äº†åŸºç¡€ä¿¡æ¯ï¼Œè¯¦ç»†ä¿¡æ¯å» npcs æŸ¥
        let persona = curChat.persona || "";
        if (!persona && db.npcs) {
             const npc = await db.npcs.get(curChat.id);
             if(npc) persona = npc.persona || npc.description;
        }
        document.getElementById('sec-char-persona').value = persona;
        
        // C. å†å²è®°å½• (ç²—ç•¥è¯»å–æœ€åå‡ æ¡)
        // æ³¨æ„ï¼šmessages è¡¨å¯èƒ½å¾ˆå¤§ï¼Œéœ€è¦æ ¹æ® chat_id æŸ¥
        // è¿™é‡Œéœ€è¦çŸ¥é“ message è¡¨çš„ç»“æ„ï¼Œé€šå¸¸æ˜¯ db.messages.where('chat_id').equals(curChat.id)
        if (db.messages) {
            const msgs = await db.messages.where('chat_id').equals(curChat.id).reverse().limit(10).toArray();
            const historyText = msgs.reverse().map(m => `${m.role}: ${m.content}`).join('\n');
            document.getElementById('sec-history').value = historyText;
        }
      }

      // D. ç”¨æˆ·äººè®¾
      if (db.userSettings) {
         const users = await db.userSettings.toArray();
         if(users.length) document.getElementById('sec-user-persona').value = users[0].persona || users[0].description || "";
      }

      // E. ä¸–ç•Œä¹¦ (æŸ¥æ‰¾å½“å‰å¯¹è¯ç»‘å®šçš„ä¸–ç•Œä¹¦)
      // è¿™æ¯”è¾ƒå¤æ‚ï¼Œç®€å•èµ·è§ï¼Œåˆ—å‡ºæ‰€æœ‰æ¿€æ´»çš„ä¸–ç•Œä¹¦
      if (db.worldBooks) {
         const wbs = await db.worldBooks.toArray();
         const wbContent = wbs.map(w => `[${w.name}]: ${w.content}`).join('\n\n');
         document.getElementById('sec-worldbook').value = wbContent;
      }
      
      // F. è¯­éŸ³é…ç½®
      if (db.settings) {
          // å‡è®¾å­˜åœ¨ settings è¡¨
          const settings = await db.settings.toArray();
          // å°è¯•å¯»æ‰¾ minimax ç›¸å…³å­—æ®µ
          document.getElementById('sec-voice').value = "åŒæ­¥å®Œæˆ (è¯·æ£€æŸ¥è®¾ç½®è¡¨)"; 
      }

      this.status("âœ… åŒæ­¥å®Œæˆ");

    } catch (e) {
      console.error(e);
      this.status("âŒ åŒæ­¥å‡ºé”™ (è¯·çœ‹æ§åˆ¶å°)");
    }
  },

  // 3. æ„é€ â€œå­å¼¹â€ (F)
  // å°†é¢æ¿ä¸Šæ‰€æœ‰çš„å†…å®¹æ‹¼æ¥æˆä¸€ä¸ªå¤§æ–‡æœ¬
  buildBullet: function() {
    const fields = [
      { name: "ã€è§’è‰²è®¾å®šã€‘", val: document.getElementById('sec-char-persona').value },
      { name: "ã€ç”¨æˆ·è®¾å®šã€‘", val: document.getElementById('sec-user-persona').value },
      { name: "ã€ä¸–ç•Œä¹¦ã€‘", val: document.getElementById('sec-worldbook').value },
      { name: "ã€å†å²æ‘˜è¦ã€‘", val: document.getElementById('sec-history').value },
      { name: "ã€è®°å¿†ã€‘", val: document.getElementById('sec-memory').value }
    ];

    // è¿‡æ»¤ç©ºå€¼å¹¶æ‹¼æ¥
    return fields
      .filter(f => f.val && f.val.trim() !== "")
      .map(f => `${f.name}\n${f.val}`)
      .join('\n\n');
  },

  // 4. è®¡æ—¶å™¨é€»è¾‘
  startTimer: function() {
    const secInput = document.getElementById('timer-val').value;
    let seconds = parseInt(secInput);
    
    // å¦‚æœå·²ç»åœ¨è®¡æ—¶ï¼Œå…ˆé‡ç½®
    if (this.timerId) clearInterval(this.timerId);
    
    const btn = document.getElementById('btn-timer-action');
    const display = document.getElementById('timer-display');
    
    btn.innerText = "â³ è®¡æ—¶ä¸­...";
    btn.classList.remove('armed');
    this.status(`å€’è®¡æ—¶ ${seconds} ç§’...`);

    this.timerId = setInterval(() => {
      seconds--;
      display.innerText = `00:${seconds < 10 ? '0'+seconds : seconds}`;
      
      if (seconds <= 0) {
        clearInterval(this.timerId);
        // === æ—¶é—´åˆ°ï¼Œè£…å¡«å­å¼¹ ===
        this.arm();
      }
    }, 1000);
  },

  // è£…å¡« (Arm)
  arm: function() {
    // æ”¶é›†é¢æ¿æ•°æ®
    this.bulletContent = this.buildBullet();
    this.isArmed = true;
    
    const btn = document.getElementById('btn-timer-action');
    btn.innerText = "âš ï¸ å­å¼¹å·²ä¸Šè†› (ç‚¹å‡»æ‰‹æœºå‘é€è§¦å‘)";
    btn.classList.add('armed'); // é—ªçƒæ•ˆæœ
    this.status("å·²å°±ç»ªï¼šä¸‹æ¬¡å‘é€å°†åŒ…å«é¢æ¿æ‰€æœ‰å†…å®¹");
    
    // å¯ä»¥åœ¨æ‰‹æœºé‡Œå¼¹ä¸ªæç¤º
    if (this.iframe.contentWindow.showToast) 
        this.iframe.contentWindow.showToast("â±ï¸ é…ç½®å†…å®¹å·²è£…å¡«ï¼Œç‚¹å‡»å‘é€å³å¯æ³¨å…¥ï¼");
  },

  // é€€è†› (Disarm) - ä¹Ÿæ˜¯ä¿é™©æ “é€»è¾‘
  disarm: function() {
    this.isArmed = false;
    this.bulletContent = null;
    
    const btn = document.getElementById('btn-timer-action');
    btn.innerText = "ğŸš€ å¯åŠ¨è®¡æ—¶ (ç»“æŸåè‡ªåŠ¨è£…å¡«)";
    btn.classList.remove('armed');
    document.getElementById('timer-display').innerText = "00:00";
    this.status("å¾…æœºä¸­");
    
    if (this.timerId) clearInterval(this.timerId);
  },
  
  // å¼€å…³é¢æ¿ (ä¿é™©æ “)
  toggle: function() {
    const panel = document.getElementById('tuki-ultimate-panel');
    if (panel.classList.contains('minimized')) {
      // æ‰“å¼€
      panel.classList.remove('minimized');
    } else {
      // å…³é—­ï¼ˆæœ€å°åŒ–ï¼‰ = è§¦å‘ä¿é™©æ “
      panel.classList.add('minimized');
      this.disarm(); // å…³é”®ï¼šå…³é—­æ—¶å–æ¶ˆè£…å¡«
      this.status("ğŸ”’ ä¿é™©å·²ä¸Šï¼Œå­å¼¹å·²å¸è½½");
    }
  },

  status: function(msg) {
    document.getElementById('tuki-status').innerText = msg;
  }
};

// ç‚¹å‡»å›¾æ ‡å±•å¼€
document.getElementById('tuki-ultimate-panel').onclick = function(e) {
    // åªæœ‰åœ¨æœ€å°åŒ–çŠ¶æ€ä¸‹ç‚¹å‡»æ‰å±•å¼€ï¼Œé¿å…åœ¨é¢æ¿å†…éƒ¨æ“ä½œæ—¶è¯¯è§¦
    if(this.classList.contains('minimized')) {
        TUKI.toggle();
    }
};

// å¯åŠ¨
TUKI.init();

</script>
  </body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=5.0, user-scalable=yes"
    />
    <title>EPhone PWA Ultimate</title>
    <link rel="stylesheet" href="style.css" /> 
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="theme-color" content="#f0f2f5" />

    <style>
      /* --- æ ¸å¿ƒé…è‰²ï¼šèœ‚èœœé»„æ²¹ & ç„¦ç³–å¤å¤ --- */
      :root {
        --bg-color: #fdfbf7;
        --text-brown: #8d6e63;
        --text-deep: #5d4037;
        --font-main: 'Courier New', Courier, monospace;
      }

      html, body {
        height: 100%; margin: 0; font-family: var(--font-main);
        overflow: hidden; background-color: var(--bg-color);
        background-image: linear-gradient(rgba(230, 206, 172, 0.2) 1px, transparent 1px),
          linear-gradient(90deg, rgba(230, 206, 172, 0.2) 1px, transparent 1px);
        background-size: 40px 40px; color: var(--text-brown);
        -webkit-user-select: none; user-select: none; /* é˜²æ­¢é•¿æŒ‰é€‰ä¸­æ–‡æœ¬å¹²æ‰°æ‹–æ‹½ */
      }

      /* é€šç”¨å¸ƒå±€ä¸åŠ¨ç”» */
      #phone-screen { width: 100%; height: 100vh; display: flex; flex-direction: column; position: relative; overflow: hidden; }
      .screen { width: 100%; height: 100%; position: absolute; display: flex; flex-direction: column; transition: 0.3s; }
      #home-screen { padding-top: calc(30px + env(safe-area-inset-top)); z-index: 10; }
      
      /* æ¡Œé¢å¸ƒå±€ */
      #desktop-layout { display: flex; justify-content: center; padding: 0 15px; margin-top: 50px;}
      #desktop-app-container {
        background: linear-gradient(to bottom, #fdfbf7 0%, #f4eadd 100%);
        border: 1px solid #e0d0b8; border-radius: 20px;
        padding: 50px 35px 60px 35px; display: flex; gap: 35px; position: relative;
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.8), 0 15px 35px rgba(141,110,99,0.25);
        min-width: 320px; justify-content: center;
      }
      #desktop-app-container::before {
        content: 'EPHONE MIX'; position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
        font-size: 11px; font-family: Helvetica, Arial, sans-serif; color: #a1887f;
        background: linear-gradient(to bottom, #fffcf5, #f1e9d2); padding: 4px 16px;
        border-radius: 4px; letter-spacing: 2px; font-weight: 900;
        border: 1px solid #d7ccc8; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
      }
      /* è£…é¥°èºä¸ä¸ç£å¸¦å…ƒç´  */
      .screw { position: absolute; width: 9px; height: 9px; background: linear-gradient(135deg, #e6ceac, #bf9e74); border-radius: 50%; box-shadow: inset 1px 1px 2px rgba(255,255,255,0.8); }
      .screw::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 5px; height: 1px; background: rgba(93, 64, 55, 0.3); }
      .screw.tl { top: 12px; left: 12px; } .screw.tr { top: 12px; right: 12px; }
      .screw.bl { bottom: 12px; left: 12px; } .screw.br { bottom: 12px; right: 12px; }
      .tape-window-bg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 240px; height: 90px; background: #fffdf5; border: 2px solid #e6ceac; border-radius: 35px; z-index: 0; background-image: repeating-linear-gradient(transparent, transparent 19px, #f2e6d9 20px); }
      .tape-bottom-deco { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 220px; height: 35px; background: #f0e6d2; clip-path: polygon(10% 0%, 90% 0%, 100% 100%, 0% 100%); border-top: 1px solid #e0d0b8; z-index: 5; }
      .tape-holes { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 120px; height: 12px; display: flex; justify-content: space-between; }
      .tape-holes::before, .tape-holes::after { content: ''; width: 12px; height: 12px; background: #5d4037; border-radius: 50%; }

      /* å›¾æ ‡æ ·å¼ */
      .desktop-app-icon { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; gap: 12px; cursor: pointer; width: 85px; -webkit-tap-highlight-color: transparent; }
      .icon-bg-desktop { width: 76px; height: 76px; border-radius: 50%; background: #3e2723; border: 4px dashed #d7ccc8; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative; }
      @keyframes reel-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
      .icon-bg-desktop img { width: 86%; height: 86%; object-fit: cover; border-radius: 50%; animation: reel-spin 10s linear infinite; opacity: 0.95; border: 1px solid rgba(255,255,255,0.2); pointer-events: none; }
      .icon-bg-desktop svg { width: 50%; height: 50%; fill: #eceff1; }
      .desktop-app-icon .label { font-size: 12px; color: var(--text-deep); background: #fffdf0; padding: 3px 8px; border: 1px solid #efe6d5; border-radius: 2px; box-shadow: 1px 1px 3px rgba(0,0,0,0.05); font-weight: bold; transform: rotate(-2deg); }
      
      /* App çª—å£ä½“ç³» */
      .app-window { width: 100%; height: 100%; position: absolute; top: 0; left: 0; background: #fff; z-index: 50; display: none; flex-direction: column; opacity: 0; transform: scale(0.95); transition: 0.3s; }
      .app-window.active { display: flex; opacity: 1; transform: scale(1); }
      .app-iframe { width: 100%; height: 100%; border: none; background: #fff; }

      /* --- 3. æ™ºèƒ½æ‚¬æµ®çª— (Flow Widget) v2.0 --- */
      #flow-widget {
        position: fixed; top: 100px; right: 20px; z-index: 9999;
        display: none; /* é»˜è®¤éšè—ï¼Œç”±å¼€å…³æ§åˆ¶ */
        user-select: none;
        touch-action: none; /* å…è®¸JSæ¥ç®¡è§¦æ‘¸ */
      }
      
      /* é€šç”¨å¡ç‰‡æ ·å¼ï¼šé«˜çº§ç°åŠé€æ˜ */
      .flow-card-base {
        background: rgba(40, 40, 40, 0.75); /* æ·±ç°åŠé€æ˜ */
        backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        border-radius: 24px; /* æ›´åœ†æ¶¦ */
        padding: 0; /* å†…éƒ¨æ§åˆ¶padding */
        color: #ffffff;
        cursor: move; /* æŒ‡ç¤ºå¯æ‹–åŠ¨ */
        overflow: hidden;
        transition: width 0.3s, transform 0.1s;
      }
      .flow-card-base:active { transform: scale(0.98); background: rgba(60, 60, 60, 0.85); }

      /* è¯¦ç»†å±•ç¤ºæ¨¡å¼ï¼šå•è¡Œæ»šåŠ¨ */
      .flow-mode-detail {
        height: 44px; /* å›ºå®šé«˜åº¦ */
        display: flex; align-items: center;
        padding: 0 15px;
        position: relative;
      }
      .marquee-container {
        width: 100%; overflow: hidden; white-space: nowrap; position: relative;
      }
      .marquee-text {
        display: inline-block;
        font-size: 13px; font-weight: 500; letter-spacing: 0.5px;
        animation: marquee-scroll 10s linear infinite;
        padding-left: 100%; /* åˆå§‹ä½ç½®åœ¨å³ä¾§å¤– */
      }
      @keyframes marquee-scroll { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

      /* ä¸å‰§é€æ¨¡å¼ï¼šå‘¼å¸æ•ˆæœ */
      .flow-mode-simple {
        padding: 10px 15px;
        text-align: center; min-width: 100px;
      }
      .breathing-anim { animation: breathe 3s ease-in-out infinite; }
      @keyframes breathe { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
      .simple-name { font-size: 14px; font-weight: bold; color: #ffecb3; }
      .simple-time { font-size: 11px; opacity: 0.8; margin-top: 2px; }

      /* å›¾æ ‡æ¨¡å¼ */
      .flow-mode-icon img {
        display: block; border-radius: 50%; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        pointer-events: none; /* å›¾ç‰‡ä¸æ‹¦æˆªäº‹ä»¶ï¼Œäº‹ä»¶ç»™çˆ¶çº§ */
      }

      /* è®¾ç½®é¢æ¿æ ·å¼ */
      .schedule-container { padding: 60px 20px 120px 20px; height: 100%; overflow-y: auto; box-sizing: border-box; }
      .schedule-header { font-size: 20px; color: #5d4037; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px dashed #e6ceac; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
      .settings-group { margin-bottom: 20px; background: rgba(255, 255, 255, 0.5); padding: 15px; border-radius: 12px; border: 1px solid #efe6d5; }
      .settings-title { font-size: 14px; color: #8d6e63; margin-bottom: 10px; font-weight: bold; border-left: 3px solid #e6ceac; padding-left: 8px; }
      .input-row { margin-bottom: 10px; }
      .input-label { font-size: 12px; color: #5d4037; margin-bottom: 4px; display: block; }
      .custom-input, .custom-textarea { width: 100%; padding: 8px; border: 1px solid #e0d0b8; border-radius: 6px; background: #fffdf5; font-size: 13px; color: #3e2723; box-sizing: border-box; outline: none; }
      .preset-bar { display: flex; gap: 8px; margin-bottom: 10px; background: #fffdf5; padding: 8px; border-radius: 8px; border: 1px dashed #d7ccc8; align-items: center; }
      .preset-select { flex: 1; padding: 6px; border: 1px solid #e0d0b8; border-radius: 4px; background: #fff; font-size: 12px; }
      .icon-btn { width: 30px; height: 30px; border: 1px solid #d7ccc8; background: #fff; border-radius: 4px; cursor: pointer; display: flex; justify-content: center; align-items: center; color: #8d6e63; }
      
      /* è§’è‰²ä¸æ—¶é—´è¡¨æ ·å¼ */
      .role-bar { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; background: #efe6d5; padding: 8px; border-radius: 8px; }
      .mini-btn { width: 24px; height: 24px; border: 1px solid #d7ccc8; background: #fff; border-radius: 4px; display: flex; justify-content: center; align-items: center; cursor: pointer; color: #8d6e63; font-size: 12px; }
      .tabs-header { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; border-bottom: 1px solid #efe6d5; }
      .tab-item { padding: 6px 12px; background: #fff; border: 1px solid #e0d0b8; border-radius: 6px 6px 0 0; font-size: 12px; color: #8d6e63; cursor: pointer; white-space: nowrap; }
      .tab-item.active { background: #eecfa1; color: #5d4037; font-weight: bold; border-bottom: 1px solid #eecfa1; }
      
      .timeline-card { background: #fff; border: 1px solid #efe6d5; border-radius: 12px; padding: 15px; margin-bottom: 15px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.03); transition: 0.3s; }
      .timeline-card.active-now { border: 2px solid #ffb74d; background: #fff3e0; transform: scale(1.02); z-index: 2; box-shadow: 0 8px 20px rgba(255, 183, 77, 0.3); }
      .t-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
      .t-time { font-family: monospace; font-weight: 900; font-size: 16px; color: #5d4037; background: #eecfa1; padding: 2px 8px; border-radius: 4px; }
      .t-desc { font-size: 14px; color: #4e342e; line-height: 1.5; white-space: pre-wrap; }
      .card-actions { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; display: flex; justify-content: flex-end; gap: 10px; }
      .card-btn { font-size: 11px; padding: 4px 8px; border-radius: 4px; cursor: pointer; border: 1px solid transparent; background: transparent; }
      .card-btn.copy { color: #2e7d32; border-color: #a5d6a7; background: #e8f5e9; } /* ç»¿è‰²å¤åˆ¶æŒ‰é’® */
      
      /* FAB æ ·å¼ */
      #fab-container { position: fixed; bottom: 50px; right: 25px; z-index: 1000; width: 64px; height: 64px; }
      #fab-main { width: 100%; height: 100%; border-radius: 50%; background-color: #eecfa1; background-image: repeating-radial-gradient(#eecfa1 0, #eecfa1 2px, #e0b878 3px, #eecfa1 4px); box-shadow: 0 0 0 3px #fff, 0 6px 15px rgba(251, 192, 45, 0.3); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.4s; position: relative; }
      #fab-main::before { content: ''; position: absolute; width: 26px; height: 26px; background: #fff8e1; border-radius: 50%; z-index: 1; }
      #fab-main::after { content: ''; position: absolute; width: 6px; height: 6px; background: var(--text-deep); border-radius: 50%; z-index: 2; }
      #fab-main svg { width: 18px; height: 18px; fill: var(--text-deep); z-index: 3; position: relative; }
      #fab-main.expanded { transform: rotate(90deg); background: #fff; background-image: none; }
      #fab-main.expanded::before, #fab-main.expanded::after { opacity: 0; }
      
      .fab-actions { position: absolute; bottom: 80px; right: 0; display: flex; flex-direction: column; align-items: flex-end; gap: 12px; opacity: 0; visibility: hidden; transform: translateY(15px); transition: 0.3s; pointer-events: none; width: max-content; }
      #fab-container.menu-open .fab-actions { opacity: 1; visibility: visible; transform: translateY(0); pointer-events: auto; }
      .fab-action-btn { display: flex; align-items: center; cursor: pointer; }
      .fab-mini-btn { width: 44px; height: 44px; background: #fff; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.08); display: flex; justify-content: center; align-items: center; border: 1px solid #f0f0f0; overflow: hidden; }
      .fab-mini-btn img { width: 100%; height: 100%; object-fit: cover; }
      .fab-mini-btn svg { width: 20px; height: 20px; fill: var(--text-deep); }
      .fab-label { background: #fff; color: var(--text-deep); padding: 5px 10px; border-radius: 4px; font-size: 12px; margin-right: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: bold; }
      #fab-container.ghost-mode { opacity: 0; pointer-events: none; }
      
      #toast-msg { position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--text-deep); color: #fff; padding: 10px 20px; border-radius: 6px; font-size: 13px; opacity: 0; visibility: hidden; transition: 0.3s; z-index: 2000; }
      #toast-msg.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
      
      .edge-sensor { position: fixed; z-index: 1500; background: transparent; }
      .edge-sensor.top { top: 0; left: 0; width: 100%; height: 30px; }
      .edge-sensor.bottom { bottom: 0; left: 0; width: 100%; height: 30px; }
    </style>
  </head>
  <body>
    <div id="phone-screen">
      <div id="home-screen" class="screen">
        <div id="home-screen-pages-container">
          <div id="home-screen-pages">
            <div class="home-screen-page">
              <div id="main-content-area">
                <div id="desktop-layout">
                  <div id="desktop-app-container">
                    <div class="screw tl"></div><div class="screw tr"></div><div class="screw bl"></div><div class="screw br"></div>
                    <div class="tape-bottom-deco"><div class="tape-holes"></div></div>
                    <div class="tape-window-bg"></div>
                    <div class="desktop-app-icon" onclick="openApp('app-a')">
                      <div class="icon-bg-desktop"><img src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg" /></div>
                      <span class="label">330</span>
                    </div>
                    <div class="desktop-app-icon" onclick="openApp('app-b')">
                      <div class="icon-bg-desktop"><img src="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg" /></div>
                      <span class="label">å…”K</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="app-a" class="app-window app-frame"><iframe data-src="https://kittykitty0v0.github.io/sfsfdf/" src="" class="app-iframe"></iframe></div>
      <div id="app-b" class="app-window app-frame"><iframe data-src="https://kittykitty0v0.github.io/-k-/" src="" class="app-iframe"></iframe></div>

      <div id="flow-widget"></div>

      <div id="app-settings" class="app-window app-frame">
        <div class="schedule-container">
          <div class="schedule-header">
            <span>âš™ï¸ ç»ˆç«¯é…ç½®</span>
            <div>
              <button class="icon-btn" onclick="exportData()" title="å¯¼å‡ºå¤‡ä»½">ğŸ’¾</button>
              <button class="icon-btn" onclick="document.getElementById('import-file').click()" title="å¯¼å…¥å¤‡ä»½" style="margin-left:5px;">ğŸ“‚</button>
              <input type="file" id="import-file" style="display:none" onchange="importData(this)">
            </div>
          </div>

          <div class="settings-group">
            <div class="settings-title" style="color:#d84315;">ğŸ’¡ æ™ºèƒ½æ‚¬æµ®çª— (Flow Window)</div>
            <div class="input-row"><label class="input-label">å±•ç¤ºæ¨¡å¼</label>
              <select id="flow-mode" class="custom-input" onchange="saveGlobalSettings()">
                <option value="detail">è¯¦ç»†å±•ç¤º (åŠé€æ˜æ»šåŠ¨)</option>
                <option value="simple">ä¸å‰§é€å±•ç¤º (åå­—+æ—¶é—´ å‘¼å¸æ•ˆæœ)</option>
                <option value="icon">ä»…å›¾æ ‡å±•ç¤º</option>
              </select>
            </div>
            <div class="input-row"><label class="input-label">æ‚¬æµ®çª—å®½åº¦ (è¯¦ç»†æ¨¡å¼px)</label><input type="number" id="flow-width" class="custom-input" value="200" onchange="saveGlobalSettings()"></div>
            <div class="input-row"><label class="input-label">ç”Ÿæ•ˆæ—¶é—´èŒƒå›´ (å‰åXåˆ†é’Ÿ)</label><input type="number" id="flow-range" class="custom-input" value="15" onchange="saveGlobalSettings()"></div>
            <div class="input-row"><label class="input-label">å¸¸è§„å›¾æ ‡URL</label><input type="text" id="flow-icon-normal" class="custom-input" value="https://i.postimg.cc/B6FkXGCL/15.png" onchange="saveGlobalSettings()"></div>
            <div class="input-row"><label class="input-label">æ´»è·ƒå›¾æ ‡URL</label><input type="text" id="flow-icon-active" class="custom-input" value="https://i.postimg.cc/1tF2fZKF/16.png" onchange="saveGlobalSettings()"></div>
            <div class="input-row"><label class="input-label">å›¾æ ‡å°ºå¯¸(px)</label><input type="number" id="flow-icon-size" class="custom-input" value="50" onchange="saveGlobalSettings()"></div>
          </div>

          <div class="settings-group">
            <div class="settings-title" style="color:#d84315;">ğŸ“‹ å¤åˆ¶ä¸æ–‡æ¡ˆè®¾ç½®</div>
            <div class="preset-bar">
              <select id="copytext-preset-select" class="preset-select" onchange="loadPreset('copytext', this.value)"><option value="">-- æ–°å»º/é€‰æ‹©æ–‡æ¡ˆé¢„è®¾ --</option></select>
              <button class="icon-btn" onclick="savePreset('copytext')">ğŸ’¾</button> <button class="icon-btn" onclick="deletePreset('copytext')">ğŸ—‘ï¸</button>
            </div>
            <div class="input-row"><label class="input-label">é…ç½®åç§° (ä¿å­˜ç”¨)</label><input type="text" id="copytext-preset-name" class="custom-input"></div>
            <div class="input-row"><label class="input-label">å…¨å±€å¤åˆ¶æ¨¡æ¿ (å« ${timercontent})</label><textarea id="global-copy-template" class="custom-textarea" style="height:120px;"></textarea></div>
            <div class="input-row"><label class="input-label">è¿‡å»äº‹ä»¶æ ¼å¼</label><input type="text" id="status-tpl-past" class="custom-input"></div>
            <div class="input-row"><label class="input-label">æœªæ¥äº‹ä»¶æ ¼å¼</label><input type="text" id="status-tpl-future" class="custom-input"></div>
            <div style="text-align:right;"><button class="icon-btn" onclick="saveGlobalSettings()" style="width:auto; padding:0 10px;">ğŸ’¾ åº”ç”¨å½“å‰æ–‡æ¡ˆ</button></div>
          </div>

          <div class="settings-group">
            <div class="settings-title">ğŸ“¡ API è¿æ¥</div>
            <div class="preset-bar">
              <select id="api-preset-select" class="preset-select" onchange="loadPreset('api', this.value)"><option value="">-- æ–°å»º/é€‰æ‹© --</option></select>
              <button class="icon-btn" onclick="savePreset('api')">ğŸ’¾</button> <button class="icon-btn" onclick="deletePreset('api')">ğŸ—‘ï¸</button>
            </div>
            <div class="input-row"><label class="input-label">API Host</label><input type="text" id="api-host" class="custom-input" placeholder="https://api.openai.com"></div>
            <div class="input-row"><label class="input-label">API Key</label><input type="password" id="api-key" class="custom-input" placeholder="sk-..."></div>
            <div class="input-row"><label class="input-label">Model</label><div style="display:flex; gap:5px;"><input type="text" id="model-name" class="custom-input"><button class="icon-btn" onclick="fetchModels()">ğŸ”„</button></div><select id="model-list-dropdown" class="custom-input" style="display:none; margin-top:5px;" onchange="document.getElementById('model-name').value=this.value"></select></div>
            <div class="input-row"><label class="input-label">é…ç½®åç§°</label><input type="text" id="api-preset-name" class="custom-input"></div>
          </div>
          <div style="height:100px;"></div>
        </div>
      </div>

      <div id="app-schedule" class="app-window app-frame">
        <div class="schedule-container">
          <div class="role-bar">
            <span>ğŸ­</span>
            <select id="role-select" class="custom-input" style="padding:4px; font-weight:bold;" onchange="switchRole(this.value)"></select>
            <button class="mini-btn" onclick="addNewRole()">+</button>
            <button class="mini-btn" onclick="renameRole()">âœ</button>
            <button class="mini-btn" onclick="deleteRole()" style="color:#e57373;">ğŸ—‘ï¸</button>
          </div>
          <div class="tabs-header" id="timer-tabs"></div>
          <div style="text-align:right; margin-bottom:10px;">
             <button class="card-btn" onclick="addNewPage()" style="border:1px solid #aaa;">+ é¡µç­¾</button>
             <button class="card-btn" onclick="deleteCurrentPage()" style="color:red;">ğŸ—‘ï¸ åˆ é™¤é¡µç­¾</button>
          </div>
          <div id="realtime-status-panel" style="display:none;"></div> 
          
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <button class="icon-btn" onclick="renderTimeline()" title="åˆ·æ–°">ğŸ”„</button>
            <span style="font-size:12px; color:#999;">ç‚¹å‡»å•æ¡ç›®å¯å¤åˆ¶</span>
          </div>

          <div id="schedule-result-area"></div>
          <div style="height:100px;"></div>
        </div>
      </div>
      
      <div id="fab-container">
        <div class="fab-actions">
          <div class="fab-action-btn" onclick="openApp('app-a')">
            <span class="fab-label">330</span><div class="fab-mini-btn"><img src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg" /></div>
          </div>
          <div class="fab-action-btn" onclick="openApp('app-b')">
            <span class="fab-label">å…”K</span><div class="fab-mini-btn"><img src="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg" /></div>
          </div>
          <div class="desktop-app-icon" onclick="openApp('app-settings')">
             <div class="icon-bg-desktop" style="background: #455a64; width:50px; height:50px; border-width:2px;"><svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.04.24.24.41.48.41h3.84c.24 0 .43-.17.47-.41l.36-2.54c.59-.24 1.13-.57 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg></div>
             <span class="fab-label" style="margin-right:0; margin-left:10px; order:-1;">é…ç½®</span>
          </div>
          <div class="desktop-app-icon" onclick="openApp('app-schedule')">
             <div class="icon-bg-desktop" style="background: #e6ceac; width:50px; height:50px; border-width:2px;"><span style="font-size:20px;">â±ï¸</span></div>
             <span class="fab-label" style="margin-right:0; margin-left:10px; order:-1;">è®¡æ—¶</span>
          </div>
          <div class="fab-action-btn" onclick="toggleFlowWindow()">
            <span class="fab-label">æ‚¬æµ®çª—å¼€å…³</span><div class="fab-mini-btn" style="background:#b3e5fc;"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg></div>
          </div>
          <div class="fab-action-btn" onclick="hideFab()">
            <span class="fab-label">éšè—</span><div class="fab-mini-btn"><svg viewBox="0 0 24 24"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46A11.804 11.804 0 0 0 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27z"/></svg></div>
          </div>
          <div class="fab-action-btn" onclick="goHome()">
            <span class="fab-label">ä¸»é¡µ</span><div class="fab-mini-btn"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" /></svg></div>
          </div>
        </div>
        <div id="fab-main"></div>
      </div>

      <div class="edge-sensor top"></div><div class="edge-sensor bottom"></div>
      <div id="toast-msg"></div>
    </div>

    <script>
      /* --- 1. åŸºç¡€ UI é€»è¾‘ --- */
      const fabContainer = document.getElementById('fab-container');
      const fabMain = document.getElementById('fab-main');
      const launcherScreen = document.getElementById('home-screen');
      const frames = document.querySelectorAll('.app-frame');
      const toastMsg = document.getElementById('toast-msg');
      const menuIconSvg = '<svg viewBox="0 0 24 24"><path d="M4 18h16c.55 0 1-.45 1-1s-.45-1-1-1H4c-.55 0-1 .45-1 1s.45 1 1 1zm0-5h16c.55 0 1-.45 1-1s-.45-1-1-1H4c-.55 0-1 .45-1 1s.45 1 1 1zM3 7c0 .55.45 1 1 1h16c.55 0 1-.45 1-1s-.45-1-1-1H4c-.55 0-1 .45-1 1z"/></svg>';
      const closeIconSvg = '<svg viewBox="0 0 24 24"><path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7a.996.996 0 1 0-1.41 1.41L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/></svg>';
      fabMain.innerHTML = menuIconSvg;

      function openApp(frameId) {
        document.body.classList.add('app-open');
        launcherScreen.style.opacity = '0'; launcherScreen.style.transform = 'scale(0.95)';
        frames.forEach(frame => {
          if (frame.id === frameId) {
            frame.style.display = 'flex'; setTimeout(() => frame.classList.add('active'), 10);
            const iframe = frame.querySelector('iframe'); if (iframe && iframe.dataset.src) iframe.src = iframe.dataset.src;
          } else {
            frame.classList.remove('active'); frame.style.display = 'none';
            const iframe = frame.querySelector('iframe'); if (iframe) iframe.src = '';
          }
        });
        closeMenu();
      }

      function goHome() {
        document.body.classList.remove('app-open');
        launcherScreen.style.opacity = '1'; launcherScreen.style.transform = 'scale(1)';
        setTimeout(() => { frames.forEach(frame => { frame.classList.remove('active'); frame.style.display = 'none'; const iframe = frame.querySelector('iframe'); if(iframe) iframe.src = ''; }); }, 300);
        closeMenu();
      }

      function hideFab() { closeMenu(); const r = fabMain.getBoundingClientRect(); fabContainer.style.left = r.left + 'px'; fabContainer.style.top = r.top + 'px'; fabContainer.style.bottom = 'auto'; fabContainer.style.right = 'auto'; fabContainer.classList.add('ghost-mode'); showToast('å·²éšè—ã€‚åŒå‡»å±å¹•é¡¶éƒ¨/åº•éƒ¨å”¤å‡ºã€‚'); }
      function showFab() { fabContainer.classList.remove('ghost-mode'); }
      function showToast(text) { toastMsg.innerText = text; toastMsg.classList.add('show'); setTimeout(() => toastMsg.classList.remove('show'), 3000); }
      function toggleMenu() { if(fabContainer.classList.contains('ghost-mode')){ showFab(); setTimeout(()=>{fabContainer.classList.add('menu-open'); fabMain.classList.add('expanded'); fabMain.innerHTML = closeIconSvg;},50); return; } fabContainer.classList.toggle('menu-open'); fabMain.classList.toggle('expanded'); fabMain.innerHTML = fabMain.classList.contains('expanded') ? closeIconSvg : menuIconSvg; }
      function closeMenu() { fabContainer.classList.remove('menu-open'); fabMain.classList.remove('expanded'); fabMain.innerHTML = menuIconSvg; }
      document.addEventListener('click', e => { if (!fabContainer.contains(e.target) && fabContainer.classList.contains('menu-open')) closeMenu(); });

      // FAB æ‹–æ‹½é€»è¾‘
      let isDragging = false, hasMoved = false, startX, startY, initialLeft, initialTop;
      fabMain.addEventListener('mousedown', startDrag); fabMain.addEventListener('touchstart', startDrag, { passive: false });
      function startDrag(e) {
        if(fabContainer.classList.contains('ghost-mode')) return;
        if(fabContainer.classList.contains('menu-open')) closeMenu();
        isDragging = true; hasMoved = false;
        const pt = e.type === 'touchstart' ? e.touches[0] : e;
        startX = pt.clientX; startY = pt.clientY;
        const rect = fabContainer.getBoundingClientRect(); initialLeft = rect.left; initialTop = rect.top;
        fabContainer.style.bottom = 'auto'; fabContainer.style.right = 'auto'; fabContainer.style.left = initialLeft + 'px'; fabContainer.style.top = initialTop + 'px';
        document.addEventListener('mousemove', onDrag); document.addEventListener('touchmove', onDrag, { passive: false });
        document.addEventListener('mouseup', stopDrag); document.addEventListener('touchend', stopDrag);
      }
      function onDrag(e) {
        if (!isDragging) return; e.preventDefault();
        const pt = e.type === 'touchmove' ? e.touches[0] : e;
        const dx = pt.clientX - startX; const dy = pt.clientY - startY;
        if (Math.abs(dx) > 5 || Math.abs(dy) > 5) hasMoved = true;
        fabContainer.style.left = initialLeft + dx + 'px'; fabContainer.style.top = initialTop + dy + 'px';
      }
      function stopDrag() { isDragging = false; document.removeEventListener('mousemove', onDrag); document.removeEventListener('touchmove', onDrag); document.removeEventListener('mouseup', stopDrag); document.removeEventListener('touchend', stopDrag); }
      fabMain.addEventListener('click', e => { e.stopPropagation(); if (!hasMoved) toggleMenu(); });

      // åŒå‡»å”¤é†’
      document.addEventListener('dblclick', () => { if(fabContainer.classList.contains('ghost-mode')) showFab(); });
      let lastTapTime = 0;
      document.addEventListener('touchend', e => { const ct = new Date().getTime(); const tl = ct - lastTapTime; if (tl < 300 && tl > 0 && fabContainer.classList.contains('ghost-mode')) { showFab(); e.preventDefault(); } lastTapTime = ct; });

      /* --- 2. æ ¸å¿ƒæ•°æ®ç®¡ç† v2.0 --- */
      let timerPages = [];
      let activeRoleId = 0; 
      let activePageIndex = 0;
      let roles = [];
      let globalSettings = {
        copyTemplate: "æ­¤æ¡å†…å®¹æ˜¯aiå†™ä½œæŒ‡å¯¼ï¼Œè§’è‰²ä¸å¯è§ã€‚ä»¥ä¸‹æ˜¯è§’è‰²åŸæœ¬çš„æ—¥ç¨‹è®¡åˆ’ï¼Œæ³¨æ„è§’è‰²å¯èƒ½ä¹‹å‰ä¹‹åéƒ½ä¸æŒ‰ç…§åŸè®¡åˆ’è¿›è¡Œï¼Œè¯·ä½ æ ¹æ®ä¸Šä¸‹æ–‡è¯­å¢ƒè¿›è¡Œåˆ¤æ–­å‰§æƒ…å‘å±•ï¼š\n${timercontent}\nå¿…é¡»æ ¹æ®ä¸Šä¸‹æ–‡åˆ¤æ–­è§’è‰²æ˜¯å¦ä¹‹å‰æˆ–ä¹‹åè¿›è¡ŒåŸè®¡åˆ’ï¼Œä»¥åŠæ ¹æ®å½“å‰å¯¹è¯åœºæ™¯è§’è‰²æ˜¯å¦ä¼šæåŠæ­¤äº‹ï¼Œè§’è‰²ä¹Ÿå¯èƒ½å·²ç»å¿˜è®°æ­¤äº‹æˆ–ç›´æ¥æ ¹æœ¬ä¸æã€‚ä½ ä½œä¸ºaiå¿…é¡»è‡ªè¡Œåˆ¤æ–­åšå‡ºæœ‰æ´»äººæ„Ÿçš„ååº”ä¸ç»“æœã€‚",
        tplPast: "${min}åˆ†é’Ÿå‰ï¼Œ${char}åŸè®¡åˆ’æ˜¯${act}",
        tplFuture: "${min}åˆ†é’Ÿåï¼Œ${char}åŸè®¡åˆ’æ˜¯${act}",
        flowMode: 'simple',
        flowRange: 15,
        flowVisible: false,
        flowWidth: 200,
        iconNormal: "https://i.postimg.cc/B6FkXGCL/15.png",
        iconActive: "https://i.postimg.cc/1tF2fZKF/16.png",
        iconSize: 50
      };

      // å¢åŠ  copytext ä½œä¸ºæ–°çš„ key
      const STORAGE_KEYS = { 
        api:'tuki_presets_api', 
        copytext:'tuki_presets_copytext', 
        roles:'tuki_roles_v1', 
        global:'tuki_global_settings' 
      };
      
      const FIELD_MAP = { 
        api:['api-preset-name','api-host','api-key','model-name'], 
        copytext:['copytext-preset-name', 'global-copy-template', 'status-tpl-past', 'status-tpl-future'] 
      };

      /* --- 3. æ‚¬æµ®çª— (Flow Widget) é€»è¾‘ä¸æ‹–æ‹½ --- */
      let flowDrag = { active: false, currentX: 0, currentY: 0, initialX: 0, initialY: 0, xOffset: 0, yOffset: 0, hasMoved: false };
      const flowWidget = document.getElementById('flow-widget');

      flowWidget.addEventListener('mousedown', dragStart);
      flowWidget.addEventListener('touchstart', dragStart, {passive: false});
      document.addEventListener('mouseup', dragEnd);
      document.addEventListener('touchend', dragEnd);
      document.addEventListener('mousemove', drag);
      document.addEventListener('touchmove', drag, {passive: false});

      function dragStart(e) {
        if(e.type === "touchstart") {
          flowDrag.initialX = e.touches[0].clientX - flowDrag.xOffset;
          flowDrag.initialY = e.touches[0].clientY - flowDrag.yOffset;
        } else {
          flowDrag.initialX = e.clientX - flowDrag.xOffset;
          flowDrag.initialY = e.clientY - flowDrag.yOffset;
        }
        if (e.target.closest('#flow-widget')) {
          flowDrag.active = true;
          flowDrag.hasMoved = false;
        }
      }
      function dragEnd(e) {
        flowDrag.active = false;
        // å¦‚æœæ²¡æœ‰ç§»åŠ¨ï¼Œè§†ä¸ºç‚¹å‡»
        if (!flowDrag.hasMoved && e.target.closest('#flow-widget')) {
           copyFromFlowWindow(); // ç‚¹å‡»è§¦å‘å¤åˆ¶
        }
      }
      function drag(e) {
        if (flowDrag.active) {
          e.preventDefault();
          let cx, cy;
          if(e.type === "touchmove") { cx = e.touches[0].clientX; cy = e.touches[0].clientY; } 
          else { cx = e.clientX; cy = e.clientY; }

          flowDrag.currentX = cx - flowDrag.initialX;
          flowDrag.currentY = cy - flowDrag.initialY;
          flowDrag.xOffset = flowDrag.currentX;
          flowDrag.yOffset = flowDrag.currentY;

          // ç§»åŠ¨è¶…è¿‡é˜ˆå€¼æ‰ç®—æ‹–æ‹½
          if(Math.abs(flowDrag.currentX - (flowDrag.initialX - cx)) > 2) flowDrag.hasMoved = true;

          setTranslate(flowDrag.currentX, flowDrag.currentY, flowWidget);
        }
      }
      function setTranslate(xPos, yPos, el) { el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`; }

      function toggleFlowWindow() {
        globalSettings.flowVisible = !globalSettings.flowVisible;
        saveGlobalSettings();
        updateFlowWindowVisibility();
      }
      function updateFlowWindowVisibility() {
        flowWidget.style.display = globalSettings.flowVisible ? 'block' : 'none';
        renderFlowWindow();
      }

      function getActiveEventsForFlow() {
        const now = new Date(); const curM = now.getHours()*60 + now.getMinutes();
        const role = roles.find(r => r.id === activeRoleId);
        if(!role) return { active: [], next: null };
        
        let activeItems = []; let nextItems = [];
        role.pages.forEach(p => {
          if(!p.exportEnabled) return;
          p.data.forEach(item => {
            const [h,m] = item.time.split(':').map(Number);
            const t = h*60+m;
            const diff = Math.abs(t - curM);
            if(diff <= globalSettings.flowRange) {
              activeItems.push({ ...item, pageName: p.name });
            } else if (t > curM) {
              nextItems.push({ ...item, t: t });
            }
          });
        });
        nextItems.sort((a,b) => a.t - b.t);
        return { active: activeItems, next: nextItems[0] };
      }

      function renderFlowWindow() {
        if(!globalSettings.flowVisible) return;
        const { active, next } = getActiveEventsForFlow();
        const hasActive = active.length > 0;
        const charName = document.getElementById('role-select') && roles.length ? roles.find(r=>r.id==activeRoleId).name : "TA";
        
        // æ¨¡å¼åˆ‡æ¢
        if(globalSettings.flowMode === 'icon') {
           const url = hasActive ? globalSettings.iconActive : globalSettings.iconNormal;
           flowWidget.innerHTML = `<div class="flow-mode-icon"><img src="${url}" style="width:${globalSettings.iconSize}px;height:${globalSettings.iconSize}px;"></div>`;
        } 
        else if (globalSettings.flowMode === 'simple') {
           // ä¸å‰§é€æ¨¡å¼ï¼šå‘¼å¸é—ªçƒ
           let content = "";
           if (hasActive) {
             const item = active[0]; // ç®€å•æ¨¡å¼åªæ˜¾ç¤ºä¸€ä¸ª
             const [h,m] = item.time.split(':').map(Number);
             const now = new Date(); const curM = now.getHours()*60 + now.getMinutes();
             const diff = Math.abs(curM - (h*60+m));
             content = `<div class="breathing-anim"><div class="simple-name">${charName}</div><div class="simple-time">${diff} min</div></div>`;
           } else if (next) {
             const [h,m] = next.time.split(':').map(Number);
             const now = new Date(); const curM = now.getHours()*60 + now.getMinutes();
             const diff = (h*60+m) - curM;
             content = `<div style="opacity:0.7"><div class="simple-name">Next</div><div class="simple-time">${diff} min</div></div>`;
           } else {
             content = `<div style="opacity:0.5">Zzz...</div>`;
           }
           flowWidget.innerHTML = `<div class="flow-card-base flow-mode-simple">${content}</div>`;
        } 
        else {
           // è¯¦ç»†æ¨¡å¼ï¼šå•è¡Œæ»šåŠ¨
           let text = "";
           if (hasActive) {
             const item = active[0]; 
             const [h,m] = item.time.split(':').map(Number);
             const now = new Date(); const curM = now.getHours()*60 + now.getMinutes();
             const diff = Math.abs(curM - (h*60+m));
             const tpl = (curM > h*60+m) ? globalSettings.tplPast : globalSettings.tplFuture;
             text = tpl.replace(/\${min}/g, diff).replace(/\${char}/g, charName).replace(/\${act}/g, item.description).replace(/\${time}/g, item.time);
           } else if (next) {
             text = `[é¢„å‘Š] ä¸‹ä¸€ä¸ªäº‹ä»¶ ${next.time}ï¼š${next.description}`;
           } else {
             text = "å½“å‰æ— æ—¥ç¨‹å®‰æ’";
           }
           flowWidget.innerHTML = `
             <div class="flow-card-base flow-mode-detail" style="width:${globalSettings.flowWidth}px">
               <div class="marquee-container">
                 <div class="marquee-text">${text}</div>
               </div>
             </div>`;
        }
      }

      function copyFromFlowWindow() {
        // å¤åˆ¶é€»è¾‘åŒæ—§ç‰ˆï¼Œä½†ä½¿ç”¨æ–°å˜é‡
        const { active } = getActiveEventsForFlow();
        const now = new Date(); const curM = now.getHours()*60 + now.getMinutes();
        const charName = roles.find(r=>r.id==activeRoleId).name;
        
        let txt = "";
        if(active.length > 0) {
           let lines = [];
           active.forEach(item => {
              const [h,m] = item.time.split(':').map(Number);
              const diff = Math.abs(curM - (h*60+m));
              const tpl = (curM > h*60+m) ? globalSettings.tplPast : globalSettings.tplFuture;
              lines.push(tpl.replace(/\${min}/g, diff).replace(/\${char}/g, charName).replace(/\${act}/g, item.description).replace(/\${time}/g, item.time));
           });
           txt = globalSettings.copyTemplate.replace("${timercontent}", lines.join("ï¼›"));
           navigator.clipboard.writeText(txt).then(()=>showToast("å·²å¤åˆ¶çŠ¶æ€")).catch(()=>showToast("å¤åˆ¶å¤±è´¥"));
        } else {
           showToast("å½“å‰æ— å¯å¤åˆ¶çš„æ´»è·ƒäº‹ä»¶");
        }
      }

      /* --- 4. åˆå§‹åŒ–ä¸æ•°æ®ç®¡ç† --- */
      window.addEventListener('load', () => {
        // 1. åŠ è½½é¢„è®¾
        ['api','copytext'].forEach(refreshDropdown);
        
        // 2. åŠ è½½å…¨å±€è®¾ç½®
        const savedGlobal = localStorage.getItem(STORAGE_KEYS.global);
        if(savedGlobal) globalSettings = {...globalSettings, ...JSON.parse(savedGlobal)};
        
        // 3. å¡«å……è®¾ç½®è¡¨å•
        document.getElementById('global-copy-template').value = globalSettings.copyTemplate;
        document.getElementById('status-tpl-past').value = globalSettings.tplPast;
        document.getElementById('status-tpl-future').value = globalSettings.tplFuture;
        document.getElementById('flow-mode').value = globalSettings.flowMode;
        document.getElementById('flow-width').value = globalSettings.flowWidth || 200;
        document.getElementById('flow-range').value = globalSettings.flowRange;
        document.getElementById('flow-icon-normal').value = globalSettings.iconNormal;
        document.getElementById('flow-icon-active').value = globalSettings.iconActive;
        document.getElementById('flow-icon-size').value = globalSettings.iconSize;

        // 4. åŠ è½½æ–‡æ¡ˆé¢„è®¾çš„é»˜è®¤å€¼ (å¦‚æœä¸ºç©º)
        const cpPresets = getPresets('copytext');
        if(Object.keys(cpPresets).length === 0) {
           const defaultPreset = {
             "copytext-preset-name": "é»˜è®¤æŒ‡å¯¼",
             "global-copy-template": globalSettings.copyTemplate,
             "status-tpl-past": globalSettings.tplPast,
             "status-tpl-future": globalSettings.tplFuture
           };
           const p = {}; p["é»˜è®¤æŒ‡å¯¼"] = defaultPreset;
           localStorage.setItem(STORAGE_KEYS.copytext, JSON.stringify(p));
           refreshDropdown('copytext');
        }

        // 5. åŠ è½½è§’è‰²
        const savedRoles = localStorage.getItem(STORAGE_KEYS.roles);
        if(savedRoles) roles = JSON.parse(savedRoles);
        else roles = [{ id: Date.now(), name: "é»˜è®¤è§’è‰²", pages: [{ id: Date.now(), name: "ä¸»æ—¥ç¨‹", data: [], exportEnabled: true, exportMode: 'both' }] }];
        activeRoleId = roles[0].id;

        renderRoleUI();
        updateFlowWindowVisibility();
        // å¯åŠ¨å®šæ—¶å™¨
        setInterval(() => { renderFlowWindow(); }, 1000);
      });

      function getPresets(type) { return JSON.parse(localStorage.getItem(STORAGE_KEYS[type])) || {}; }
      function refreshDropdown(type) {
        const presets = getPresets(type); const select = document.getElementById(`${type}-preset-select`);
        const cur = select.value; select.innerHTML = '<option value="">-- æ–°å»º/é€‰æ‹© --</option>';
        Object.keys(presets).forEach(n => { const opt = document.createElement('option'); opt.value=n; opt.innerText=n; select.appendChild(opt); });
        if(presets[cur]) select.value = cur;
      }
      function loadPreset(type, name) { 
        const f=FIELD_MAP[type]; 
        if(!name){f.forEach(i=>document.getElementById(i).value='');return;} 
        const d=getPresets(type)[name]; 
        if(d)f.forEach(i=>{const e=document.getElementById(i);if(e)e.value=d[i]||''}); 
      }
      function savePreset(type) { 
        const n=document.getElementById(`${type}-preset-name`).value.trim(); 
        if(!n)return showToast('æ— åç§°'); 
        const p=getPresets(type), d={}; 
        FIELD_MAP[type].forEach(i=>d[i]=document.getElementById(i).value); 
        p[n]=d; localStorage.setItem(STORAGE_KEYS[type],JSON.stringify(p)); 
        refreshDropdown(type); document.getElementById(`${type}-preset-select`).value=n; showToast('é¢„è®¾å·²ä¿å­˜'); 
      }
      function deletePreset(type) { 
        const n=document.getElementById(`${type}-preset-select`).value; 
        if(n&&confirm('åˆ é™¤?')){const p=getPresets(type);delete p[n];localStorage.setItem(STORAGE_KEYS[type],JSON.stringify(p));loadPreset(type,'');refreshDropdown(type);showToast('å·²åˆ é™¤');} 
      }
      
      function saveGlobalSettings() {
        globalSettings.copyTemplate = document.getElementById('global-copy-template').value;
        globalSettings.tplPast = document.getElementById('status-tpl-past').value;
        globalSettings.tplFuture = document.getElementById('status-tpl-future').value;
        globalSettings.flowMode = document.getElementById('flow-mode').value;
        globalSettings.flowWidth = parseInt(document.getElementById('flow-width').value);
        globalSettings.flowRange = parseInt(document.getElementById('flow-range').value);
        globalSettings.iconNormal = document.getElementById('flow-icon-normal').value;
        globalSettings.iconActive = document.getElementById('flow-icon-active').value;
        globalSettings.iconSize = parseInt(document.getElementById('flow-icon-size').value);
        localStorage.setItem(STORAGE_KEYS.global, JSON.stringify(globalSettings));
        showToast("è®¾ç½®å·²ä¿å­˜"); updateFlowWindowVisibility();
      }

      /* --- 5. è§’è‰²ä¸æ•°æ®æ“ä½œ --- */
      function renderRoleUI() {
        const s = document.getElementById('role-select'); s.innerHTML='';
        roles.forEach(r=>{const o=document.createElement('option');o.value=r.id;o.innerText=r.name;s.appendChild(o)}); s.value=activeRoleId; renderTabs();
      }
      function getActiveRole() { return roles.find(r=>r.id==activeRoleId); }
      function getActivePage() { return getActiveRole().pages[activePageIndex]; }
      function switchRole(id) { activeRoleId=parseInt(id); activePageIndex=0; renderTabs(); }
      function addNewRole() { const n=prompt("è§’è‰²å:"); if(n){roles.push({id:Date.now(),name:n,pages:[{id:Date.now(),name:"æ—¥ç¨‹",data:[],exportEnabled:true,exportMode:'both'}]});activeRoleId=roles[roles.length-1].id;activePageIndex=0;saveRoles();renderRoleUI();} }
      function renameRole() { const r=getActiveRole(), n=prompt("é‡å‘½å:",r.name); if(n){r.name=n;saveRoles();renderRoleUI();} }
      function deleteRole() { if(roles.length<=1)return; if(confirm("åˆ é™¤è§’è‰²?")){roles=roles.filter(r=>r.id!=activeRoleId);activeRoleId=roles[0].id;activePageIndex=0;saveRoles();renderRoleUI();} }
      function saveRoles() { localStorage.setItem(STORAGE_KEYS.roles, JSON.stringify(roles)); }

      function renderTabs() {
        const c=document.getElementById('timer-tabs'); c.innerHTML='';
        getActiveRole().pages.forEach((p,i)=>{const t=document.createElement('div');t.className=`tab-item ${i===activePageIndex?'active':''}`;t.innerText=p.name;t.onclick=()=>{activePageIndex=i;renderTabs()};c.appendChild(t)});
        renderTimeline();
      }
      function addNewPage() { const n=prompt("é¡µç­¾åç§°:"); if(n){getActiveRole().pages.push({id:Date.now(),name:n,data:[],exportEnabled:true,exportMode:'both'});activePageIndex=getActiveRole().pages.length-1;saveRoles();renderTabs();} }
      function deleteCurrentPage() { if(getActiveRole().pages.length<=1)return; if(confirm("åˆ é™¤é¡µç­¾?")){getActiveRole().pages.splice(activePageIndex,1);activePageIndex=0;saveRoles();renderTabs();} }
      
      function renderTimeline() {
        const b=document.getElementById('schedule-result-area'), d=getActivePage()?.data||[];
        b.innerHTML = d.length ? '' : '<div style="text-align:center;color:#aaa;padding:20px">æš‚æ— æ•°æ®</div>';
        d.forEach((item,i)=>{
          const c=document.createElement('div'); c.className='timeline-card'; c.id=`card-${i}`;
          // å¢åŠ å•æ¡ç›®å¤åˆ¶æŒ‰é’®
          c.innerHTML=`<div class="t-header"><div class="t-time">${item.time}</div><div style="font-size:20px">${item.icon||'â°'}</div></div><div class="t-desc">${item.description}</div><div class="card-actions"><button class="card-btn copy" onclick="copyItem(${i})">ğŸ“‘ å¤åˆ¶</button><button class="card-btn" onclick="editItem(${i})">âœï¸ ä¿®æ”¹</button><button class="card-btn" style="color:red" onclick="delItem(${i})">ğŸ—‘ï¸ åˆ é™¤</button></div>`;
          b.appendChild(c);
        });
      }
      function editItem(i) { const d=getActivePage().data, v=prompt("ä¿®æ”¹:",d[i].description); if(v){d[i].description=v;saveRoles();renderTimeline();} }
      function delItem(i) { if(confirm("åˆ é™¤?")){getActivePage().data.splice(i,1);saveRoles();renderTimeline();} }
      function copyItem(i) {
         const item = getActivePage().data[i];
         const txt = `${item.time} ${item.description}`;
         navigator.clipboard.writeText(txt).then(()=>showToast("å·²å¤åˆ¶å•æ¡å†…å®¹")).catch(()=>showToast("å¤åˆ¶å¤±è´¥"));
      }

      function exportData() { 
        const d={}; 
        // å¯¼å‡ºæ‰€æœ‰ç›¸å…³ key
        Object.keys(STORAGE_KEYS).forEach(k=>d[k]=localStorage.getItem(STORAGE_KEYS[k])); 
        const b=new Blob([JSON.stringify(d)],{type:'application/json'}); 
        const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`ephone_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); 
      }
      function importData(i) { 
        const f=i.files[0]; if(!f)return; 
        const r=new FileReader(); 
        r.onload=e=>{try{const d=JSON.parse(e.target.result);Object.keys(d).forEach(k=>localStorage.setItem(k,d[k]));alert("å¯¼å…¥æˆåŠŸï¼Œå³å°†åˆ·æ–°");location.reload();}catch(x){alert("æ–‡ä»¶æ ¼å¼é”™è¯¯")}}; 
        r.readAsText(f); 
      }

      /* API è¯·æ±‚ç›¸å…³ (ä¿ç•™ fetchModels, generateSchedule ä½†éœ€é€‚é…æ–°ç•Œé¢é€»è¾‘, è¿™é‡Œä¸ºç²¾ç®€ä»£ç ç•¥å», é‡ç‚¹åœ¨äº UI å’Œé…ç½®) */
      async function fetchModels() { /* ä¸åŸç‰ˆç›¸åŒ */ }
    </script>
  </body>
</html>

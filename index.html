<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=5.0, user-scalable=yes"
    />
    <title>EPhone PWA</title>
    <link
      rel="apple-touch-icon"
      href="https://i.postimg.cc/Fz25WLbr/7D99384EE38C42D2BA98F53E4582FEA8.jpg"
    />
    <link rel="manifest" href="manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="EPhone" />
    <meta name="mobile-web-app-capable" content="yes" />
    <link
      rel="icon"
      type="image/png"
      href="https://i.postimg.cc/Fz25WLbr/7D99384EE38C42D2BA98F53E4582FEA8.jpg"
    />
    <meta name="theme-color" content="#f0f2f5" />

    <style>
      /* ===========================
         PART A: åŸå§‹ç‰ˆæœ¬æ ¸å¿ƒæ ·å¼ (ä¿æŒä¸å˜)
         =========================== */
      :root {
        --bg-color: #fdfbf7;
        --text-brown: #8d6e63;
        --text-deep: #5d4037;
        --font-main: 'Courier New', Courier, monospace;
      }

      html { height: 100%; -webkit-text-size-adjust: 100%; }
      body {
        margin: 0; font-family: var(--font-main); font-weight: bold; height: 100%;
        overflow: hidden; background-color: var(--bg-color);
        background-image: linear-gradient(rgba(230, 206, 172, 0.2) 1px, transparent 1px),
          linear-gradient(90deg, rgba(230, 206, 172, 0.2) 1px, transparent 1px);
        background-size: 40px 40px; color: var(--text-brown);
      }

      #phone-screen { width: 100%; height: 100vh; display: flex; flex-direction: column; position: relative; overflow: hidden; }
      .screen { width: 100%; height: 100%; position: absolute; display: flex; flex-direction: column; transition: 0.3s; }
      #home-screen { padding-top: calc(30px + env(safe-area-inset-top)); padding-bottom: 20px; box-sizing: border-box; z-index: 10; }
      #home-screen-pages-container { flex-grow: 1; width: 100%; height: 100%; position: relative; }
      #home-screen-pages { width: 100%; height: 100%; display: flex; }
      .home-screen-page { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
      #main-content-area { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; }

      /* æ¡Œé¢ç£å¸¦æ’­æ”¾å™¨æ ·å¼ */
      #desktop-layout { width: 100%; display: flex; justify-content: center; padding: 0 15px; box-sizing: border-box; }
      #desktop-app-container {
        background: linear-gradient(to bottom, #fdfbf7 0%, #f4eadd 100%);
        border: 1px solid #e0d0b8; border-radius: 20px;
        padding: 50px 35px 60px 35px; display: flex; gap: 35px; position: relative;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8), inset 0 -3px 5px rgba(0, 0, 0, 0.05),
          0 15px 35px rgba(141, 110, 99, 0.25), 0 5px 10px rgba(0, 0, 0, 0.05);
        align-items: center; justify-content: center; min-width: 320px;
      }
      #desktop-app-container::before {
        content: 'EPHONE MIX'; position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
        font-size: 11px; font-family: Helvetica, Arial, sans-serif; color: #a1887f;
        background: linear-gradient(to bottom, #fffcf5, #f1e9d2); padding: 4px 16px;
        border-radius: 4px; letter-spacing: 2px; font-weight: 900;
        border: 1px solid #d7ccc8; box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05), 0 1px 0 #fff; z-index: 10;
      }
      .screw { position: absolute; width: 9px; height: 9px; background: linear-gradient(135deg, #e6ceac, #bf9e74); border-radius: 50%; box-shadow: inset 1px 1px 2px rgba(255, 255, 255, 0.8), 0 1px 2px rgba(0, 0, 0, 0.1); }
      .screw::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 5px; height: 1px; background: rgba(93, 64, 55, 0.3); }
      .screw.tl { top: 12px; left: 12px; } .screw.tr { top: 12px; right: 12px; } .screw.bl { bottom: 12px; left: 12px; } .screw.br { bottom: 12px; right: 12px; }
      .tape-window-bg {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 240px; height: 90px;
        background: #fffdf5; border: 2px solid #e6ceac; border-radius: 35px; z-index: 0;
        background-image: repeating-linear-gradient(transparent, transparent 19px, #f2e6d9 20px);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .desktop-app-icon { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; gap: 12px; cursor: pointer; width: 85px; -webkit-tap-highlight-color: transparent; }
      @keyframes reel-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
      .icon-bg-desktop {
        width: 76px; height: 76px; border-radius: 50%; background: #3e2723; border: 4px dashed #d7ccc8;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5), 0 2px 5px rgba(0, 0, 0, 0.1);
        display: flex; justify-content: center; align-items: center; overflow: hidden; transition: transform 0.3s; position: relative;
      }
      .icon-bg-desktop img { width: 86%; height: 86%; object-fit: cover; border-radius: 50%; border: 1px solid rgba(255, 255, 255, 0.2); animation: reel-spin 10s linear infinite; opacity: 0.95; }
      .icon-bg-desktop::after { content: ''; position: absolute; width: 12px; height: 12px; background: #fff; border-radius: 50%; z-index: 5; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3); }
      .tape-bottom-deco { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 220px; height: 35px; background: #f0e6d2; clip-path: polygon(10% 0%, 90% 0%, 100% 100%, 0% 100%); border-top: 1px solid #e0d0b8; z-index: 5; }
      .tape-holes { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 120px; height: 12px; display: flex; justify-content: space-between; }
      .tape-holes::before, .tape-holes::after { content: ''; width: 12px; height: 12px; background: #5d4037; border-radius: 50%; box-shadow: inset 1px 1px 2px rgba(0, 0, 0, 0.3); }
      .desktop-app-icon .label { font-size: 12px; color: var(--text-deep); background: #fffdf0; padding: 3px 8px; border: 1px solid #efe6d5; border-radius: 2px; box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.05); font-weight: bold; transform: rotate(-2deg); }
      .desktop-app-icon:last-child .label { transform: rotate(1deg); }
      .desktop-app-icon:active .icon-bg-desktop { transform: scale(0.92); }

      /* App çª—å£åŸºç¡€ */
      .app-window { width: 100%; height: 100%; position: absolute; top: 0; left: 0; background: #fff; z-index: 50; display: none; flex-direction: column; opacity: 0; transform: scale(0.95); transition: 0.3s; }
      .app-window.active { display: flex; opacity: 1; transform: scale(1); }
      .app-iframe { width: 100%; height: 100%; border: none; background: #fff; }

      /* æ‚¬æµ®æŒ‰é’® (FAB) */
      #fab-container { position: fixed; bottom: 50px; right: 25px; z-index: 1000; width: 64px; height: 64px; }
      #fab-main {
        width: 100%; height: 100%; border-radius: 50%; background-color: #eecfa1;
        background-image: repeating-radial-gradient(#eecfa1 0, #eecfa1 2px, #e0b878 3px, #eecfa1 4px);
        box-shadow: 0 0 0 3px #fff, 0 6px 15px rgba(251, 192, 45, 0.3);
        display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.4s; position: relative;
      }
      #fab-main::before { content: ''; position: absolute; width: 26px; height: 26px; background: #fff8e1; border-radius: 50%; z-index: 1; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
      #fab-main::after { content: ''; position: absolute; width: 6px; height: 6px; background: var(--text-deep); border-radius: 50%; z-index: 2; }
      #fab-main svg { width: 18px; height: 18px; fill: var(--text-deep); z-index: 3; position: relative; transition: 0.3s; }
      #fab-main:active { transform: rotate(15deg) scale(0.95); }
      #fab-main.expanded { transform: rotate(90deg); background: #fff; background-image: none; }
      #fab-main.expanded::before, #fab-main.expanded::after { opacity: 0; }
      
      /* èœå•åˆ—è¡¨ - å·²ä¿®å¤åµŒå¥—é—®é¢˜ */
      .fab-actions {
        position: absolute; bottom: 80px; right: 0; display: flex; flex-direction: column; align-items: flex-end;
        gap: 12px; opacity: 0; visibility: hidden; transform: translateY(15px); transition: 0.3s; pointer-events: none; width: max-content;
      }
      #fab-container.menu-open .fab-actions { opacity: 1; visibility: visible; transform: translateY(0); pointer-events: auto; }
      #fab-container.ghost-mode { opacity: 0; pointer-events: none; }
      #fab-container.ghost-mode .fab-actions { display: none; }

      /* è¾¹ç¼˜æ„Ÿåº” */
      .edge-sensor { position: fixed; z-index: 1500; background: transparent; }
      .edge-sensor.top { top: 0; left: 0; width: 100%; height: 30px; }
      .edge-sensor.bottom { bottom: 0; left: 0; width: 100%; height: 30px; }
      .edge-sensor.left { top: 30px; bottom: 30px; left: 0; width: 15px; }
      .edge-sensor.right { top: 30px; bottom: 30px; right: 0; width: 15px; }

      /* Toast */
      #toast-msg {
        position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%) translateY(20px);
        background: var(--text-deep); color: #fff; padding: 10px 20px; border-radius: 6px;
        font-size: 13px; opacity: 0; visibility: hidden; transition: 0.3s; z-index: 2000;
      }
      #toast-msg.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }

      /* ===========================
         PART B: V13 å‡çº§æ ·å¼ (é«˜çº§ç° / æ‚¬æµ®çª— / é…ç½®)
         =========================== */
      
      /* 1. Appå†…èƒŒæ™¯å¼ºåˆ¶æ·±è‰² */
      #app-settings, #app-schedule { background: linear-gradient(135deg, #263238 0%, #102027 100%) !important; color: #b0bec5; }
      
      /* 2. æ‚¬æµ®çª— (Flow Widget) */
      #flow-widget {
        position: fixed; z-index: 9999; display: none; top: 100px; left: 20px;
        touch-action: none; user-select: none; -webkit-user-select: none; cursor: move;
        opacity: 0; transition: opacity 0.5s;
      }
      #flow-widget.visible { opacity: 1; }
      .flow-card-glass {
        background: rgba(30, 30, 30, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        border-radius: 24px; padding: 0 18px; height: 44px; display: flex; align-items: center;
        color: #f5f5f5; font-size: 13px; font-weight: 500; letter-spacing: 0.5px;
        overflow: hidden; white-space: nowrap; transition: width 0.3s;
      }
      .flow-card-glass:active { transform: scale(0.96); background: rgba(50, 50, 50, 0.95); }
      .marquee-container { position: relative; overflow: hidden; white-space: nowrap; width: 100%; height: 100%; display: flex; align-items: center; pointer-events: none; }
      .marquee-text { position: absolute; white-space: nowrap; will-change: transform; }
      .breathing-content { width: 100%; text-align: center; pointer-events: none; }
      .flow-icon-pure { display: block; cursor: move; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.5)); transition: transform 0.2s; border-radius: 12px; }
      .flow-icon-pure:active { transform: scale(0.9); }

      /* 3. é…ç½®ä¸è®¡æ—¶ç•Œé¢æ ·å¼ */
      .schedule-container { padding: 60px 20px 120px 20px; height: 100%; overflow-y: auto; box-sizing: border-box; scrollbar-width: none; }
      .schedule-container::-webkit-scrollbar { display: none; }
      .schedule-header { 
          font-size: 20px; color: #eceff1; margin-bottom: 20px; padding-bottom: 15px; 
          border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: bold; display: flex; justify-content: space-between; align-items: center; 
      }
      .settings-group { margin-bottom: 20px; background: rgba(255, 255, 255, 0.04); padding: 20px; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.08); }
      .settings-title { font-size: 14px; color: #80cbc4; margin-bottom: 15px; font-weight: bold; border-left: 3px solid #009688; padding-left: 10px; }
      .input-row { margin-bottom: 15px; }
      .input-label { font-size: 12px; color: #78909c; margin-bottom: 6px; display: block; font-weight: 600; }
      .custom-input, .custom-textarea, .preset-select, .page-config-select { 
          width: 100%; padding: 12px; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; 
          background: rgba(0, 0, 0, 0.4); font-size: 13px; color: #eceff1; box-sizing: border-box; outline: none;
      }
      .custom-textarea { resize: vertical; min-height: 80px; font-family: monospace; line-height: 1.5; color: #cfd8dc; }
      .btn-row { display: flex; gap: 12px; margin-top: 15px; }
      .btn-primary { flex: 1; background: linear-gradient(135deg, #009688 0%, #00796b 100%); color: #fff; border: none; padding: 12px; border-radius: 10px; font-weight: bold; }
      .btn-secondary { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #b0bec5; padding: 12px; border-radius: 10px; font-weight: bold; }
      .icon-btn { width: 36px; height: 36px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); border-radius: 10px; color: #cfd8dc; display: flex; justify-content: center; align-items: center; }
      
      /* é¢„è®¾æ  */
      .preset-bar, .role-bar { display: flex; gap: 10px; margin-bottom: 15px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 12px; border: 1px dashed rgba(255,255,255,0.15); align-items: center; }
      .mini-btn { width: 30px; height: 30px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); border-radius: 8px; color: #b0bec5; }
      .page-config-panel { background: linear-gradient(to bottom, rgba(38, 50, 56, 0.9), rgba(33, 33, 33, 0.9)); border: 1px solid rgba(128, 203, 196, 0.3); border-radius: 16px; padding: 15px; margin-bottom: 25px; }
      .page-config-row { display: flex; align-items: center; margin-bottom: 10px; font-size: 13px; }
      .page-config-label { width: 80px; color: #b0bec5; font-weight: 600; flex-shrink: 0; }
      
      /* æ ‡ç­¾é¡µä¸æ—¶é—´è½´ */
      .tabs-header { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
      .tab-item { padding: 8px 18px; background: rgba(255,255,255,0.03); border-radius: 10px 10px 0 0; font-size: 12px; color: #78909c; }
      .tab-item.active { background: rgba(255,255,255,0.1); color: #fff; font-weight: bold; border-top: 2px solid #80cbc4; }
      .tab-add-btn { padding: 8px 14px; background: rgba(255,255,255,0.05); border-radius: 10px; color: #80cbc4; }
      .timeline-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 14px; padding: 18px; margin-bottom: 18px; }
      .timeline-card.active-now { border: 1px solid #80cbc4; background: rgba(0, 150, 136, 0.15); transform: scale(1.02); }
      .t-header { display: flex; justify-content: space-between; margin-bottom: 12px; align-items: center; }
      .t-time { font-family: monospace; font-weight: bold; font-size: 15px; color: #e0f2f1; background: rgba(0, 150, 136, 0.6); padding: 4px 12px; border-radius: 6px; }
      .t-desc { font-size: 14px; color: #cfd8dc; line-height: 1.6; white-space: pre-wrap; }
      .card-actions { margin-top: 15px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: flex-end; gap: 10px; }
      .card-btn { font-size: 11px; padding: 6px 14px; border-radius: 6px; background: transparent; border: 1px solid transparent; color: #b0bec5; }
      
      /* èœå•ç¾åŒ– */
      .fab-action-item { display: flex; align-items: center; justify-content: flex-end; gap: 15px; cursor: pointer; width: 100%; margin-bottom: 12px; }
      .fab-item-label { background: rgba(255,255,255,0.95); color: #37474f; padding: 6px 14px; border-radius: 8px; font-size: 13px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.1); white-space: nowrap; }
      .fab-item-icon { width: 50px; height: 50px; border-radius: 50%; background: #fff; display: flex; justify-content: center; align-items: center; box-shadow: 0 6px 15px rgba(0,0,0,0.2); border: 2px solid #fff; overflow: hidden; }
      .fab-item-icon img { width: 100%; height: 100%; object-fit: cover; }
      .fab-item-icon svg { width: 26px; height: 26px; fill: #455a64; }
      .prompt-toolbar { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 10px; }
      .var-btn { background: rgba(33, 150, 243, 0.1); border: 1px solid rgba(33, 150, 243, 0.3); border-radius: 6px; padding: 5px 10px; font-size: 11px; color: #90caf9; }
      #realtime-status-panel { background: linear-gradient(to right, #37474f, #263238); color: #fff; padding: 20px; border-radius: 16px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.05); }
    </style>
  </head>
  <body>
    <div id="phone-screen">
      <div id="home-screen" class="screen">
        <div id="home-screen-pages-container">
          <div id="home-screen-pages">
            <div class="home-screen-page">
              <div id="main-content-area">
                <div id="desktop-layout">
                  <div id="desktop-app-container">
                    <div class="screw tl"></div><div class="screw tr"></div>
                    <div class="screw bl"></div><div class="screw br"></div>
                    <div class="tape-bottom-deco"><div class="tape-holes"></div></div>
                    <div class="tape-window-bg"></div>
                    
                    <div class="desktop-app-icon" onclick="openApp('app-a')">
                      <div class="icon-bg-desktop"><img src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg" alt="330"/></div>
                      <span class="label">330</span>
                    </div>
                    <div class="desktop-app-icon" onclick="openApp('app-b')">
                      <div class="icon-bg-desktop"><img src="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg" alt="å…”K"/></div>
                      <span class="label">å…”K</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="app-a" class="app-window app-frame">
        <iframe data-src="https://kittykitty0v0.github.io/sfsfdf/" src="" class="app-iframe"></iframe>
      </div>
      <div id="app-b" class="app-window app-frame">
        <iframe data-src="https://kittykitty0v0.github.io/-k-/" src="" class="app-iframe"></iframe>
      </div>
      
      <div id="flow-widget"></div>

      <div id="app-settings" class="app-window app-frame">
        <div class="schedule-container">
          <div class="schedule-header">
            <span>âš™ï¸ ç»ˆç«¯é¢„è®¾åº“</span>
            <div>
              <button class="icon-btn" onclick="exportData()" title="å…¨éƒ¨å¤‡ä»½">ğŸ“¤</button>
              <button class="icon-btn" onclick="document.getElementById('import-file').click()" title="æ¢å¤å¤‡ä»½" style="margin-left:10px;">ğŸ“¥</button>
              <input type="file" id="import-file" style="display:none" onchange="importData(this)">
            </div>
          </div>
          <div style="padding:15px; background:rgba(0, 150, 136, 0.15); border:1px solid rgba(0, 150, 136, 0.3); color:#80cbc4; font-size:12px; border-radius:12px; margin-bottom:25px; line-height:1.5;">
            â„¹ï¸ <b>ç³»ç»Ÿè¯´æ˜</b>ï¼šåœ¨æ­¤é…ç½®é¢„è®¾ã€‚è¯·åœ¨â€œè®¡æ—¶â€é¡µé¢å°†é¢„è®¾ç»‘å®šç»™è§’è‰²ï¼Œå¦åˆ™ä¸ç”Ÿæ•ˆã€‚è®¾ç½®ä¼šè‡ªåŠ¨ä¿å­˜ã€‚
          </div>
          <div class="settings-group">
            <div class="settings-title">ğŸˆ æ‚¬æµ®çª—å‚æ•°</div>
            <div class="input-row"><label class="input-label">æ˜¾ç¤ºæ¨¡å¼</label>
              <select id="flow-mode" class="custom-input" onchange="saveGlobalSettings()">
                <option value="detail">è¯¦ç»†å±•ç¤º (å¾ªç¯æ»šåŠ¨)</option>
                <option value="simple">ä¸å‰§é€ (å‘¼å¸ç¯å¾ªç¯)</option>
                <option value="icon">ä»…å›¾æ ‡ (æ— è¾¹æ¡†)</option>
              </select>
            </div>
            <div class="input-row"><label class="input-label">æ—¶é—´èŒƒå›´(Â±åˆ†é’Ÿ)</label><input type="number" id="flow-range" class="custom-input" value="15" onchange="saveGlobalSettings()"></div>
            <div class="input-row"><label class="input-label">å®½åº¦(px)</label><input type="number" id="flow-width" class="custom-input" value="200" onchange="saveGlobalSettings()"></div>
            <div class="input-row"><label class="input-label">é»˜è®¤å›¾æ ‡</label><input type="text" id="flow-icon-normal" class="custom-input" value="https://i.postimg.cc/B6FkXGCL/15.png" onchange="saveGlobalSettings()"></div>
            <div class="input-row"><label class="input-label">æ´»è·ƒå›¾æ ‡</label><input type="text" id="flow-icon-active" class="custom-input" value="https://i.postimg.cc/1tF2fZKF/16.png" onchange="saveGlobalSettings()"></div>
            <div class="input-row"><button class="btn-secondary" onclick="resetWidgetPosition()">â†º é‡ç½®æ‚¬æµ®çª—ä½ç½®</button></div>
          </div>
          <div class="settings-group">
            <div class="settings-title">ğŸ“‹ æ–‡æ¡ˆ/å¤åˆ¶é¢„è®¾</div>
            <div class="preset-bar">
              <select id="copy-preset-select" class="preset-select" onchange="loadPreset('copy', this.value)"><option value="">-- æ–°å»º/é€‰æ‹© --</option></select>
              <button class="icon-btn" onclick="savePreset('copy')">ğŸ’¾</button> <button class="icon-btn" onclick="deletePreset('copy')">ğŸ—‘ï¸</button>
            </div>
            <div class="input-row"><label class="input-label">é…ç½®åç§°</label><input type="text" id="copy-preset-name" class="custom-input"></div>
            <div class="input-row"><label class="input-label">å¤åˆ¶æ¨¡æ¿</label>
              <div class="prompt-toolbar"><button class="var-btn" onclick="insertVarToId('global-copy-template', '${timercontent}')">æ’å…¥æ—¥ç¨‹å†…å®¹</button><button class="var-btn" onclick="insertVarToId('global-copy-template', '${currTime}')">å½“å‰æ—¶é—´</button></div>
              <textarea id="global-copy-template" class="custom-textarea" style="height:120px;"></textarea>
            </div>
            <div class="input-row"><label class="input-label">è¿‡å»äº‹ä»¶æ–‡æ¡ˆ</label><input type="text" id="status-tpl-past" class="custom-input"></div>
            <div class="input-row"><label class="input-label">æœªæ¥äº‹ä»¶æ–‡æ¡ˆ</label><input type="text" id="status-tpl-future" class="custom-input"></div>
          </div>
          <div class="settings-group">
            <div class="settings-title">ğŸ“¡ API é¢„è®¾</div>
            <div class="preset-bar">
              <select id="api-preset-select" class="preset-select" onchange="loadPreset('api', this.value)"><option value="">-- æ–°å»º/é€‰æ‹© --</option></select>
              <button class="icon-btn" onclick="savePreset('api')">ğŸ’¾</button> <button class="icon-btn" onclick="deletePreset('api')">ğŸ—‘ï¸</button>
            </div>
            <div class="input-row"><label class="input-label">é…ç½®åç§°</label><input type="text" id="api-preset-name" class="custom-input"></div>
            <div class="input-row"><label class="input-label">API Host</label><input type="text" id="api-host" class="custom-input"></div>
            <div class="input-row"><label class="input-label">API Key</label><input type="password" id="api-key" class="custom-input"></div>
            <div class="input-row"><label class="input-label">Model</label><input type="text" id="model-name" class="custom-input"></div>
          </div>
          <div class="settings-group">
            <div class="settings-title">ğŸ“ æç¤ºè¯é¢„è®¾</div>
            <div class="preset-bar">
              <select id="prompt-preset-select" class="preset-select" onchange="loadPreset('prompt', this.value)"><option value="">-- æ–°å»º/é€‰æ‹© --</option></select>
              <button class="icon-btn" onclick="savePreset('prompt')">ğŸ’¾</button> <button class="icon-btn" onclick="deletePreset('prompt')">ğŸ—‘ï¸</button>
            </div>
            <div class="input-row"><label class="input-label">åç§°</label><input type="text" id="prompt-preset-name" class="custom-input"></div>
            <div class="input-row"><label class="input-label">Prompt</label><textarea id="prompt-content" class="custom-textarea" style="height:150px;"></textarea></div>
          </div>
          <div class="settings-group">
            <div class="settings-title">ğŸ­ è§’è‰²/ç”¨æˆ·é¢„è®¾</div>
            <div class="preset-bar">
              <select id="char-preset-select" class="preset-select" onchange="loadPreset('char', this.value)"><option value="">-- è§’è‰² --</option></select>
              <button class="icon-btn" onclick="savePreset('char')">ğŸ’¾</button>
              <select id="user-preset-select" class="preset-select" style="margin-left:10px;" onchange="loadPreset('user', this.value)"><option value="">-- ç”¨æˆ· --</option></select>
              <button class="icon-btn" onclick="savePreset('user')">ğŸ’¾</button>
            </div>
            <div class="input-row"><label class="input-label">è§’è‰²é…ç½®å/åå­—/äººè®¾/ä¸–ç•Œ/å†å²</label>
                <input type="text" id="char-preset-name" class="custom-input" placeholder="é…ç½®å">
                <input type="text" id="char-name" class="custom-input" placeholder="è§’è‰²å" style="margin-top:5px;">
                <textarea id="char-persona" class="custom-textarea" placeholder="è§’è‰²äººè®¾" style="margin-top:5px;"></textarea>
                <textarea id="world-info" class="custom-textarea" placeholder="ä¸–ç•Œè§‚" style="margin-top:5px;"></textarea>
                <textarea id="chat-history" class="custom-textarea" placeholder="å†å²è®°å½•" style="margin-top:5px;"></textarea>
            </div>
            <div class="input-row"><label class="input-label">ç”¨æˆ·é…ç½®å/åå­—/äººè®¾</label>
                <input type="text" id="user-preset-name" class="custom-input" placeholder="é…ç½®å">
                <input type="text" id="user-name" class="custom-input" placeholder="ä½ çš„åå­—" style="margin-top:5px;">
                <textarea id="user-persona" class="custom-textarea" placeholder="ä½ çš„äººè®¾" style="margin-top:5px;"></textarea>
            </div>
          </div>
          <div style="height:100px;"></div>
        </div>
      </div>

      <div id="app-schedule" class="app-window app-frame">
        <div class="schedule-container">
          <div class="role-bar">
            <span>ğŸ­</span>
            <select id="role-select" class="custom-input" style="padding:6px; background:rgba(0,0,0,0.2);" onchange="switchRole(this.value)"></select>
            <button class="mini-btn" onclick="addNewRole()">+</button>
            <button class="mini-btn" onclick="renameRole()">âœ</button>
            <button class="mini-btn" onclick="deleteRole()" style="color:#ef9a9a;">ğŸ—‘ï¸</button>
          </div>
          
          <div class="tabs-header" id="timer-tabs"></div>
          <div style="text-align:right; margin-bottom:15px;">
             <button class="card-btn del" onclick="deleteCurrentPage()">ğŸ—‘ï¸ åˆ é™¤é¡µ</button>
             <button class="card-btn del" onclick="clearCurrentPage()">ğŸ§¹ æ¸…ç©º</button>
          </div>

          <div class="page-config-panel">
             <div class="page-config-title">ğŸ”— ç»‘å®šè®¾ç½® (ä¸‹æ‹‰é€‰æ‹©é¢„è®¾)</div>
             <div class="page-config-row"><div class="page-config-label">API:</div><select id="bind-api" class="page-config-select" onchange="updatePageBinding('apiPreset', this.value)"></select></div>
             <div class="page-config-row"><div class="page-config-label">è§’è‰²:</div><select id="bind-char" class="page-config-select" onchange="updatePageBinding('charPreset', this.value)"></select></div>
             <div class="page-config-row"><div class="page-config-label">ç”¨æˆ·:</div><select id="bind-user" class="page-config-select" onchange="updatePageBinding('userPreset', this.value)"></select></div>
             <div class="page-config-row"><div class="page-config-label">æç¤ºè¯:</div><select id="bind-prompt" class="page-config-select" onchange="updatePageBinding('promptPreset', this.value)"></select></div>
             <div class="page-config-row"><div class="page-config-label">æ–‡æ¡ˆ:</div><select id="bind-copy" class="page-config-select" onchange="updatePageBinding('copyPreset', this.value)"></select></div>
             <div class="page-config-row"><div class="page-config-label">èŒƒå›´:</div>
               <select id="bind-mode" class="page-config-select" style="border:1px solid #ffcc80; color:#ffcc80;" onchange="updatePageBinding('exportMode', this.value)">
                 <option value="both">æœªæ¥ + è¿‡å»</option><option value="future">åªæ˜¾ç¤ºæœªæ¥</option><option value="past">åªæ˜¾ç¤ºè¿‡å»</option>
               </select>
             </div>
          </div>

          <div id="realtime-status-panel">
            <div class="rt-content" id="rt-past" style="color:#b0bec5;">--</div>
            <div class="rt-divider"></div>
            <div class="rt-content" id="rt-future" style="color:#80cbc4;">--</div>
          </div>

          <div style="margin-bottom:20px;">
             <div class="btn-row"><button class="btn-primary" id="btn-gen-schedule" onclick="generateSchedule(false)">ğŸ”„ ç”Ÿæˆ</button><button class="btn-secondary" id="btn-append-schedule" onclick="generateSchedule(true)">â• è¿½åŠ </button></div>
             <div id="schedule-loading" style="display:none; padding:15px; text-align:center; color:#b0bec5;">ğŸ§  æ€è€ƒä¸­...</div>
          </div>
          <div id="schedule-result-area"></div>
          <div style="height:100px;"></div>
        </div>
      </div>

      <div id="fab-container">
        <div class="fab-actions">
          <div class="fab-action-item" onclick="openApp('app-a')">
            <span class="fab-item-label">330</span>
            <div class="fab-item-icon"><img src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg" alt="330" /></div>
          </div>
          <div class="fab-action-item" onclick="openApp('app-b')">
            <span class="fab-item-label">å…”K</span>
            <div class="fab-item-icon"><img src="https://i.postimg.cc/Kj8JnRcp/267611-CC01-F8-A3-B4910-A2-C2-FFDE479-DC.jpg" alt="å…”K" /></div>
          </div>
          <div class="fab-action-item" onclick="openApp('app-settings')">
            <span class="fab-item-label">é…ç½®</span>
            <div class="fab-item-icon"><img src="https://i.postimg.cc/MZ7rZWzF/18.png" alt="é…ç½®" /></div>
          </div>
          <div class="fab-action-item" onclick="openApp('app-schedule')">
            <span class="fab-item-label">è®¡æ—¶</span>
            <div class="fab-item-icon"><img src="https://i.postimg.cc/prJ0sB08/21.png" alt="è®¡æ—¶" /></div>
          </div>
          <div class="fab-action-item" onclick="toggleFlowWindow()">
            <span class="fab-item-label">æ‚¬çª—</span>
            <div class="fab-item-icon"><img src="https://i.postimg.cc/3rXbrK3S/24.png" alt="æ‚¬çª—" /></div>
          </div>
          <div class="fab-action-item" onclick="hideFab()">
            <span class="fab-item-label">éšè—</span>
            <div class="fab-item-icon"><svg viewBox="0 0 24 24"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46A11.804 11.804 0 0 0 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg></div>
          </div>
          <div class="fab-action-item" onclick="goHome()">
            <span class="fab-item-label">ä¸»é¡µ</span>
            <div class="fab-item-icon"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" /></svg></div>
          </div>
        </div>
        <div id="fab-main"></div>
      </div>

      <div class="edge-sensor top"></div><div class="edge-sensor bottom"></div>
      <div class="edge-sensor left"></div><div class="edge-sensor right"></div>
      <div id="toast-msg"></div>
    </div>

    <script>
      // ===========================
      // 1. åŸºç¡€ DOM ä¸ å˜é‡
      // ===========================
      const fabContainer = document.getElementById('fab-container');
      const fabMain = document.getElementById('fab-main');
      const launcherScreen = document.getElementById('home-screen');
      const frames = document.querySelectorAll('.app-frame');
      const toastMsg = document.getElementById('toast-msg');

      const menuIconSvg = '<svg viewBox="0 0 24 24"><path d="M4 18h16c.55 0 1-.45 1-1s-.45-1-1-1H4c-.55 0-1 .45-1 1s.45 1 1 1zm0-5h16c.55 0 1-.45 1-1s-.45-1-1-1H4c-.55 0-1 .45-1 1s.45 1 1 1zM3 7c0 .55.45 1 1 1h16c.55 0 1-.45 1-1s-.45-1-1-1H4c-.55 0-1 .45-1 1z"/></svg>';
      const closeIconSvg = '<svg viewBox="0 0 24 24"><path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7a.996.996 0 1 0-1.41 1.41L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/></svg>';
      
      fabMain.innerHTML = menuIconSvg;

      // ===========================
      // 2. åŸå§‹ç‰ˆæœ¬æ ¸å¿ƒé€»è¾‘ (åˆ‡æ¢/éšè—/æ‹–æ‹½)
      // ===========================
      function openApp(frameId) {
        document.body.classList.add('app-open');
        launcherScreen.style.opacity = '0';
        launcherScreen.style.transform = 'scale(0.95)';
        
        frames.forEach(frame => {
          if (frame.id === frameId) {
            frame.style.display = 'flex';
            setTimeout(() => frame.classList.add('active'), 10);
            const iframe = frame.querySelector('iframe');
            if (iframe && iframe.dataset.src) iframe.src = iframe.dataset.src; 
          } else {
            frame.classList.remove('active');
            frame.style.display = 'none';
            const iframe = frame.querySelector('iframe');
            if (iframe) iframe.src = ''; 
          }
        });
        closeMenu();
      }

      function goHome() {
        document.body.classList.remove('app-open');
        launcherScreen.style.opacity = '1';
        launcherScreen.style.transform = 'scale(1)';
        setTimeout(() => {
          frames.forEach(frame => {
            frame.classList.remove('active');
            frame.style.display = 'none';
            const iframe = frame.querySelector('iframe');
            if (iframe) iframe.src = '';
          });
        }, 300);
        closeMenu();
      }

      function hideFab() {
        closeMenu();
        const mainRect = fabMain.getBoundingClientRect();
        fabContainer.style.left = mainRect.left + 'px';
        fabContainer.style.top = mainRect.top + 'px';
        fabContainer.style.bottom = 'auto'; fabContainer.style.right = 'auto';
        fabContainer.classList.add('ghost-mode');
        showToast('å·²éšè—ã€‚åŒå‡»å±å¹•é¡¶éƒ¨æˆ–è€…åº•éƒ¨å”¤å‡ºã€‚');
      }
      function showFab() { fabContainer.classList.remove('ghost-mode'); }
      function showToast(text) { toastMsg.innerText = text; toastMsg.classList.add('show'); setTimeout(() => toastMsg.classList.remove('show'), 3000); }

      function toggleMenu() {
        if (fabContainer.classList.contains('ghost-mode')) {
          showFab();
          setTimeout(() => { fabContainer.classList.add('menu-open'); fabMain.classList.add('expanded'); fabMain.innerHTML = closeIconSvg; }, 50);
          return;
        }
        fabContainer.classList.toggle('menu-open');
        fabMain.classList.toggle('expanded');
        fabMain.innerHTML = fabMain.classList.contains('expanded') ? closeIconSvg : menuIconSvg;
      }
      function closeMenu() { fabContainer.classList.remove('menu-open'); fabMain.classList.remove('expanded'); fabMain.innerHTML = menuIconSvg; }
      
      document.addEventListener('click', e => { if (!fabContainer.contains(e.target) && fabContainer.classList.contains('menu-open')) closeMenu(); });

      // æ‹–æ‹½é€»è¾‘
      let isDragging = false, hasMoved = false, startX, startY, initialLeft, initialTop;
      fabMain.addEventListener('mousedown', startDrag); fabMain.addEventListener('touchstart', startDrag, { passive: false });
      
      function startDrag(e) {
        if (fabContainer.classList.contains('ghost-mode')) return;
        if (fabContainer.classList.contains('menu-open')) closeMenu();
        isDragging = true; hasMoved = false;
        const evt = e.touches ? e.touches[0] : e;
        startX = evt.clientX; startY = evt.clientY;
        const rect = fabContainer.getBoundingClientRect();
        initialLeft = rect.left; initialTop = rect.top;
        fabContainer.style.bottom = 'auto'; fabContainer.style.right = 'auto';
        fabContainer.style.left = initialLeft + 'px'; fabContainer.style.top = initialTop + 'px';
        document.addEventListener('mousemove', onDrag); document.addEventListener('touchmove', onDrag, { passive: false });
        document.addEventListener('mouseup', stopDrag); document.addEventListener('touchend', stopDrag);
      }
      function onDrag(e) {
        if (!isDragging) return;
        e.preventDefault();
        const evt = e.touches ? e.touches[0] : e;
        if (Math.abs(evt.clientX - startX) > 5 || Math.abs(evt.clientY - startY) > 5) hasMoved = true;
        fabContainer.style.left = initialLeft + (evt.clientX - startX) + 'px';
        fabContainer.style.top = initialTop + (evt.clientY - startY) + 'px';
      }
      function stopDrag() {
        isDragging = false;
        document.removeEventListener('mousemove', onDrag); document.removeEventListener('touchmove', onDrag);
        document.removeEventListener('mouseup', stopDrag); document.removeEventListener('touchend', stopDrag);
      }
      fabMain.addEventListener('click', e => { e.stopPropagation(); if (!hasMoved) toggleMenu(); });

      // ===========================
      // 3. V13 æ ¸å¿ƒæ•°æ®é€»è¾‘ (ç¡®ä¿å¤‡ä»½ä¸ä¸¢å¤±)
      // ===========================
      let timerPages = []; let activeRoleId = 0; let activePageIndex = 0; let roles = [];
      let globalSettings = { flowMode: 'simple', flowRange: 15, flowVisible: false, iconNormal: "https://i.postimg.cc/B6FkXGCL/15.png", iconActive: "https://i.postimg.cc/1tF2fZKF/16.png", iconSize: 50, flowWidth: 200, flowSpeedScroll: 30, flowSpeedBlink: 3000, widgetX: 20, widgetY: 120 };
      
      const DEFAULT_GLOBAL_TEMPLATE = "æ­¤æ¡å†…å®¹æ˜¯aiå†™ä½œæŒ‡å¯¼ï¼Œè§’è‰²ä¸å¯è§ã€‚ä»¥ä¸‹æ˜¯è§’è‰²åŸæœ¬çš„æ—¥ç¨‹è®¡åˆ’ï¼Œæ³¨æ„è§’è‰²å¯èƒ½ä¹‹å‰ä¹‹åéƒ½ä¸æŒ‰ç…§åŸè®¡åˆ’è¿›è¡Œï¼Œè¯·ä½ æ ¹æ®ä¸Šä¸‹æ–‡è¯­å¢ƒè¿›è¡Œåˆ¤æ–­å‰§æƒ…å‘å±•ï¼š\n${timercontent}\nå¿…é¡»æ ¹æ®ä¸Šä¸‹æ–‡åˆ¤æ–­è§’è‰²æ˜¯å¦ä¹‹å‰æˆ–ä¹‹åè¿›è¡ŒåŸè®¡åˆ’ï¼Œä»¥åŠæ ¹æ®å½“å‰å¯¹è¯åœºæ™¯è§’è‰²æ˜¯å¦ä¼šæåŠæ­¤äº‹ï¼Œè§’è‰²ä¹Ÿå¯èƒ½å·²ç»å¿˜è®°æ­¤äº‹æˆ–ç›´æ¥æ ¹æœ¬ä¸æã€‚ä½ ä½œä¸ºaiå¿…é¡»è‡ªè¡Œåˆ¤æ–­åšå‡ºæœ‰æ´»äººæ„Ÿçš„ååº”ä¸ç»“æœã€‚";
      const STORAGE_KEYS = { api:'tuki_presets_api', char:'tuki_presets_char', user:'tuki_presets_user', prompt:'tuki_presets_prompt', copy:'tuki_presets_copy', roles:'tuki_roles_v1', global:'tuki_global_settings' };
      const FIELD_MAP = { 
        api:['api-preset-name','api-host','api-key','model-name'], 
        char:['char-preset-name','char-name','char-persona','world-info','chat-history'], 
        user:['user-preset-name','user-name','user-persona'], 
        prompt:['prompt-preset-name','prompt-content'],
        copy:['copy-preset-name','global-copy-template','status-tpl-past','status-tpl-future'] 
      };
      const DEFAULT_PROMPT = `# è§’è‰²æ‰®æ¼”ä»»åŠ¡\nè¯·æ ¹æ®"\${chat.name}"çš„äººè®¾ï¼Œæ¨æ¼”æ¥ä¸‹æ¥24å°æ—¶çš„è¡Œä¸ºè½¨è¿¹ã€‚\n# å‚æ•°\nè§’è‰²ï¼š\${chat.name}\näººè®¾ï¼š\${chat.settings.aiPersona}\n# è¾“å‡ºè§„åˆ™\n1. è¿”å›JSONæ•°ç»„ã€‚2. æ—¶é—´æ ¼å¼ "HH:mm"ã€‚3. åŒ…å« 'html_snippet' (å¯é€‰)ã€‚\n[{"time":"08:00","description":"...","icon":"â°"}]`;

      // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šå•ä¸€ä¸”å¼ºåˆ¶çš„åˆå§‹åŒ–å…¥å£ â˜…â˜…â˜…
      window.addEventListener('load', () => {
        // 1. åŒå‡»å”¤é†’é€»è¾‘
        document.addEventListener('dblclick', () => { if(fabContainer.classList.contains('ghost-mode')){ showFab(); showToast('å·²å”¤å‡ºèœå•'); } });
        let lastTapTime = 0;
        document.addEventListener('touchend', e => {
          const currentTime = new Date().getTime(); const tapLength = currentTime - lastTapTime;
          if (tapLength < 300 && tapLength > 0) {
            if (fabContainer.classList.contains('ghost-mode')) { showFab(); showToast('å·²å”¤å‡ºèœå•'); e.preventDefault(); }
          }
          lastTapTime = currentTime;
        });

        // 2. Service Worker
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');

        // 3. æ•°æ®æ¢å¤é€»è¾‘ (ä¿®å¤å¤‡ä»½ä¸¢å¤±é—®é¢˜)
        try {
          ensureDefaultPresets();
          
          // æ¢å¤å…¨å±€è®¾ç½®
          const savedGlobal = localStorage.getItem(STORAGE_KEYS.global);
          if(savedGlobal) globalSettings = {...globalSettings, ...JSON.parse(savedGlobal)};
          
          // åº”ç”¨è®¾ç½®åˆ°UI
          const safeVal = (id, val) => { const el=document.getElementById(id); if(el) el.value=val; };
          safeVal('global-copy-template', DEFAULT_GLOBAL_TEMPLATE);
          safeVal('flow-mode', globalSettings.flowMode);
          safeVal('flow-range', globalSettings.flowRange);
          safeVal('flow-width', globalSettings.flowWidth);
          safeVal('flow-speed-scroll', globalSettings.flowSpeedScroll);
          safeVal('flow-speed-blink', globalSettings.flowSpeedBlink);
          safeVal('flow-icon-normal', globalSettings.iconNormal);
          safeVal('flow-icon-active', globalSettings.iconActive);
          safeVal('flow-icon-size', globalSettings.iconSize);

          const widget = document.getElementById('flow-widget');
          if(widget) { widget.style.left = globalSettings.widgetX + 'px'; widget.style.top = globalSettings.widgetY + 'px'; }

          // æ¢å¤è§’è‰²æ•°æ®
          const savedRoles = localStorage.getItem(STORAGE_KEYS.roles);
          if(savedRoles) {
            roles = JSON.parse(savedRoles);
            // ä¿®å¤ï¼šå¦‚æœè¯»å–æˆåŠŸä½†æ•°ç»„ä¸ºç©ºï¼Œæˆ–è€…æ•°æ®æŸåï¼Œé‡ç½®ä¸ºé»˜è®¤
            if(!Array.isArray(roles) || roles.length === 0) roles = [{ id: Date.now(), name: "é»˜è®¤è§’è‰²", pages: [{ id: Date.now(), name: "ä¸»æ—¥ç¨‹", data: [], exportMode: "both" }] }];
          } else {
            roles = [{ id: Date.now(), name: "é»˜è®¤è§’è‰²", pages: [{ id: Date.now(), name: "ä¸»æ—¥ç¨‹", data: [], exportMode: "both" }] }];
          }
          activeRoleId = roles[0].id;
          
          // æ¸²æŸ“UI
          renderRoleUI();
          ['api','char','user','prompt','copy'].forEach(refreshDropdown);
          
          updateFlowWindowVisibility();
          setInterval(updateRealTimeStatus, 1000);
          initFlowLoop();
          initWidgetDrag();
          
          // æç¤ºç”¨æˆ·æ•°æ®åŠ è½½æˆåŠŸ
          if(savedRoles) showToast('âœ… å¤‡ä»½å·²æ¢å¤');
          
        } catch(e) {
          alert("æ•°æ®åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æˆªå›¾åé¦ˆï¼š" + e.message);
        }
      });

      function ensureDefaultPresets() {
          const defaults = {
              api: { "é»˜è®¤API": { "api-preset-name": "é»˜è®¤API", "api-host": "https://api.openai.com", "api-key": "", "model-name": "gpt-3.5-turbo" } },
              char: { "é»˜è®¤è§’è‰²": { "char-preset-name": "é»˜è®¤è§’è‰²", "char-name": "åŠ©æ‰‹", "char-persona": "ä½ æ˜¯ä¸€ä¸ªåŠ©æ‰‹", "world-info": "", "chat-history": "" } },
              user: { "é»˜è®¤ç”¨æˆ·": { "user-preset-name": "é»˜è®¤ç”¨æˆ·", "user-name": "ç”¨æˆ·", "user-persona": "" } },
              prompt: { "é»˜è®¤æ—¥ç¨‹": { "prompt-preset-name": "é»˜è®¤æ—¥ç¨‹", "prompt-content": DEFAULT_PROMPT } },
              copy: { "ç³»ç»Ÿé»˜è®¤": { "copy-preset-name": "ç³»ç»Ÿé»˜è®¤", "global-copy-template": DEFAULT_GLOBAL_TEMPLATE, "status-tpl-past": "${min}åˆ†é’Ÿå‰ï¼Œ${char}åŸè®¡åˆ’æ˜¯${act}", "status-tpl-future": "${min}åˆ†é’Ÿåï¼Œ${char}åŸè®¡åˆ’æ˜¯${act}" } }
          };
          Object.keys(defaults).forEach(type => {
              if(!localStorage.getItem(STORAGE_KEYS[type])) localStorage.setItem(STORAGE_KEYS[type], JSON.stringify(defaults[type]));
          });
      }

      // ===========================
      // 4. æ‚¬æµ®çª—é€»è¾‘ (Flow Widget)
      // ===========================
      function toggleFlowWindow() { globalSettings.flowVisible = !globalSettings.flowVisible; saveGlobalSettings(); updateFlowWindowVisibility(); }
      function updateFlowWindowVisibility() {
        const widget = document.getElementById('flow-widget');
        if(!widget) return;
        if(globalSettings.flowVisible) {
            widget.style.display = 'block'; setTimeout(()=>widget.classList.add('visible'), 10); renderNextFlowItem();
        } else {
            widget.classList.remove('visible'); setTimeout(()=>widget.style.display = 'none', 500);
        }
      }
      
      let flowQueue = []; let currentFlowIndex = 0; let flowLoopTimer = null;
      function initFlowLoop() { setInterval(() => { if(!globalSettings.flowVisible) return; }, 1000); if(globalSettings.flowVisible) renderNextFlowItem(); }

      function getFlowQueue() {
          const now = new Date(); const curM = now.getHours()*60 + now.getMinutes(); let queue = [];
          roles.forEach(role => {
              role.pages.forEach(page => {
                  if(!page.copyPreset) return;
                  const copyCfg = getPresets('copy')[page.copyPreset];
                  if(!copyCfg) return;
                  let charName = role.name;
                  if(page.charPreset) { const charCfg = getPresets('char')[page.charPreset]; if(charCfg && charCfg['char-name']) charName = charCfg['char-name']; }
                  let candidates = [];
                  page.data.forEach(item => {
                      const [h,m] = item.time.split(':').map(Number); const t = h*60+m; const diff = Math.abs(t - curM);
                      if(diff <= globalSettings.flowRange) candidates.push({ ...item, t: t, diff: diff });
                  });
                  if(candidates.length === 0) return;
                  const mode = page.exportMode || 'both'; let itemsToAdd = [];
                  if(mode === 'both' || mode === 'past') { const pastItems = candidates.filter(i => curM >= i.t).sort((a,b) => a.diff - b.diff); if(pastItems.length > 0) itemsToAdd.push(pastItems[0]); }
                  if(mode === 'both' || mode === 'future') { const futureItems = candidates.filter(i => curM < i.t).sort((a,b) => a.diff - b.diff); if(futureItems.length > 0) itemsToAdd.push(futureItems[0]); }
                  itemsToAdd.forEach(item => {
                      const isPast = curM >= item.t; const tpl = isPast ? copyCfg['status-tpl-past'] : copyCfg['status-tpl-future'];
                      const text = tpl.replace(/\${min}/g, item.diff).replace(/\${char}/g, charName).replace(/\${act}/g, item.description).replace(/\${time}/g, item.time);
                      queue.push({ text: text, shortText: `${item.time} ${charName}`, copyText: text, icon: item.icon });
                  });
              });
          });
          return queue;
      }

      function renderNextFlowItem() {
          if(!globalSettings.flowVisible) return;
          const widget = document.getElementById('flow-widget');
          const queue = getFlowQueue();
          
          if(queue.length === 0) {
              if(globalSettings.flowMode === 'icon') {
                  const size = globalSettings.iconSize; widget.innerHTML = `<img src="${globalSettings.iconNormal}" class="flow-icon-pure" style="width:${size}px;height:${size}px;">`;
              } else {
                  widget.innerHTML = `<div class="flow-card-glass" style="width:auto;"><div class="breathing-content">ğŸ’¤</div></div>`;
              }
              clearTimeout(flowLoopTimer); flowLoopTimer = setTimeout(renderNextFlowItem, 3000); return;
          }

          if(currentFlowIndex >= queue.length) currentFlowIndex = 0;
          const item = queue[currentFlowIndex];
          
          if(globalSettings.flowMode === 'icon') {
              const size = globalSettings.iconSize;
              widget.innerHTML = `<img src="${globalSettings.iconActive}" class="flow-icon-pure" style="width:${size}px;height:${size}px;" onclick="copyCurrentFlowItem(${currentFlowIndex})">`;
              clearTimeout(flowLoopTimer); flowLoopTimer = setTimeout(() => { currentFlowIndex++; renderNextFlowItem(); }, globalSettings.flowSpeedBlink);
              
          } else if(globalSettings.flowMode === 'detail') {
              const width = globalSettings.flowWidth;
              widget.innerHTML = `<div class="flow-card-glass" style="width:${width}px;" onclick="copyCurrentFlowItem(${currentFlowIndex})"><div class="marquee-container"><span class="marquee-text" id="mq-text">${item.text}</span></div></div>`;
              const container = widget.querySelector('.marquee-container'); const textEl = widget.querySelector('.marquee-text');
              requestAnimationFrame(() => {
                  const realTextWidth = textEl.scrollWidth; const containerWidth = width - 32; let duration = 3000;
                  if(realTextWidth > containerWidth) {
                      const distance = realTextWidth + containerWidth; const speed = globalSettings.flowSpeedScroll || 30; duration = (distance / speed) * 1000;
                      textEl.style.transition = `transform ${duration}ms linear`; textEl.style.left = `${containerWidth}px`; 
                      requestAnimationFrame(() => { textEl.style.transform = `translateX(-${distance}px)`; });
                  } else { textEl.style.left = '0'; textEl.style.position = 'relative'; }
                  clearTimeout(flowLoopTimer); flowLoopTimer = setTimeout(() => { currentFlowIndex++; renderNextFlowItem(); }, duration + 500); 
              });
          } else {
              widget.innerHTML = `<div class="flow-card-glass" style="width:auto;" onclick="copyCurrentFlowItem(${currentFlowIndex})"><div class="breathing-content" style="animation-duration:${globalSettings.flowSpeedBlink}ms">${item.shortText}</div></div>`;
              clearTimeout(flowLoopTimer); flowLoopTimer = setTimeout(() => { currentFlowIndex++; renderNextFlowItem(); }, globalSettings.flowSpeedBlink);
          }
      }

      function copyCurrentFlowItem(idx) {
          const queue = getFlowQueue();
          if(queue[idx]) {
              const item = queue[idx];
              let tpl = document.getElementById('global-copy-template')?.value;
              if(!tpl) { const copyPreset = getPresets('copy')[roles.find(r=>r.id==activeRoleId).pages[activePageIndex].copyPreset]; tpl = copyPreset ? copyPreset['global-copy-template'] : DEFAULT_GLOBAL_TEMPLATE; }
              const now = new Date(); const finalTxt = tpl.replace("${timercontent}", item.copyText).replace("${currTime}", now.toLocaleString());
              navigator.clipboard.writeText(finalTxt).then(()=>showToast("å·²å¤åˆ¶: " + item.shortText)).catch(()=>showToast("å¤åˆ¶å¤±è´¥"));
          }
      }

      function resetWidgetPosition() {
        globalSettings.widgetX = 20; globalSettings.widgetY = 120;
        const widget = document.getElementById('flow-widget');
        if(widget) { widget.style.left = '20px'; widget.style.top = '120px'; }
        saveGlobalSettings();
      }

      function initWidgetDrag() {
        const widget = document.getElementById('flow-widget');
        if(!widget) return;
        let isDragging = false, hasMoved = false, startX, startY, initialLeft, initialTop;
        const onStart = (e) => { isDragging = true; hasMoved = false; const evt = e.touches ? e.touches[0] : e; startX = evt.clientX; startY = evt.clientY; initialLeft = widget.offsetLeft; initialTop = widget.offsetTop; };
        const onMove = (e) => {
          if (!isDragging) return;
          const evt = e.touches ? e.touches[0] : e; const deltaX = evt.clientX - startX; const deltaY = evt.clientY - startY;
          if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) { hasMoved = true; widget.style.left = (initialLeft + deltaX) + 'px'; widget.style.top = (initialTop + deltaY) + 'px'; e.preventDefault(); }
        };
        const onEnd = () => { if(!isDragging) return; isDragging = false; if(hasMoved) { globalSettings.widgetX = parseInt(widget.style.left); globalSettings.widgetY = parseInt(widget.style.top); saveGlobalSettings(); } };
        widget.addEventListener('mousedown', onStart); widget.addEventListener('touchstart', onStart, {passive: false});
        window.addEventListener('mousemove', onMove); window.addEventListener('touchmove', onMove, {passive: false});
        window.addEventListener('mouseup', onEnd); window.addEventListener('touchend', onEnd);
      }

      // ===========================
      // 5. è¾…åŠ©åŠŸèƒ½ (CRUD, API)
      // ===========================
      function getPresets(type) { return JSON.parse(localStorage.getItem(STORAGE_KEYS[type])) || {}; }
      function refreshDropdown(type) {
        const select = document.getElementById(`${type}-preset-select`); const presets = getPresets(type); 
        if(select) { const cur = select.value; select.innerHTML = '<option value="">-- æ–°å»º/é€‰æ‹© --</option>'; Object.keys(presets).forEach(n => { const opt = document.createElement('option'); opt.value=n; opt.innerText=n; select.appendChild(opt); }); if(presets[cur]) select.value = cur; }
        const bindSelect = document.getElementById(`bind-${type}`);
        if(bindSelect && getActivePage()) { bindSelect.innerHTML = '<option value="">-- æœªç»‘å®š --</option>'; Object.keys(presets).forEach(n => { const opt = document.createElement('option'); opt.value=n; opt.innerText=n; bindSelect.appendChild(opt); }); const pageKey = type + 'Preset'; bindSelect.value = getActivePage()[pageKey] || ""; }
        const modeSelect = document.getElementById('bind-mode'); if(modeSelect && getActivePage()) modeSelect.value = getActivePage().exportMode || 'both';
      }
      function loadPreset(type, name) { const f=FIELD_MAP[type]; if(!name){f.forEach(i=>{const e=document.getElementById(i);if(e)e.value=''});return;} const d=getPresets(type)[name]; if(d)f.forEach(i=>{const e=document.getElementById(i);if(e)e.value=d[i]||''}); }
      function savePreset(type) { const n=document.getElementById(`${type}-preset-name`).value.trim(); if(!n)return showToast('æ— åç§°'); const p=getPresets(type), d={}; FIELD_MAP[type].forEach(i=>d[i]=document.getElementById(i).value); p[n]=d; localStorage.setItem(STORAGE_KEYS[type],JSON.stringify(p)); refreshDropdown(type); document.getElementById(`${type}-preset-select`).value=n; showToast('å·²ä¿å­˜'); }
      function deletePreset(type) { const n=document.getElementById(`${type}-preset-select`).value; if(n&&confirm('åˆ é™¤?')){const p=getPresets(type);delete p[n];localStorage.setItem(STORAGE_KEYS[type],JSON.stringify(p));loadPreset(type,'');refreshDropdown(type);showToast('å·²åˆ é™¤');} }
      
      function saveGlobalSettings() {
        const val = id => document.getElementById(id).value;
        globalSettings.flowMode = val('flow-mode'); globalSettings.flowRange = parseInt(val('flow-range')); globalSettings.flowWidth = parseInt(val('flow-width')); globalSettings.flowSpeedScroll = parseInt(val('flow-speed-scroll')); globalSettings.flowSpeedBlink = parseInt(val('flow-speed-blink')); globalSettings.iconNormal = val('flow-icon-normal'); globalSettings.iconActive = val('flow-icon-active'); globalSettings.iconSize = parseInt(val('flow-icon-size'));
        localStorage.setItem(STORAGE_KEYS.global, JSON.stringify(globalSettings)); showToast("è®¾ç½®å·²åº”ç”¨"); updateFlowWindowVisibility();
      }
      function insertVarToId(id, val) { const el = document.getElementById(id); if(el) { const start = el.selectionStart; el.value = el.value.substring(0, start) + val + el.value.substring(el.selectionEnd); el.focus(); } }

      function renderRoleUI() { const s = document.getElementById('role-select'); if(!s) return; s.innerHTML=''; roles.forEach(r=>{const o=document.createElement('option');o.value=r.id;o.innerText=r.name;s.appendChild(o)}); s.value=activeRoleId; renderTabs(); }
      function getActiveRole() { return roles.find(r=>r.id==activeRoleId); }
      function getActivePage() { const r=getActiveRole(); return r ? r.pages[activePageIndex] : null; }
      function switchRole(id) { activeRoleId=parseInt(id); activePageIndex=0; renderTabs(); }
      function addNewRole() { const n=prompt("è§’è‰²å:"); if(n){roles.push({id:Date.now(),name:n,pages:[{id:Date.now(),name:"æ—¥ç¨‹",data:[], exportMode:"both"}]});activeRoleId=roles[roles.length-1].id;activePageIndex=0;saveRoles();renderRoleUI();} }
      function renameRole() { const r=getActiveRole(); if(!r) return; const n=prompt("é‡å‘½å:",r.name); if(n){r.name=n;saveRoles();renderRoleUI();} }
      function deleteRole() { if(roles.length<=1)return; if(confirm("åˆ é™¤è§’è‰²?")){roles=roles.filter(r=>r.id!=activeRoleId);activeRoleId=roles[0].id;activePageIndex=0;saveRoles();renderRoleUI();} }
      function saveRoles() { localStorage.setItem(STORAGE_KEYS.roles, JSON.stringify(roles)); }

      function renderTabs() {
        const c=document.getElementById('timer-tabs'); if(!c) return; c.innerHTML=''; const role = getActiveRole(); if(!role) return;
        role.pages.forEach((p,i)=>{const t=document.createElement('div');t.className=`tab-item ${i===activePageIndex?'active':''}`;t.innerText=p.name;t.onclick=()=>{activePageIndex=i;renderTabs()};c.appendChild(t)});
        const b=document.createElement('div');b.className='tab-add-btn';b.innerText='+';b.onclick=addNewPage;c.appendChild(b);
        const cp=getActivePage(); 
        if(cp){ ['api','char','user','prompt','copy'].forEach(type => { const sel = document.getElementById(`bind-${type}`); if(sel) { refreshDropdown(type); sel.value = cp[type+'Preset'] || ""; } }); const ms = document.getElementById('bind-mode'); if(ms) ms.value = cp.exportMode || 'both'; renderTimeline(); }
      }
      function addNewPage() { const n=prompt("é¡µç­¾åç§°:"); if(n){getActiveRole().pages.push({id:Date.now(),name:n,data:[], exportMode:"both"});activePageIndex=getActiveRole().pages.length-1;saveRoles();renderTabs();} }
      function deleteCurrentPage() { if(getActiveRole().pages.length<=1)return; if(confirm("åˆ é™¤é¡µç­¾?")){getActiveRole().pages.splice(activePageIndex,1);activePageIndex=0;saveRoles();renderTabs();} }
      function clearCurrentPage() { if(confirm("æ¸…ç©ºæ•°æ®?")){getActivePage().data=[];saveRoles();renderTimeline();} }
      function updatePageBinding(key, value) { const page = getActivePage(); if(page) { page[key] = value; saveRoles(); showToast("ç»‘å®šå·²æ›´æ–°"); } }

      async function generateSchedule(append) {
        const page = getActivePage(); const apiCfg = getPresets('api')[page.apiPreset]; const promptCfg = getPresets('prompt')[page.promptPreset]; const charCfg = getPresets('char')[page.charPreset]; const userCfg = getPresets('user')[page.userPreset];
        if(!apiCfg || !promptCfg) return showToast("è¯·å…ˆç»‘å®šAPIå’Œæç¤ºè¯é¢„è®¾ï¼");
        const h = apiCfg['api-host'].replace(/\/$/,''); const k = apiCfg['api-key']; const m = apiCfg['model-name']; let pr = promptCfg['prompt-content'];
        const val = (cfg, key) => cfg ? (cfg[key] || "") : "";
        pr = pr.replace(/\${chat.name}/g, val(charCfg, 'char-name')).replace(/\${chat.settings.aiPersona}/g, val(charCfg, 'char-persona')).replace(/\${chat.settings.worldinfo}/g, val(charCfg, 'world-info')).replace(/\${chat.settings.history}/g, val(charCfg, 'chat-history')).replace(/\${user.name}/g, val(userCfg, 'user-name')).replace(/\${user.settings.aiPersona}/g, val(userCfg, 'user-persona'));
        const l=document.getElementById('schedule-loading'), b1=document.getElementById('btn-gen-schedule'), b2=document.getElementById('btn-append-schedule'); l.style.display='block'; b1.disabled=b2.disabled=true;
        try { const r=await fetch(`${h}/v1/chat/completions`,{method:'POST',headers:{'Authorization':`Bearer ${k}`,'Content-Type':'application/json'},body:JSON.stringify({model:m,messages:[{role:"system",content:"JSON Array Only"},{role:"user",content:pr}],temperature:0.7})}); const d=await r.json(), txt=d.choices[0].message.content.replace(/```json|```/g,'').trim(), nd=JSON.parse(txt); page.data = append ? [...page.data,...nd] : nd; page.data.sort((a,b)=>a.time.localeCompare(b.time)); saveRoles(); renderTimeline(); showToast('å®Œæˆ'); } catch(e) { alert("ç”Ÿæˆå¤±è´¥: " + e.message); } finally { l.style.display='none'; b1.disabled=b2.disabled=false; }
      }

      function renderTimeline() {
        const b=document.getElementById('schedule-result-area'); if(!b) return; const d=getActivePage()?.data||[]; b.innerHTML = d.length ? '' : '<div style="text-align:center;color:#aaa;padding:20px">æš‚æ— æ•°æ®</div>';
        d.forEach((item,i)=>{ const c=document.createElement('div'); c.className='timeline-card'; c.id=`card-${i}`; c.innerHTML=`<div class="t-header"><div class="t-time">${item.time}</div><div style="font-size:20px">${item.icon||'ğŸ“±'}</div></div><div class="t-desc">${item.description}</div>${item.html_snippet||''}<div class="card-actions"><button class="card-btn copy" onclick="copySingleItem(${i})">ğŸ“‘ å¤åˆ¶</button><button class="card-btn edit" onclick="editItem(${i})">âœï¸</button><button class="card-btn del" onclick="delItem(${i})">ğŸ—‘ï¸</button></div>`; b.appendChild(c); }); updateRealTimeStatus();
      }
      function editItem(i) { const d=getActivePage().data, v=prompt("ä¿®æ”¹:",d[i].description); if(v){d[i].description=v;saveRoles();renderTimeline();} }
      function delItem(i) { if(confirm("åˆ é™¤?")){getActivePage().data.splice(i,1);saveRoles();renderTimeline();} }
      function copySingleItem(i) {
        const page = getActivePage(); const item = page.data[i]; let charName = "TA";
        if(page.charPreset) { const charCfg = getPresets('char')[page.charPreset]; if(charCfg && charCfg['char-name']) charName = charCfg['char-name']; } else { const role = roles.find(r=>r.id==activeRoleId); if(role) charName = role.name; }
        const txt = `${charName}åœ¨${item.time}${item.description}`; navigator.clipboard.writeText(txt).then(()=>showToast("å·²å¤åˆ¶: " + txt)).catch(()=>showToast("å¤åˆ¶å¤±è´¥"));
      }

      function updateRealTimeStatus() {
        const d = getActivePage()?.data || []; if(!d.length) return; const now = new Date(); const curM = now.getHours()*60 + now.getMinutes(); let aidx = -1; document.querySelectorAll('.timeline-card').forEach(c=>c.classList.remove('active-now')); for(let i=0;i<d.length;i++){const[h,m]=d[i].time.split(':').map(Number);if(curM>=h*60+m)aidx=i;else break;} if(aidx!==-1) document.getElementById(`card-${aidx}`)?.classList.add('active-now');
        const rtPast = document.getElementById('rt-past'); const rtFuture = document.getElementById('rt-future'); if(!rtPast || !rtFuture) return;
        if(aidx!==-1) { const it=d[aidx], [h,m]=it.time.split(':').map(Number); const diff = curM-(h*60+m); rtPast.innerText = `æ­£åœ¨è¿›è¡Œ(${diff}må‰): ${it.description}`; } else { rtPast.innerText = "æ— æ­£åœ¨è¿›è¡Œäº‹ä»¶"; }
        let nidx = aidx===-1 ? 0 : aidx+1; if(nidx < d.length) { const it=d[nidx], [h,m]=it.time.split(':').map(Number); const diff = (h*60+m)-curM; rtFuture.innerText = `å³å°†å¼€å§‹(${diff}må): ${it.description}`; } else { rtFuture.innerText = "æ— åç»­äº‹ä»¶"; }
      }
      
      function exportData() { try { const el = id => document.getElementById(id).value; globalSettings.flowWidth = parseInt(el('flow-width')); localStorage.setItem(STORAGE_KEYS.global, JSON.stringify(globalSettings)); } catch(e){} const d={}; Object.keys(STORAGE_KEYS).forEach(k=>d[k]=localStorage.getItem(STORAGE_KEYS[k])); const b=new Blob([JSON.stringify(d)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); const dateStr = new Date().toISOString().slice(0,10); a.download=`è®¡æ—¶å™¨å¤‡ä»½-${dateStr}.json`; a.click(); }
      function importData(i) { const f=i.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ try{ const d=JSON.parse(e.target.result); Object.keys(d).forEach(k=>localStorage.setItem(k,d[k])); alert("å¯¼å…¥æˆåŠŸï¼"); location.reload(); }catch(x){alert("æ ¼å¼é”™è¯¯")} }; r.readAsText(f); }
    </script>
  </body>
</html>
